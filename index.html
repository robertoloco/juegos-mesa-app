<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juegos de Grupo</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-select {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .game-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid transparent;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .game-card.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .game-card h3 {
            margin-bottom: 8px;
            font-size: 20px;
        }

        .game-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        label {
            display: block;
            margin-top: 20px;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .code-display {
            background: #f8f9fa;
            border: 3px dashed #667eea;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .code-display .code {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 8px;
            font-family: 'Courier New', monospace;
        }

        .code-display p {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #0c5460;
            font-size: 14px;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #856404;
        }

        .hidden {
            display: none !important;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .board-card {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e0e0e0;
            font-weight: bold;
            font-size: 13px;
            word-break: break-word;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                max-width: 100%;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .code-display .code {
                font-size: 36px;
                letter-spacing: 4px;
            }
            
            .game-board {
                gap: 5px;
            }
            
            .board-card {
                padding: 8px;
                min-height: 45px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla Inicial -->
        <div id="homeScreen" class="screen active">
            <h1>üéÆ Juegos de Grupo</h1>
            <p class="subtitle">Selecciona tu modo de juego</p>
            
            <div class="btn" onclick="showCreateGame()">Crear Nueva Sala</div>
            <div class="btn btn-secondary" onclick="showJoinGame()">Unirse a Sala</div>
        </div>

        <!-- Pantalla: Crear Sala -->
        <div id="createGameScreen" class="screen">
            <h1>Crear Nueva Sala</h1>
            <p class="subtitle">Configura tu juego</p>

            <label>Selecciona el Juego:</label>
            <div class="game-select">
                <div class="game-card" onclick="selectGame('blanco')">
                    <h3>üé≠ Blanco</h3>
                    <p>Todos tienen una palabra excepto el Blanco. ¬°Desc√∫brelo sin revelar tu palabra!</p>
                </div>
                <div class="game-card" onclick="selectGame('lobo')">
                    <h3>üê∫ El Lobo</h3>
                    <p>Aldeanos vs Lobos. Los lobos deben eliminar aldeanos sin ser descubiertos.</p>
                </div>
                <div class="game-card" onclick="selectGame('codigo')">
                    <h3>üîê C√≥digo Secreto</h3>
                    <p>Dos equipos compiten dando pistas para encontrar sus agentes. ¬°Cuidado con el asesino!</p>
                </div>
                <div class="game-card" onclick="selectGame('quickstop')">
                    <h3>üèÉ Quick Stop</h3>
                    <p>Completa categor√≠as con palabras que empiecen con la letra indicada. ¬°El m√°s r√°pido gana!</p>
                </div>
                <div class="game-card" onclick="selectGame('loveletter')">
                    <h3>üíå Love Letter</h3>
                    <p>Juego de deducci√≥n y faroleo. S√© el √∫ltimo en pie o termina con la carta m√°s alta.</p>
                </div>
            </div>

            <!-- Configuraci√≥n Blanco -->
            <div id="blancoConfig" class="hidden">
                <label>Palabra Secreta:</label>
                <input type="text" id="secretWord" placeholder="Ej: Pizza">
                
                <div class="info">
                    üí° Esta palabra la ver√°n todos excepto el jugador "Blanco"
                </div>
            </div>

            <!-- Configuraci√≥n Quick Stop -->
            <div id="quickstopConfig" class="hidden">
                <label>N√∫mero de Rondas:</label>
                <input type="number" id="numRounds" value="5" min="1" max="20">
                
                <div class="info">
                    üí° Quick Stop no necesita lista de jugadores. Cada uno juega en su dispositivo.
                </div>
            </div>

            <!-- Configuraci√≥n Love Letter -->
            <div id="loveletterConfig" class="hidden">
                <label>Puntos para Ganar:</label>
                <input type="number" id="pointsToWin" value="4" min="2" max="10">
                
                <div class="info">
                    üí° Cada ronda ganada otorga 1 punto. El primer jugador en alcanzar este n√∫mero gana la partida.
                </div>
            </div>

            <label>Nombres de Jugadores (separados por coma):</label>
            <textarea id="playerNames" placeholder="Juan, Mar√≠a, Pedro, Ana"></textarea>
            
            <div class="info">
                ‚ÑπÔ∏è M√≠nimo 3 jugadores para Blanco/Lobo, 4 para C√≥digo Secreto, 2-4 para Love Letter
            </div>

            <div class="btn" onclick="createGame()">Crear Sala</div>
            <div class="btn btn-secondary" onclick="showHome()">Volver</div>
        </div>

        <!-- Pantalla: Sala Creada -->
        <div id="lobbyScreen" class="screen">
            <h1>‚úÖ Sala Creada</h1>
            
            <div class="code-display">
                <div class="code" id="roomCode">----</div>
                <p>Comparte este c√≥digo con los jugadores</p>
            </div>

            <div class="info">
                üí° Ahora puedes unirte a tu propia sala introduciendo tu nombre y el c√≥digo
            </div>

            <label>Tu Nombre (para unirte):</label>
            <input type="text" id="creatorName" placeholder="Tu nombre">

            <div class="btn" onclick="creatorJoinGame()">Unirme a la Sala</div>
            <div class="btn btn-secondary" onclick="showHome()">Crear Nueva Sala</div>
        </div>

        <!-- Pantalla: Unirse a Sala -->
        <div id="joinGameScreen" class="screen">
            <h1>Unirse a Sala</h1>
            <p class="subtitle">Introduce tus datos</p>

            <label>Tu Nombre:</label>
            <input type="text" id="playerName" placeholder="Tu nombre">

            <label>C√≥digo de Sala:</label>
            <input type="text" id="roomCodeInput" placeholder="Ej: A1B2" maxlength="4" style="text-transform: uppercase;">

            <div class="btn" onclick="joinGame()">Entrar al Juego</div>
            <div class="btn btn-secondary" onclick="showHome()">Volver</div>
        </div>

        <!-- Pantalla: Juego Activo -->
        <div id="gameScreen" class="screen">
            <div id="gameHeader"></div>
            <div id="gameContent"></div>
            <div class="btn btn-secondary" onclick="showHome()">Salir</div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        let selectedGame = null;
        let currentRoom = null;
        let roomRef = null;

        // Navegaci√≥n entre pantallas
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showHome() {
            selectedGame = null;
            currentRoom = null;
            if (roomRef) {
                roomRef.off();
                roomRef = null;
            }
            document.getElementById('playerNames').value = '';
            document.getElementById('secretWord').value = '';
            document.getElementById('playerName').value = '';
            document.getElementById('roomCodeInput').value = '';
            document.getElementById('playerNames').disabled = false;
            showScreen('homeScreen');
        }

        function showCreateGame() {
            showScreen('createGameScreen');
        }

        function showJoinGame() {
            showScreen('joinGameScreen');
        }

        // Selecci√≥n de juego
        function selectGame(game) {
            selectedGame = game;
            document.querySelectorAll('.game-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.game-card').classList.add('selected');

            // Mostrar/ocultar configuraci√≥n espec√≠fica
            document.getElementById('blancoConfig').classList.add('hidden');
            document.getElementById('quickstopConfig').classList.add('hidden');
            document.getElementById('loveletterConfig').classList.add('hidden');
            
            if (game === 'blanco') {
                document.getElementById('blancoConfig').classList.remove('hidden');
            } else if (game === 'quickstop') {
                document.getElementById('quickstopConfig').classList.remove('hidden');
            } else if (game === 'loveletter') {
                document.getElementById('loveletterConfig').classList.remove('hidden');
            }
            
            // Quick Stop no necesita lista de jugadores
            if (game === 'quickstop') {
                document.getElementById('playerNames').value = 'No requerido';
                document.getElementById('playerNames').disabled = true;
            } else {
                document.getElementById('playerNames').disabled = false;
                if (document.getElementById('playerNames').value === 'No requerido') {
                    document.getElementById('playerNames').value = '';
                }
            }
        }

        // Generar c√≥digo de sala √∫nico
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Crear sala
        async function createGame() {
            if (!selectedGame) {
                alert('Por favor selecciona un juego');
                return;
            }

            // Validar jugadores
            let players = [];
            if (selectedGame !== 'quickstop') {
                const playerNamesInput = document.getElementById('playerNames').value.trim();
                if (!playerNamesInput || playerNamesInput === 'No requerido') {
                    alert('Por favor introduce los nombres de los jugadores');
                    return;
                }

                players = playerNamesInput.split(',').map(name => name.trim()).filter(name => name);
                
                if (players.length < 3 && selectedGame !== 'codigo' && selectedGame !== 'loveletter') {
                    alert('Se necesitan m√≠nimo 3 jugadores');
                    return;
                }
                
                if (players.length < 4 && selectedGame === 'codigo') {
                    alert('C√≥digo Secreto necesita m√≠nimo 4 jugadores (2 por equipo)');
                    return;
                }
                
                if ((players.length < 2 || players.length > 4) && selectedGame === 'loveletter') {
                    alert('Love Letter necesita entre 2 y 4 jugadores');
                    return;
                }
            }

            if (selectedGame === 'blanco') {
                const secretWord = document.getElementById('secretWord').value.trim();
                if (!secretWord) {
                    alert('Por favor introduce la palabra secreta');
                    return;
                }
            }

            // Generar c√≥digo de sala
            const roomCode = generateRoomCode();
            
            // Crear sala en Firebase
            const room = {
                code: roomCode,
                game: selectedGame,
                createdAt: Date.now(),
                status: 'waiting'
            };

            // Configurar seg√∫n el juego
            if (selectedGame === 'blanco') {
                room.secretWord = document.getElementById('secretWord').value.trim();
                const blancoIndex = Math.floor(Math.random() * players.length);
                
                room.players = {};
                players.forEach((name, index) => {
                    room.players[name] = {
                        role: index === blancoIndex ? 'blanco' : 'normal',
                        word: index === blancoIndex ? 'BLANCO' : room.secretWord
                    };
                });
            } else if (selectedGame === 'lobo') {
                const numLobos = Math.max(1, Math.floor(players.length / 4));
                const roles = ['lobo'].concat(Array(players.length - numLobos).fill('aldeano'));
                shuffleArray(roles);
                
                room.players = {};
                room.moderator = players[0]; // Primer jugador es moderador
                players.forEach((name, index) => {
                    room.players[name] = {
                        role: index === 0 ? 'moderador' : roles[index - 1], // Moderador no juega
                        alive: index === 0 ? true : true
                    };
                });
                room.phase = 'night';
                room.dayCount = 1;
                room.nightVictim = null;
                room.dayVotes = {};
            }
                room.players = {};
                room.board = generateCodigoSecretoBoard();
                room.currentTeam = 'rojo';
                
                // Dividir jugadores en equipos
                shuffleArray(players);
                const half = Math.floor(players.length / 2);
                players.forEach((name, index) => {
                    room.players[name] = {
                        team: index < half ? 'rojo' : 'azul',
                        role: index === 0 ? 'spymaster' : (index === half ? 'spymaster' : 'operative')
                    };
                });
            } else if (selectedGame === 'quickstop') {
                room.numRounds = parseInt(document.getElementById('numRounds').value) || 5;
                room.currentRound = 1;
                room.currentLetter = null;
                room.categories = ['Nombre', 'Animal', 'Ciudad', 'Objeto', 'Comida', 'Color'];
                room.players = {};
            } else if (selectedGame === 'loveletter') {
                room.pointsToWin = parseInt(document.getElementById('pointsToWin').value) || 4;
                room.currentRound = 1;
                room.deck = [];
                room.discardPile = [];
                room.currentTurnIndex = 0;
                room.roundInProgress = false;
                room.playerOrder = players;
                
                room.players = {};
                players.forEach((name) => {
                    room.players[name] = {
                        hand: [],
                        score: 0,
                        eliminated: false,
                        protected: false
                    };
                });
            }

            // Guardar en Firebase
            try {
                await database.ref('rooms/' + roomCode).set(room);
                currentRoom = room;
                displayLobby(roomCode);
                
                // Auto-eliminar sala despu√©s de 24 horas
                setTimeout(async () => {
                    await database.ref('rooms/' + roomCode).remove();
                }, 24 * 60 * 60 * 1000);
            } catch (error) {
                alert('Error al crear sala: ' + error.message);
            }
        }

        function displayLobby(roomCode) {
            document.getElementById('roomCode').textContent = roomCode;
            document.getElementById('creatorName').value = '';
            showScreen('lobbyScreen');
        }

        // Creador se une a su propia sala
        async function creatorJoinGame() {
            const playerName = document.getElementById('creatorName').value.trim();
            const roomCode = document.getElementById('roomCode').textContent;

            if (!playerName) {
                alert('Por favor introduce tu nombre');
                return;
            }

            // Buscar sala en Firebase
            try {
                const snapshot = await database.ref('rooms/' + roomCode).once('value');
                const room = snapshot.val();
                
                if (!room) {
                    alert('Error: Sala no encontrada');
                    return;
                }

                currentRoom = room;
                currentRoom.code = roomCode;
                roomRef = database.ref('rooms/' + roomCode);

                // Jugar seg√∫n el tipo de juego
                if (room.game === 'quickstop') {
                    playQuickStop(roomCode, playerName);
                } else if (room.game === 'codigo') {
                    playCodigoSecreto(roomCode, playerName, room);
                } else if (room.game === 'loveletter') {
                    playLoveLetter(roomCode, playerName);
                } else if (room.game === 'blanco') {
                    showRole(room, playerName);
                } else if (room.game === 'lobo') {
                    playLobo(roomCode, playerName);
                }
            } catch (error) {
                alert('Error al unirse: ' + error.message);
            }
        }

        // Unirse a sala
        async function joinGame() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();

            if (!playerName) {
                alert('Por favor introduce tu nombre');
                return;
            }

            if (!roomCode || roomCode.length !== 4) {
                alert('Por favor introduce un c√≥digo de sala v√°lido');
                return;
            }

            // Buscar sala en Firebase
            try {
                const snapshot = await database.ref('rooms/' + roomCode).once('value');
                const room = snapshot.val();
                
                if (!room) {
                    alert('Sala no encontrada. Verifica el c√≥digo.');
                    return;
                }

                currentRoom = room;
                currentRoom.code = roomCode;
                roomRef = database.ref('rooms/' + roomCode);

                // Jugar seg√∫n el tipo de juego
                if (room.game === 'quickstop') {
                    playQuickStop(roomCode, playerName);
                } else if (room.game === 'codigo') {
                    playCodigoSecreto(roomCode, playerName, room);
                } else if (room.game === 'loveletter') {
                    playLoveLetter(roomCode, playerName);
                } else if (room.game === 'blanco') {
                    showRole(room, playerName);
                } else if (room.game === 'lobo') {
                    playLobo(roomCode, playerName);
                }
            } catch (error) {
                alert('Error al unirse: ' + error.message);
            }
        }

        function showRole(room, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');
            
            if (!room.players[playerName]) {
                alert('Tu nombre no est√° en la lista de jugadores de esta sala');
                return;
            }
            
            gameHeader.innerHTML = renderGameHeader(room.code, room.game);
            const player = room.players[playerName];

            if (room.game === 'blanco') {
                if (player.role === 'blanco') {
                    gameContent.innerHTML = `
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 40px; border-radius: 15px; text-align: center;">
                            <h2 style="font-size: 32px; margin-bottom: 15px;">¬°Eres el BLANCO!</h2>
                            <div style="font-size: 40px; font-weight: bold; margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 10px;">‚ùì BLANCO</div>
                            <p>No tienes palabra. Debes adivinar cu√°l es la palabra secreta sin que te descubran.</p>
                            <p>üí° Disimula y trata de integrarte en la conversaci√≥n</p>
                        </div>
                    `;
                } else {
                    gameContent.innerHTML = `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; text-align: center;">
                            <h2 style="font-size: 32px; margin-bottom: 15px;">Tu Palabra es:</h2>
                            <div style="font-size: 40px; font-weight: bold; margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 10px;">${player.word}</div>
                            <p>Hay un jugador que es el BLANCO y no tiene esta palabra.</p>
                            <p>üí° Habla sobre la palabra sin decirla directamente</p>
                        </div>
                    `;
                }
            }

            showScreen('gameScreen');
        }

        // C√≥digo Secreto - Generar tablero
        function generateCodigoSecretoBoard() {
            const words = [
                'Casa', 'Perro', 'Playa', 'Libro', 'Caf√©', 'Luna', 'Piano', 'Reloj', 'Jard√≠n', 'Puente',
                'Monta√±a', 'Estrella', 'Fuego', 'Nube', 'Robot', '√Årbol', 'Mar', 'Luz', 'Sombra', 'Viento',
                'R√≠o', 'Flores', 'Nieve', 'Torre', 'Drag√≥n'
            ];
            
            shuffleArray(words);
            const board = [];
            const roles = ['rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo',
                          'azul', 'azul', 'azul', 'azul', 'azul', 'azul', 'azul', 'azul',
                          'inocente', 'inocente', 'inocente', 'inocente', 'inocente', 'inocente', 'inocente',
                          'asesino'];
            shuffleArray(roles);
            
            for (let i = 0; i < 25; i++) {
                board.push({
                    word: words[i],
                    role: roles[i],
                    revealed: false
                });
            }
            
            return board;
        }

        function playCodigoSecreto(roomCode, playerName, room) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'codigo');

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const player = room.players[playerName];
                if (!player) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s registrado en esta partida</p>';
                    return;
                }

                // Contar agentes por equipo
                let rojoTotal = 0, rojoRevealed = 0;
                let azulTotal = 0, azulRevealed = 0;
                let asesinRevealed = false;
                let gameOver = false;
                let winner = null;

                room.board.forEach(card => {
                    if (card.role === 'rojo') {
                        rojoTotal++;
                        if (card.revealed) rojoRevealed++;
                    } else if (card.role === 'azul') {
                        azulTotal++;
                        if (card.revealed) azulRevealed++;
                    } else if (card.role === 'asesino' && card.revealed) {
                        asesinRevealed = true;
                        // El equipo que revel√≥ el asesino pierde
                        winner = room.currentTeam === 'rojo' ? 'AZUL' : 'ROJO';
                        gameOver = true;
                    }
                });

                // Detectar victoria por completar agentes
                if (rojoRevealed === rojoTotal && !gameOver) {
                    winner = 'ROJO';
                    gameOver = true;
                }
                if (azulRevealed === azulTotal && !gameOver) {
                    winner = 'AZUL';
                    gameOver = true;
                }

                if (gameOver) {
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: ${winner === 'ROJO' ? '#ff6b6b' : '#4dabf7'}; color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">¬°Equipo ${winner} GANA!</h1>
                            ${asesinRevealed ? '<p style="margin-top: 20px;">El otro equipo revel√≥ al ASESINO üí•</p>' : '<p style="margin-top: 20px;">¬°Encontraron todos sus agentes!</p>'}
                        </div>
                    `;
                    return;
                }

                let html = `
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">üîê C√≥digo Secreto</h2>
                    <div style="background: ${player.team === 'rojo' ? '#ff6b6b' : '#4dabf7'}; color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                        <strong>Equipo: ${player.team.toUpperCase()}</strong><br>
                        Rol: ${player.role === 'spymaster' ? 'SPYMASTER' : 'OPERATIVE'}
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                        <div style="background: #ff6b6b; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold;">
                            üî¥ Rojo: ${rojoRevealed}/${rojoTotal}
                        </div>
                        <div style="background: #4dabf7; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold;">
                            üîµ Azul: ${azulRevealed}/${azulTotal}
                        </div>
                    </div>
                    <div class="game-board">
                `;

                room.board.forEach((card, index) => {
                    const showRole = player.role === 'spymaster';
                    const bgColor = card.revealed ? 
                        (card.role === 'rojo' ? '#ff6b6b' : 
                         card.role === 'azul' ? '#4dabf7' : 
                         card.role === 'asesino' ? '#000' : '#adb5bd') :
                        (showRole ? 
                            (card.role === 'rojo' ? '#ff6b6b80' : 
                             card.role === 'azul' ? '#4dabf780' : 
                             card.role === 'asesino' ? '#00000080' : '#adb5bd80') : 
                            '#fff');
                    
                    const isClickable = player.role === 'spymaster' && !card.revealed;
                    const cursor = isClickable ? 'pointer' : 'default';
                    const onclick = isClickable ? `onclick="revealCodigoCard('${roomCode}', ${index})"` : '';
                    
                    html += `
                        <div class="board-card" style="background: ${bgColor}; color: ${bgColor.includes('#000') ? 'white' : '#333'}; cursor: ${cursor};" ${onclick}>
                            ${card.word}
                        </div>
                    `;
                });

                html += `</div>
                    <div class="info">
                        ${player.role === 'spymaster' ? 
                            'üí° Da pistas de UNA palabra + n√∫mero. <strong>Clickea las palabras</strong> que elijan tus operatives para revelarlas.' : 
                            'üí° Escucha a tu spymaster y adivina las palabras de tu equipo. El spymaster revelar√° las palabras.'}
                    </div>
                `;

                gameContent.innerHTML = html;
            });

            showScreen('gameScreen');
        }

        async function revealCodigoCard(roomCode, cardIndex) {
            await database.ref(`rooms/${roomCode}/board/${cardIndex}/revealed`).set(true);
        }

        // ============================================
        // EL LOBO - Sistema completo con moderador
        // ============================================

        function playLobo(roomCode, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'lobo');

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const player = room.players[playerName];
                if (!player) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s registrado en esta partida</p>';
                    return;
                }

                const isModerator = player.role === 'moderador';
                const alivePlayers = Object.keys(room.players).filter(p => room.players[p].alive && room.players[p].role !== 'moderador');
                const lobos = Object.keys(room.players).filter(p => room.players[p].role === 'lobo' && room.players[p].alive);
                const aldeanos = Object.keys(room.players).filter(p => room.players[p].role === 'aldeano' && room.players[p].alive);

                // Detectar fin de juego
                if (lobos.length === 0) {
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">¬°ALDEANOS GANAN!</h1>
                            <p style="margin-top: 20px;">Todos los lobos han sido eliminados</p>
                        </div>
                    `;
                    return;
                }
                if (lobos.length >= aldeanos.length) {
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #333; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">¬°LOBOS GANAN!</h1>
                            <p style="margin-top: 20px;">Los lobos han igualado o superado a los aldeanos</p>
                        </div>
                    `;
                    return;
                }

                if (isModerator) {
                    // Vista del moderador
                    let html = `
                        <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">üê∫ El Lobo</h2>
                        <div style="background: #ffc107; color: #333; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                            <strong>üé≠ MODERADOR</strong><br>
                            Fase: ${room.phase === 'night' ? 'üåô NOCHE' : '‚òÄÔ∏è D√çA ' + room.dayCount}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <h3>Jugadores vivos (${alivePlayers.length}):</h3>
                    `;

                    Object.keys(room.players).forEach(p => {
                        const player = room.players[p];
                        if (player.role === 'moderador') return;
                        
                        const roleIcon = player.role === 'lobo' ? 'üê∫' : 'üë•';
                        const status = player.alive ? '‚úÖ' : '‚ùå';
                        
                        html += `
                            <div style="background: ${player.alive ? '#e7f3ff' : '#f8f9fa'}; padding: 12px; border-radius: 8px; margin: 5px 0; border-left: 4px solid ${player.role === 'lobo' ? '#dc3545' : '#667eea'}; opacity: ${player.alive ? 1 : 0.5};">
                                ${status} <strong>${p}</strong> - ${roleIcon} ${player.role.toUpperCase()}
                            </div>
                        `;
                    });

                    html += '</div>';

                    if (room.phase === 'night') {
                        html += `
                            <div class="info">
                                üåô Los lobos eligen a qui√©n eliminar. Confirma la v√≠ctima:
                            </div>
                            <select id="nightVictimSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 2px solid #667eea;">
                                <option value="">Seleccionar v√≠ctima...</option>
                                ${aldeanos.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div class="btn" onclick="confirmNightKill('${roomCode}')">‚úÖ Confirmar Muerte Nocturna</div>
                        `;
                    } else {
                        html += `
                            <div class="info">
                                ‚òÄÔ∏è Los jugadores votan a qui√©n eliminar. Confirma los votos:
                            </div>
                        `;

                        if (Object.keys(room.dayVotes || {}).length > 0) {
                            html += '<h3>Votos actuales:</h3><div style="margin: 10px 0;">';
                            Object.entries(room.dayVotes).forEach(([voter, target]) => {
                                html += `<div style="padding: 8px; background: #f8f9fa; border-radius: 5px; margin: 5px 0;"><strong>${voter}</strong> ‚Üí ${target}</div>`;
                            });
                            html += '</div>';
                        }

                        html += `
                            <select id="dayVictimSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 2px solid #667eea;">
                                <option value="">Seleccionar eliminado...</option>
                                ${alivePlayers.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div class="btn" onclick="confirmDayElimination('${roomCode}')">‚úÖ Confirmar Eliminaci√≥n del D√≠a</div>
                        `;
                    }

                    gameContent.innerHTML = html;
                } else {
                    // Vista de jugador normal
                    const lobosNames = Object.keys(room.players).filter(p => room.players[p].role === 'lobo').join(', ');
                    const isWolf = player.role === 'lobo';

                    let html = `
                        <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">üê∫ El Lobo</h2>
                        <div style="background: ${isWolf ? 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; color: ${isWolf ? '#333' : 'white'}; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 15px;">
                            <h2 style="font-size: 28px; margin-bottom: 10px;">${isWolf ? 'üê∫ Eres un LOBO' : 'üë• Eres un ALDEANO'}</h2>
                            ${isWolf ? `<p><strong>Otros lobos:</strong> ${lobosNames}</p>` : '<p>Debes encontrar y eliminar a los lobos</p>'}
                            ${player.alive ? '' : '<p style="margin-top: 15px; font-weight: bold;">‚ùå EST√ÅS ELIMINADO</p>'}
                        </div>
                        <div style="background: ${room.phase === 'night' ? '#2c3e50' : '#fffbea'}; color: ${room.phase === 'night' ? 'white' : '#333'}; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                            <strong>Fase actual:</strong> ${room.phase === 'night' ? 'üåô NOCHE' : '‚òÄÔ∏è D√çA ' + room.dayCount}
                        </div>
                        <h3>Jugadores vivos:</h3>
                        <div style="margin-bottom: 15px;">
                    `;

                    alivePlayers.forEach(p => {
                        html += `<div style="background: #e7f3ff; padding: 10px; border-radius: 8px; margin: 5px 0;">‚úÖ ${p}</div>`;
                    });

                    html += '</div>';

                    if (player.alive && room.phase === 'day') {
                        html += `
                            <h3>Vota para eliminar:</h3>
                            <select id="voteSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 2px solid #667eea;">
                                <option value="">Seleccionar...</option>
                                ${alivePlayers.filter(p => p !== playerName).map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div class="btn" onclick="submitDayVote('${roomCode}', '${playerName}')">üó≥Ô∏è Enviar Voto</div>
                        `;
                    }

                    if (room.phase === 'night') {
                        html += `<div class="info">üåô El moderador gestiona la fase de noche. Los lobos discuten en privado.</div>`;
                    } else {
                        html += `<div class="info">‚òÄÔ∏è Discutan y voten a qui√©n creen que es un lobo.</div>`;
                    }

                    gameContent.innerHTML = html;
                }
            });

            showScreen('gameScreen');
        }

        async function confirmNightKill(roomCode) {
            const victim = document.getElementById('nightVictimSelect').value;
            if (!victim) {
                alert('Selecciona una v√≠ctima');
                return;
            }

            await database.ref(`rooms/${roomCode}`).update({
                [`players/${victim}/alive`]: false,
                phase: 'day',
                nightVictim: victim,
                dayVotes: {}
            });
        }

        async function confirmDayElimination(roomCode) {
            const victim = document.getElementById('dayVictimSelect').value;
            if (!victim) {
                alert('Selecciona un eliminado');
                return;
            }

            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();

            await database.ref(`rooms/${roomCode}`).update({
                [`players/${victim}/alive`]: false,
                phase: 'night',
                dayCount: room.dayCount + 1,
                dayVotes: {}
            });
        }

        async function submitDayVote(roomCode, playerName) {
            const vote = document.getElementById('voteSelect').value;
            if (!vote) {
                alert('Selecciona un jugador');
                return;
            }

            await database.ref(`rooms/${roomCode}/dayVotes/${playerName}`).set(vote);
            alert('Voto enviado al moderador');
        }

        // Quick Stop
        function playQuickStop(roomCode, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');
            
            gameHeader.innerHTML = renderGameHeader(roomCode, 'quickstop');
            
            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                if (!room.players[playerName]) {
                    database.ref(`rooms/${roomCode}/players/${playerName}`).set({
                        score: 0,
                        answers: {}
                    });
                }

                if (!room.currentLetter) {
                    // Esperando inicio de ronda
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÉ Quick Stop</h2>
                        <div style="text-align: center; padding: 40px;">
                            <h3>Ronda ${room.currentRound} de ${room.numRounds}</h3>
                            <p style="margin: 20px 0;">Esperando que comience la ronda...</p>
                            ${Object.keys(room.players)[0] === playerName ? 
                                '<div class="btn" onclick="startQuickStopRound()">Iniciar Ronda</div>' : 
                                '<p style="color: #666;">El primer jugador iniciar√° la ronda</p>'}
                        </div>
                    `;
                } else {
                    // Jugando
                    let html = `
                        <h2 style="text-align: center; color: #667eea;">üèÉ Quick Stop - Ronda ${room.currentRound}</h2>
                        <div style="background: #667eea; color: white; padding: 30px; border-radius: 15px; text-align: center; margin: 20px 0;">
                            <h1 style="font-size: 72px; margin: 0;">Letra: ${room.currentLetter}</h1>
                        </div>
                        <form onsubmit="submitQuickStopAnswers(event)">
                    `;

                    room.categories.forEach((cat, index) => {
                        html += `
                            <label>${cat}:</label>
                            <input type="text" id="cat_${index}" placeholder="Palabra con ${room.currentLetter}..." required>
                        `;
                    });

                    html += `
                            <div class="btn" onclick="submitQuickStopAnswers(event)">¬°STOP!</div>
                        </form>
                    `;

                    gameContent.innerHTML = html;
                }
            });

            showScreen('gameScreen');
        }

        function startQuickStopRound() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const randomLetter = letters.charAt(Math.floor(Math.random() * letters.length));
            
            database.ref(`rooms/${currentRoom.code}/currentLetter`).set(randomLetter);
        }

        async function submitQuickStopAnswers(event) {
            event.preventDefault();
            
            const playerName = document.getElementById('playerName').value.trim();
            const answers = {};
            
            currentRoom.categories.forEach((cat, index) => {
                answers[cat] = document.getElementById(`cat_${index}`).value.trim();
            });

            await database.ref(`rooms/${currentRoom.code}/players/${playerName}/answers/round${currentRoom.currentRound}`).set(answers);
            
            alert('¬°Respuestas enviadas! Espera a que todos terminen para ver los resultados.');
        }

        // Utilidades
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderGameHeader(roomCode, gameName) {
            return `
                <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Sala:</div>
                        <div style="font-size: 24px; font-weight: bold; letter-spacing: 3px;">${roomCode}</div>
                    </div>
                    <button onclick="showGameHelp('${gameName}')" style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        ‚ùì Ayuda
                    </button>
                </div>
            `;
        }

        function showGameHelp(gameName) {
            const rules = {
                blanco: `
                    <h3>üé≠ Blanco - Reglas</h3>
                    <p><strong>Objetivo:</strong></p>
                    <ul>
                        <li><strong>Blanco:</strong> Adivinar la palabra secreta sin ser descubierto</li>
                        <li><strong>Otros:</strong> Descubrir qui√©n es el Blanco sin revelar la palabra</li>
                    </ul>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Todos reciben la misma palabra excepto el Blanco</li>
                        <li>Por turnos, cada jugador da una pista sobre su palabra</li>
                        <li>El Blanco debe disimular y dar pistas gen√©ricas</li>
                        <li>Al final, voten qui√©n creen que es el Blanco</li>
                    </ol>
                `,
                lobo: `
                    <h3>üê∫ El Lobo - Reglas</h3>
                    <p><strong>Objetivo:</strong></p>
                    <ul>
                        <li><strong>Lobos:</strong> Eliminar a todos los aldeanos</li>
                        <li><strong>Aldeanos:</strong> Eliminar a todos los lobos</li>
                    </ul>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Los lobos se conocen entre s√≠</li>
                        <li>De d√≠a: todos votan para eliminar a alguien</li>
                        <li>De noche: los lobos eligen eliminar a un aldeano</li>
                        <li>Usen la conversaci√≥n para deducir qui√©n es qui√©n</li>
                    </ol>
                `,
                codigo: `
                    <h3>üîê C√≥digo Secreto - Reglas</h3>
                    <p><strong>Objetivo:</strong> Encuentra todos los agentes de tu equipo antes que el equipo rival</p>
                    <p><strong>Roles:</strong></p>
                    <ul>
                        <li><strong>Spymaster:</strong> Ve todo el tablero. Da pistas de UNA palabra + n√∫mero</li>
                        <li><strong>Operatives:</strong> Adivinan palabras basadas en las pistas</li>
                    </ul>
                    <p><strong>Colores:</strong></p>
                    <ul>
                        <li><strong>Rojo/Azul:</strong> Agentes de cada equipo</li>
                        <li><strong>Gris:</strong> Transe√∫ntes inocentes (pierdes el turno)</li>
                        <li><strong>Negro:</strong> Asesino (üí• pierdes instant√°neamente)</li>
                    </ul>
                    <p><strong>Spymaster clickea las palabras</strong> que elijan los operatives para revelarlas.</p>
                `,
                quickstop: `
                    <h3>üèÉ Quick Stop - Reglas</h3>
                    <p><strong>Objetivo:</strong> Ser el primero en completar todas las categor√≠as</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Se elige una letra aleatoria</li>
                        <li>Completa cada categor√≠a con palabras que empiecen con esa letra</li>
                        <li>El primero en terminar grita "¬°STOP!"</li>
                        <li>Comparan respuestas: √∫nica = 10pts, repetida = 5pts, vac√≠a = 0pts</li>
                    </ol>
                    <p><strong>Categor√≠as:</strong> Nombre, Animal, Ciudad, Objeto, Comida, Color</p>
                `,
                loveletter: `
                    <h3>üíå Love Letter - Reglas</h3>
                    <p><strong>Objetivo:</strong> S√© el √∫ltimo en pie o termina con la carta m√°s alta</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Cada turno: roba 1 carta y juega 1 carta</li>
                        <li>Cada carta tiene un efecto especial</li>
                        <li>Gana la ronda el √∫ltimo jugador o quien tenga la carta m√°s alta</li>
                        <li>Primer jugador en alcanzar los puntos objetivo gana</li>
                    </ol>
                    <p><strong>Cartas:</strong></p>
                    <ul style="font-size: 13px;">
                        <li><strong>1-Guardia:</strong> Adivina la carta de un jugador</li>
                        <li><strong>2-Sacerdote:</strong> Mira la carta de un jugador</li>
                        <li><strong>3-Bar√≥n:</strong> Compara cartas, el menor se elimina</li>
                        <li><strong>4-Doncella:</strong> Protecci√≥n hasta tu pr√≥ximo turno</li>
                        <li><strong>5-Pr√≠ncipe:</strong> Un jugador descarta y roba</li>
                        <li><strong>6-Rey:</strong> Intercambia cartas con otro jugador</li>
                        <li><strong>7-Condesa:</strong> Debes jugarla si tienes Rey o Pr√≠ncipe</li>
                        <li><strong>8-Princesa:</strong> Si la descartas, quedas eliminado</li>
                    </ul>
                `
            };

            const rule = rules[gameName] || '<p>Reglas no disponibles</p>';
            const helpContent = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; margin: 20px auto;">
                    ${rule}
                    <button onclick="document.getElementById('helpOverlay').style.display='none'" 
                            style="width: 100%; padding: 15px; margin-top: 20px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">
                        Cerrar
                    </button>
                </div>
            `;

            let overlay = document.getElementById('helpOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'helpOverlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
                document.body.appendChild(overlay);
            }
            overlay.innerHTML = helpContent;
            overlay.style.display = 'flex';
        }

        // ============================================
        // LOVE LETTER - L√≥gica completa del juego
        // ============================================

        const LOVE_LETTER_CARDS = {
            1: { name: 'Guardia', count: 5, effect: 'Elige un jugador y nombra una carta (excepto Guardia). Si tiene esa carta, queda eliminado.' },
            2: { name: 'Sacerdote', count: 2, effect: 'Mira la mano de otro jugador.' },
            3: { name: 'Bar√≥n', count: 2, effect: 'Compara tu mano con otro jugador. El que tenga el n√∫mero m√°s bajo queda eliminado.' },
            4: { name: 'Doncella', count: 2, effect: 'Est√°s protegido hasta tu pr√≥ximo turno.' },
            5: { name: 'Pr√≠ncipe', count: 2, effect: 'Elige un jugador (puedes elegirte a ti). Ese jugador descarta su mano y roba una nueva carta.' },
            6: { name: 'Rey', count: 1, effect: 'Intercambia tu mano con otro jugador.' },
            7: { name: 'Condesa', count: 1, effect: 'Si tienes Rey o Pr√≠ncipe en tu mano, DEBES jugar esta carta.' },
            8: { name: 'Princesa', count: 1, effect: 'Si descartas esta carta, quedas eliminado.' }
        };

        function createLoveLetterDeck() {
            const deck = [];
            for (let value = 1; value <= 8; value++) {
                const card = LOVE_LETTER_CARDS[value];
                for (let i = 0; i < card.count; i++) {
                    deck.push({ value, name: card.name, effect: card.effect });
                }
            }
            shuffleArray(deck);
            return deck;
        }

        async function startLoveLetterRound(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            
            const deck = createLoveLetterDeck();
            const removedCard = deck.pop();
            
            const updates = {
                deck: deck,
                discardPile: [],
                removedCard: removedCard,
                currentTurnIndex: 0,
                roundInProgress: true,
                waitingForAction: null
            };
            
            room.playerOrder.forEach((playerName) => {
                const card = deck.pop();
                updates[`players/${playerName}/hand`] = [card];
                updates[`players/${playerName}/eliminated`] = false;
                updates[`players/${playerName}/protected`] = false;
            });
            
            updates.deck = deck;
            await database.ref(`rooms/${roomCode}`).update(updates);
        }

        function playLoveLetter(roomCode, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');
            
            gameHeader.innerHTML = renderGameHeader(roomCode, 'loveletter');
            
            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;
                
                const player = room.players[playerName];
                if (!player) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s en esta partida.</p>';
                    return;
                }
                
                const currentPlayer = room.playerOrder[room.currentTurnIndex];
                const isMyTurn = currentPlayer === playerName;
                
                const winner = Object.keys(room.players).find(p => room.players[p].score >= room.pointsToWin);
                if (winner) {
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üíå Love Letter - Fin de la Partida</h2>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 20px 0;">
                            <h1 style="font-size: 48px; margin: 0;">üèÜ ${winner} GANA!</h1>
                            <p style="margin-top: 20px; font-size: 18px;">${room.players[winner].score} puntos</p>
                        </div>
                    `;
                    return;
                }
                
                if (!room.roundInProgress) {
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üíå Love Letter - Ronda ${room.currentRound}</h2>
                        <div style="text-align: center; margin: 30px 0;">
                            <p>Puntos para ganar: ${room.pointsToWin}</p>
                            ${room.playerOrder[0] === playerName ? 
                                '<div class="btn" onclick="startLoveLetterRound(\'' + roomCode + '\')">Iniciar Ronda</div>' :
                                '<p style="color: #666;">Esperando que el primer jugador inicie la ronda...</p>'}
                        </div>
                    `;
                    return;
                }
                
                const activePlayers = room.playerOrder.filter(p => !room.players[p].eliminated);
                if (activePlayers.length === 1) {
                    const roundWinner = activePlayers[0];
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üíå Fin de Ronda ${room.currentRound}</h2>
                        <div style="background: #fffbea; border: 3px solid #ffd700; padding: 30px; border-radius: 15px; text-align: center; margin: 20px 0;">
                            <h1 style="font-size: 36px; color: #667eea;">${roundWinner} gana la ronda!</h1>
                            <p>Era el √∫ltimo jugador en pie</p>
                        </div>
                        ${playerName === room.playerOrder[0] ? 
                            '<div class="btn" onclick="endLoveLetterRound(\'' + roomCode + '\', \'' + roundWinner + '\')">Continuar a Siguiente Ronda</div>' :
                            '<p style="text-align: center; color: #666;">Esperando que el primer jugador contin√∫e...</p>'}
                    `;
                    return;
                }
                
                if (room.deck.length === 0) {
                    let highestValue = 0;
                    let roundWinner = null;
                    
                    activePlayers.forEach(p => {
                        const cardValue = room.players[p].hand[0].value;
                        if (cardValue > highestValue) {
                            highestValue = cardValue;
                            roundWinner = p;
                        }
                    });
                    
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üíå Fin de Ronda ${room.currentRound}</h2>
                        <div style="background: #fffbea; border: 3px solid #ffd700; padding: 30px; border-radius: 15px; text-align: center; margin: 20px 0;">
                            <h1 style="font-size: 36px; color: #667eea;">${roundWinner} gana la ronda!</h1>
                            <p>Ten√≠a la carta m√°s alta: ${LOVE_LETTER_CARDS[highestValue].name} (${highestValue})</p>
                        </div>
                        ${playerName === room.playerOrder[0] ? 
                            '<div class="btn" onclick="endLoveLetterRound(\'' + roomCode + '\', \'' + roundWinner + '\')">Continuar a Siguiente Ronda</div>' :
                            '<p style="text-align: center; color: #666;">Esperando que el primer jugador contin√∫e...</p>'}
                    `;
                    return;
                }
                
                let html = `
                    <h2 style="text-align: center; color: #667eea;">üíå Love Letter - Ronda ${room.currentRound}</h2>
                    <div style="background: ${isMyTurn ? '#e7f3ff' : '#f8f9fa'}; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                        <strong>Turno de: ${currentPlayer}</strong> ${isMyTurn ? '(T√ö)' : ''}
                        <br><small>Cartas en el mazo: ${room.deck.length}</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                `;
                
                room.playerOrder.forEach(p => {
                    const pPlayer = room.players[p];
                    let style = 'background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 5px 0; border-left: 4px solid #667eea;';
                    if (pPlayer.eliminated) style = 'background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 5px 0; border-left: 4px solid #dc3545; opacity: 0.5; text-decoration: line-through;';
                    else if (p === currentPlayer) style = 'background: #e7f3ff; padding: 12px; border-radius: 8px; margin: 5px 0; border-left: 4px solid #ffd700;';
                    
                    html += `
                        <div style="${style}">
                            <strong>${p}</strong> ${p === playerName ? '(T√ö)' : ''}
                            ${pPlayer.eliminated ? ' - ELIMINADO' : ''}
                            ${pPlayer.protected && !pPlayer.eliminated ? ' üõ°Ô∏è Protegido' : ''}
                            <br><small>Puntos: ${pPlayer.score}</small>
                        </div>
                    `;
                });
                html += '</div>';
                
                if (room.discardPile && room.discardPile.length > 0) {
                    html += '<div style="margin: 15px 0;"><strong>Descartes:</strong><div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px;">';
                    room.discardPile.slice(-5).forEach(c => {
                        html += `<span style="background: #e0e0e0; padding: 5px 10px; border-radius: 5px; font-size: 12px;">${c.name} (${c.value})</span>`;
                    });
                    html += '</div></div>';
                }
                
                if (!player.eliminated && player.hand && player.hand.length > 0) {
                    html += '<h3 style="margin-top: 20px;">Tu mano:</h3>';
                    player.hand.forEach((card) => {
                        html += `
                            <div style="background: white; border: 3px solid #667eea; border-radius: 12px; padding: 20px; margin: 10px 0;">
                                <div style="font-size: 32px; font-weight: bold; color: #667eea;">${card.value}</div>
                                <div style="font-size: 18px; font-weight: bold; margin: 8px 0; color: #333;">${card.name}</div>
                                <div style="font-size: 13px; color: #666;">${card.effect}</div>
                            </div>
                        `;
                    });
                    
                    if (isMyTurn && !room.waitingForAction) {
                        html += '<div class="btn" onclick="drawLoveLetterCard(\'' + roomCode + '\', \'' + playerName + '\')">Robar Carta</div>';
                    } else if (isMyTurn && room.waitingForAction === 'chooseCard') {
                        html += '<h3 style="margin-top: 20px;">Elige una carta para jugar:</h3>';
                        player.hand.forEach((card, index) => {
                            html += `<div class="btn" onclick="playLoveLetterCard(\'' + roomCode + '\', \'' + playerName + '\', ${index})">Jugar ${card.name} (${card.value})</div>`;
                        });
                    }
                }
                
                gameContent.innerHTML = html;
            });
            
            showScreen('gameScreen');
        }

        async function drawLoveLetterCard(roomCode, playerName) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            
            if (!room.deck || room.deck.length === 0) {
                alert('No quedan cartas en el mazo');
                return;
            }
            
            const card = room.deck[room.deck.length - 1];
            const newDeck = room.deck.slice(0, -1);
            const playerHand = room.players[playerName].hand;
            playerHand.push(card);
            
            await database.ref(`rooms/${roomCode}`).update({
                deck: newDeck,
                [`players/${playerName}/hand`]: playerHand,
                waitingForAction: 'chooseCard'
            });
        }

        async function playLoveLetterCard(roomCode, playerName, cardIndex) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            
            const player = room.players[playerName];
            const card = player.hand[cardIndex];
            
            if (player.hand.some(c => c.value === 7)) {
                const otherCard = player.hand.find(c => c.value !== 7);
                if (otherCard && (otherCard.value === 5 || otherCard.value === 6)) {
                    if (card.value !== 7) {
                        alert('Debes jugar la Condesa si tienes Rey o Pr√≠ncipe');
                        return;
                    }
                }
            }
            
            const newHand = player.hand.filter((_, i) => i !== cardIndex);
            const newDiscardPile = [...room.discardPile, card];
            
            const updates = {
                [`players/${playerName}/hand`]: newHand,
                discardPile: newDiscardPile,
                waitingForAction: null
            };
            
            room.playerOrder.forEach(p => {
                updates[`players/${p}/protected`] = false;
            });
            
            await applyLoveLetterCardEffect(roomCode, playerName, card, room, updates);
        }

        async function applyLoveLetterCardEffect(roomCode, playerName, card, room, updates) {
            switch (card.value) {
                case 1:
                    const targetName = prompt('Elige un jugador (nombre exacto):');
                    if (targetName && room.players[targetName] && !room.players[targetName].eliminated && !room.players[targetName].protected) {
                        const guessValue = parseInt(prompt('Adivina el n√∫mero de su carta (2-8):'));
                        if (guessValue >= 2 && guessValue <= 8) {
                            const targetCard = room.players[targetName].hand[0];
                            if (targetCard && targetCard.value === guessValue) {
                                updates[`players/${targetName}/eliminated`] = true;
                                updates.discardPile = [...updates.discardPile, targetCard];
                                updates[`players/${targetName}/hand`] = [];
                                alert(`¬°Correcto! ${targetName} ten√≠a ${targetCard.name} y queda eliminado`);
                            } else {
                                alert(`Incorrecto. ${targetName} no tiene esa carta.`);
                            }
                        }
                    }
                    break;
                    
                case 2:
                    const priestTarget = prompt('Elige un jugador para ver su carta:');
                    if (priestTarget && room.players[priestTarget] && !room.players[priestTarget].eliminated && !room.players[priestTarget].protected) {
                        const targetCard = room.players[priestTarget].hand[0];
                        if (targetCard) {
                            alert(`${priestTarget} tiene: ${targetCard.name} (${targetCard.value})`);
                        }
                    }
                    break;
                    
                case 3:
                    const baronTarget = prompt('Elige un jugador para comparar manos:');
                    if (baronTarget && room.players[baronTarget] && !room.players[baronTarget].eliminated && !room.players[baronTarget].protected && baronTarget !== playerName) {
                        const myCard = room.players[playerName].hand[0];
                        const theirCard = room.players[baronTarget].hand[0];
                        
                        if (myCard && theirCard) {
                            if (myCard.value > theirCard.value) {
                                updates[`players/${baronTarget}/eliminated`] = true;
                                updates.discardPile = [...updates.discardPile, theirCard];
                                updates[`players/${baronTarget}/hand`] = [];
                                alert(`¬°Ganaste! ${baronTarget} queda eliminado.`);
                            } else if (myCard.value < theirCard.value) {
                                updates[`players/${playerName}/eliminated`] = true;
                                updates.discardPile = [...updates.discardPile, myCard];
                                updates[`players/${playerName}/hand`] = [];
                                alert(`Perdiste. Quedas eliminado.`);
                            } else {
                                alert(`Empate.`);
                            }
                        }
                    }
                    break;
                    
                case 4:
                    updates[`players/${playerName}/protected`] = true;
                    break;
                    
                case 5:
                    const princeTarget = prompt('Elige un jugador que descarte y robe:');
                    if (princeTarget && room.players[princeTarget] && !room.players[princeTarget].eliminated && (princeTarget === playerName || !room.players[princeTarget].protected)) {
                        const discarded = room.players[princeTarget].hand[0];
                        if (discarded) {
                            updates.discardPile = [...updates.discardPile, discarded];
                            if (discarded.value === 8) {
                                updates[`players/${princeTarget}/eliminated`] = true;
                                updates[`players/${princeTarget}/hand`] = [];
                                alert(`${princeTarget} descart√≥ la Princesa y queda eliminado`);
                            } else {
                                if (room.deck.length > 0) {
                                    const newCard = room.deck[room.deck.length - 1];
                                    updates.deck = room.deck.slice(0, -1);
                                    updates[`players/${princeTarget}/hand`] = [newCard];
                                } else {
                                    updates[`players/${princeTarget}/hand`] = [room.removedCard];
                                }
                            }
                        }
                    }
                    break;
                    
                case 6:
                    const kingTarget = prompt('Elige un jugador para intercambiar manos:');
                    if (kingTarget && room.players[kingTarget] && !room.players[kingTarget].eliminated && !room.players[kingTarget].protected && kingTarget !== playerName) {
                        const myCard = room.players[playerName].hand[0];
                        const theirCard = room.players[kingTarget].hand[0];
                        
                        if (myCard && theirCard) {
                            updates[`players/${playerName}/hand`] = [theirCard];
                            updates[`players/${kingTarget}/hand`] = [myCard];
                            alert(`Intercambiaste cartas con ${kingTarget}`);
                        }
                    }
                    break;
                    
                case 7:
                    break;
                    
                case 8:
                    updates[`players/${playerName}/eliminated`] = true;
                    updates[`players/${playerName}/hand`] = [];
                    alert('Jugaste la Princesa. Quedas eliminado.');
                    break;
            }
            
            let nextTurnIndex = (room.currentTurnIndex + 1) % room.playerOrder.length;
            while (room.players[room.playerOrder[nextTurnIndex]].eliminated) {
                nextTurnIndex = (nextTurnIndex + 1) % room.playerOrder.length;
            }
            
            updates.currentTurnIndex = nextTurnIndex;
            await database.ref(`rooms/${roomCode}`).update(updates);
        }

        async function endLoveLetterRound(roomCode, winnerName) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            
            const newScore = room.players[winnerName].score + 1;
            
            await database.ref(`rooms/${roomCode}`).update({
                [`players/${winnerName}/score`]: newScore,
                currentRound: room.currentRound + 1,
                roundInProgress: false,
                currentTurnIndex: 0
            });
        }

        // Inicializaci√≥n
        showHome();
    </script>
</body>
</html>
