<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juegos de Grupo</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Configuraci√≥n de Firebase -->
    <script src="firebase-config.js"></script>

    <!-- L√≥gica de Juegos -->
    <script src="new-games.js"></script>
    <script src="loveletter-implementation.js"></script>
    <script src="conexion-implementation.js"></script>
    <script src="ux-improvements.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .game-select {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .game-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid transparent;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .game-card.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .game-card h3 {
            margin-bottom: 8px;
            font-size: 20px;
        }

        .game-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        label {
            display: block;
            margin-top: 20px;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .code-display {
            background: #f8f9fa;
            border: 3px dashed #667eea;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .code-display .code {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 8px;
            font-family: 'Courier New', monospace;
        }

        .code-display p {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #0c5460;
            font-size: 14px;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #856404;
        }

        .hidden {
            display: none !important;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .board-card {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e0e0e0;
            font-weight: bold;
            font-size: 13px;
            word-break: break-word;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                max-width: 100%;
            }

            h1 {
                font-size: 22px;
            }

            .code-display .code {
                font-size: 36px;
                letter-spacing: 4px;
            }

            .game-board {
                gap: 5px;
            }

            .board-card {
                padding: 8px;
                min-height: 45px;
                font-size: 11px;
            }
        }

        /* Nuevos Estilos Visuales */
        .spyfall-location {
            background: #2d3748;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            display: inline-block;
            font-size: 0.9em;
        }

        .conexion-card {
            width: 60px;
            height: 90px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #667eea;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .conexion-card:hover {
            transform: translateY(-5px);
        }

        .codenames-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .codenames-card {
            aspect-ratio: 4/3;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: white;
            border: 2px solid #e2e8f0;
            color: #2d3748;
        }

        .codenames-card.revealed {
            color: white;
            border: none;
        }

        .codenames-card.rojo {
            background: #fc8181;
        }

        .codenames-card.azul {
            background: #63b3ed;
        }

        .codenames-card.inocente {
            background: #cbd5e0;
            color: #4a5568;
        }

        .codenames-card.asesino {
            background: #1a202c;
            color: white;
        }

        .love-letter-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .love-letter-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .card-number {
            font-size: 2em;
            font-weight: 900;
            color: #e2e8f0;
            position: absolute;
            top: 10px;
            right: 15px;
            line-height: 1;
        }

        .card-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
            position: relative;
        }

        .card-effect {
            font-size: 0.9em;
            color: #718096;
            line-height: 1.4;
            position: relative;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Pantalla Inicial -->
        <div id="homeScreen" class="screen active">
            <h1>üéÆ Juegos de Grupo</h1>
            <p class="subtitle">Selecciona tu modo de juego</p>

            <div class="btn" onclick="showCreateGame()">Crear Nueva Sala</div>
            <div class="btn btn-secondary" onclick="showJoinGame()">Unirse a Sala</div>
        </div>

        <!-- Pantalla: Crear Sala -->
        <div id="createGameScreen" class="screen">
            <h1>Crear Nueva Sala</h1>
            <p class="subtitle">Configura tu juego</p>

            <label>Selecciona el Juego:</label>
            <div class="game-select">
                <div class="game-card" onclick="selectGame('blanco')">
                    <h3>üé≠ Blanco</h3>
                    <p>Todos tienen una palabra excepto el Blanco. ¬°Desc√∫brelo sin revelar tu palabra!</p>
                </div>
                <div class="game-card" onclick="selectGame('lobo')">
                    <h3>üê∫ El Lobo</h3>
                    <p>Aldeanos vs Lobos. Los lobos deben eliminar aldeanos sin ser descubiertos.</p>
                </div>
                <div class="game-card" onclick="selectGame('codigo')">
                    <h3>üîê C√≥digo Secreto</h3>
                    <p>Dos equipos compiten dando pistas para encontrar sus agentes. ¬°Cuidado con el asesino!</p>
                </div>
                <div class="game-card" onclick="selectGame('quickstop')">
                    <h3>üèÉ Quick Stop</h3>
                    <p>Empieza con 5 letras. Responde r√°pido con palabras seg√∫n el tema. ¬°El √∫ltimo en responder pierde!</p>
                </div>
                <div class="game-card" onclick="selectGame('loveletter')">
                    <h3>üíå Love Letter</h3>
                    <p>Juego de deducci√≥n y faroleo. S√© el √∫ltimo en pie o termina con la carta m√°s alta.</p>
                </div>
                <div class="game-card" onclick="selectGame('timesup')">
                    <h3>‚è±Ô∏è Time's Up</h3>
                    <p>3 rondas con las mismas palabras: Describe, Una palabra, M√≠mica. ¬°Contra el tiempo!</p>
                </div>

                <div class="game-card" onclick="selectGame('overunder')">
                    <h3>üìä Over/Under</h3>
                    <p>Adivina si la respuesta es M√ÅS o MENOS. Datos curiosos y apuestas r√°pidas.</p>
                </div>

                <div class="game-card" onclick="selectGame('spyfall')">
                    <h3>üïµÔ∏è Spyfall</h3>
                    <p>Descubre al esp√≠a antes de que √©l descubra la ubicaci√≥n secreta. Roles y enga√±os.</p>
                </div>

                <div class="game-card" onclick="selectGame('conexion')">
                    <h3>üß† Conexi√≥n Mental</h3>
                    <p>Juego cooperativo. Jugad cartas en orden ascendente SIN HABLAR. ¬øPod√©is conectar vuestras mentes?
                    </p>
                </div>

                <div class="game-card" onclick="selectGame('espectro')">
                    <h3>üåà Espectro Mental</h3>
                    <p>Juego social tipo Wavelength: interpreta una pista en un espectro de conceptos opuestos.</p>
                </div>
            </div>

            <!-- Configuraci√≥n Blanco -->
            <div id="blancoConfig" class="hidden">
                <div class="info">
                    üí° El sistema generar√° autom√°ticamente una palabra aleatoria de una categor√≠a. Todos ver√°n la categor√≠a, solo el "Blanco" no ver√° la palabra.
                </div>
            </div>

            <!-- Configuraci√≥n El Lobo -->
            <div id="loboConfig" class="hidden">
                <label>Nombre del Moderador:</label>
                <input type="text" id="loboModerator" placeholder="Nombre del moderador">

                <div class="info">
                    üí° El moderador no juega, solo gestiona las fases de noche y d√≠a. Debe estar en la lista de jugadores.
                </div>
            </div>

            <!-- Configuraci√≥n Quick Stop -->
            <div id="quickstopConfig" class="hidden">
                <div class="info">
                    üí° Quick Stop: Cada jugador empieza con 5 letras. Responde r√°pido con palabras que empiecen con tu letra. ¬°El √∫ltimo pierde!
                </div>
            </div>

            <!-- Configuraci√≥n Love Letter -->
            <div id="loveletterConfig" class="hidden">
                <label>Puntos para Ganar:</label>
                <input type="number" id="pointsToWin" value="4" min="2" max="10">

                <div class="info">
                    üí° Cada ronda ganada otorga 1 punto. El primer jugador en alcanzar este n√∫mero gana la partida.
                </div>
            </div>

            <!-- Configuraci√≥n Time's Up -->
            <div id="timesupConfig" class="hidden">
                <label>N√∫mero de Palabras:</label>
                <input type="number" id="numWords" value="40" min="20" max="60">

                <div class="info">
                    üí° Time's Up: Divide jugadores en 2 equipos. Los primeros 2 jugadores de la lista ser√°n los
                    representantes (marcan aciertos).
                </div>
            </div>

            <!-- Configuraci√≥n Espectro Mental -->
            <div id="espectroConfig" class="hidden">
                <label>Modo de juego:</label>
                <select id="espectroMode">
                    <option value="equipos">Por equipos</option>
                    <option value="individual">Todos contra todos</option>
                    <option value="coop">Cooperativo</option>
                </select>

                <label>N√∫mero de rondas:</label>
                <input type="number" id="espectroRounds" value="8" min="3" max="20">

                <div class="info">
                    üí° Espectro Mental: en cada ronda el sistema elige un par de conceptos opuestos y una posici√≥n
                    secreta. Un jugador da la pista y el resto intenta adivinar con un porcentaje en el espectro.
                </div>
            </div>

            <label>Nombres de Jugadores (separados por coma):</label>
            <textarea id="playerNames" placeholder="Juan, Mar√≠a, Pedro, Ana"></textarea>

            <div class="info">
                ‚ÑπÔ∏è M√≠nimo 3 jugadores para Blanco/Lobo, 4 para C√≥digo Secreto/Time's Up, 2-4 para Love Letter
            </div>

            <div class="btn" onclick="createGame()">Crear Sala</div>
            <div class="btn btn-secondary" onclick="showHome()">Volver</div>
        </div>

        <!-- Pantalla: Sala Creada -->
        <div id="lobbyScreen" class="screen">
            <h1>üéÆ Sala Creada</h1>

            <div class="code-display">
                <div class="code" id="roomCode">----</div>
                <p>Comparte este c√≥digo con los jugadores</p>
            </div>

            <div id="lobbyPlayers" style="background:#f8f9fa; border:2px dashed #667eea; border-radius:12px; padding:16px; margin:16px 0;">
                <div style="font-weight:600; color:#667eea; margin-bottom:8px;">Jugadores</div>
                <div id="lobbyPlayersConnected" style="margin-bottom:8px;"></div>
                <div id="lobbyPlayersMissing"></div>
            </div>

            <div class="info">
                üëâ Ahora puedes unirte a tu propia sala introduciendo tu nombre y el c√≥digo
            </div>

            <label>Tu Nombre (para unirte):</label>
            <input type="text" id="creatorName" placeholder="Tu nombre">

            <div class="btn" onclick="creatorJoinGame()">Unirme a la Sala</div>
            <div class="btn btn-secondary" onclick="showHome()">Crear Nueva Sala</div>
        </div>

        <!-- Pantalla: Unirse a Sala -->
    <div id="joinGameScreen" class="screen">
        <h1>Unirse a Sala</h1>
        <p class="subtitle">Introduce tus datos</p>

        <label>Tu Nombre:</label>
        <input type="text" id="playerName" placeholder="Tu nombre">

        <label>C√≥digo de Sala:</label>
        <input type="text" id="roomCodeInput" placeholder="Ej: A1B2" maxlength="4" style="text-transform: uppercase;">

        <div class="btn" onclick="joinGame()">Entrar al Juego</div>
        <div class="btn btn-secondary" onclick="showHome()">Volver</div>
    </div>

    <!-- Pantalla: Juego Activo -->
    <div id="gameScreen" class="screen">
        <div id="gameHeader"></div>
        <div id="gameContent"></div>
        <div class="btn btn-secondary" onclick="showHome()">Salir</div>
    </div>
    </div>

    <script>
        let selectedGame = null;
        let currentRoom = null;
        let roomRef = null;
        let currentPlayerName = null;

        // Navegaci√≥n entre pantallas
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showHome() {
            selectedGame = null;
            currentRoom = null;
            if (roomRef) {
                roomRef.off();
                roomRef = null;
            }
            document.getElementById('playerNames').value = '';
            document.getElementById('playerName').value = '';
            document.getElementById('roomCodeInput').value = '';
            document.getElementById('playerNames').disabled = false;
            showScreen('homeScreen');
        }

        function showCreateGame() {
            showScreen('createGameScreen');
        }

        function showJoinGame() {
            showScreen('joinGameScreen');
        }

        // Selecci√≥n de juego
        function selectGame(game) {
            selectedGame = game;
            document.querySelectorAll('.game-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.game-card').classList.add('selected');

            // Mostrar/ocultar configuraci√≥n espec√≠fica
            document.getElementById('blancoConfig').classList.add('hidden');
            document.getElementById('quickstopConfig').classList.add('hidden');
            document.getElementById('loveletterConfig').classList.add('hidden');
            document.getElementById('timesupConfig').classList.add('hidden');
            const loboCfg = document.getElementById('loboConfig');
            if (loboCfg) loboCfg.classList.add('hidden');
            const espectroCfg = document.getElementById('espectroConfig');
            if (espectroCfg) espectroCfg.classList.add('hidden');

            if (game === 'blanco') {
                document.getElementById('blancoConfig').classList.remove('hidden');
            } else if (game === 'lobo' && loboCfg) {
                loboCfg.classList.remove('hidden');
            } else if (game === 'quickstop') {
                document.getElementById('quickstopConfig').classList.remove('hidden');
            } else if (game === 'loveletter') {
                document.getElementById('loveletterConfig').classList.remove('hidden');
            } else if (game === 'timesup') {
                document.getElementById('timesupConfig').classList.remove('hidden');
            } else if (game === 'espectro' && espectroCfg) {
                espectroCfg.classList.remove('hidden');
            }
            // Nuevos juegos no requieren config extra por ahora

            // Quick Stop ahora s√≠ necesita lista de jugadores
            if (game === 'quickstop') {
                document.getElementById('playerNames').disabled = false;
            }
        }

        // Generar c√≥digo de sala √∫nico
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Crear sala
        async function createGame() {
            if (!selectedGame) {
                alert('Por favor selecciona un juego');
                return;
            }

            // Validar jugadores
            let players = [];
            if (selectedGame !== 'quickstop') {
                const playerNamesInput = document.getElementById('playerNames').value.trim();
                if (!playerNamesInput || playerNamesInput === 'No requerido') {
                    alert('Por favor introduce los nombres de los jugadores');
                    return;
                }

                // Normalizar nombres: min√∫sculas y sin acentos
                players = playerNamesInput.split(',').map(name => {
                    return name.trim()
                        .toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^a-z0-9 ]/g, '');
                }).filter(name => name);

                if (players.length < 3 && selectedGame !== 'codigo' && selectedGame !== 'loveletter' && selectedGame !== 'timesup') {
                    alert('Se necesitan m√≠nimo 3 jugadores');
                    return;
                }

                if (players.length < 4 && (selectedGame === 'codigo' || selectedGame === 'timesup')) {
                    alert('C√≥digo Secreto y Time\'s Up necesitan m√≠nimo 4 jugadores (2 por equipo)');
                    return;
                }

                if ((players.length < 2 || players.length > 4) && selectedGame === 'loveletter') {
                    alert('Love Letter necesita entre 2 y 4 jugadores');
                    return;
                }

                if (selectedGame === 'spyfall' && players.length < 3) {
                    alert('Spyfall necesita m√≠nimo 3 jugadores');
                    return;
                }
            }

            // Blanco ya no necesita validaci√≥n de palabra manual

            // Generar c√≥digo de sala
            const roomCode = generateRoomCode();

            // Crear sala en Firebase
            const room = {
                code: roomCode,
                game: selectedGame,
                createdAt: Date.now(),
                status: 'waiting'
            };

            // Configurar seg√∫n el juego
            if (selectedGame === 'blanco') {
                const wordData = getRandomBlancoWord();
                room.secretWord = wordData.word;
                room.category = wordData.category;
                const blancoIndex = Math.floor(Math.random() * players.length);

                room.players = {};
                players.forEach((name, index) => {
                    room.players[name] = {
                        role: index === blancoIndex ? 'blanco' : 'normal',
                        word: index === blancoIndex ? 'BLANCO' : room.secretWord
                    };
                });
            } else if (selectedGame === 'lobo') {
                const moderatorName = document.getElementById('loboModerator').value.trim();
                if (!moderatorName) {
                    alert('Por favor indica el nombre del moderador');
                    return;
                }
                if (!players.includes(moderatorName)) {
                    alert('El moderador debe estar en la lista de jugadores');
                    return;
                }

                const playersWithoutModerator = players.filter(p => p !== moderatorName);
                const rolesDistribution = distributeLoboRoles(playersWithoutModerator.length);
                shuffleArray(rolesDistribution);

                room.players = {};
                room.moderator = moderatorName;
                players.forEach((name) => {
                    if (name === moderatorName) {
                        room.players[name] = {
                            role: 'moderador',
                            alive: true
                        };
                    } else {
                        const roleIndex = playersWithoutModerator.indexOf(name);
                        room.players[name] = {
                            role: rolesDistribution[roleIndex],
                            alive: true,
                            enamorado: false,
                            converted: false
                        };
                    }
                });
                room.phase = 'night';
                room.currentNightTurn = null;
                room.isFirstNight = true;
                room.dayCount = 1;
                room.nightVictim = null;
                room.dayVotes = {};
                room.nightActions = {};
                room.enamorados = [];
                room.usedPotions = { save: false, kill: false };
                room.lastProtected = null;
                room.loboAlfaUsed = false;
                room.cazadorPending = null;
            } else if (selectedGame === 'codigo') {
                room.players = {};
                room.board = generateCodigoSecretoBoard();
                room.currentTeam = 'rojo';

                // Dividir jugadores en equipos
                shuffleArray(players);
                const half = Math.floor(players.length / 2);
                players.forEach((name, index) => {
                    room.players[name] = {
                        team: index < half ? 'rojo' : 'azul',
                        role: index === 0 ? 'spymaster' : (index === half ? 'spymaster' : 'operative')
                    };
                });
            } else if (selectedGame === 'quickstop') {
                // Generar letras con puntos (distribuci√≥n Scrabble simplificada)
                const letterPool = generateLetterPool();
                
                room.currentRound = 0;
                room.currentPrompt = null;
                room.phase = 'waiting'; // waiting, playing, results
                room.roundAnswers = {};
                room.roundStartTime = null;
                room.players = {};
                
                // Dar 5 letras a cada jugador
                players.forEach(name => {
                    const hand = [];
                    for (let i = 0; i < 5; i++) {
                        if (letterPool.length > 0) {
                            hand.push(letterPool.pop());
                        }
                    }
                    room.players[name] = {
                        hand: hand,
                        score: 0,
                        totalPoints: hand.reduce((sum, l) => sum + l.points, 0)
                    };
                });
            } else if (selectedGame === 'loveletter') {
                room.pointsToWin = parseInt(document.getElementById('pointsToWin').value) || 4;
                room.currentRound = 1;
                room.deck = [];
                room.discardPile = [];
                room.currentTurnIndex = 0;
                room.roundInProgress = false;
                room.playerOrder = players;

                room.players = {};
                players.forEach((name) => {
                    room.players[name] = {
                        hand: [],
                        score: 0,
                        eliminated: false,
                        protected: false
                    };
                });
            } else if (selectedGame === 'timesup') {
                const numWords = parseInt(document.getElementById('numWords').value) || 40;
                const words = generateTimesUpWords(numWords);

                // Dividir jugadores en 2 equipos
                const half = Math.ceil(players.length / 2);
                const teamA = players.slice(0, half);
                const teamB = players.slice(half);

                room.words = words;
                room.currentRound = 1; // 1=Describe, 2=Una palabra, 3=M√≠mica
                room.currentTeam = 'A';
                room.teamAScore = 0;
                room.teamBScore = 0;
                room.teamAPlayers = teamA;
                room.teamBPlayers = teamB;
                room.representativeA = teamA[0]; // Primer jugador equipo A marca aciertos
                room.representativeB = teamB[0]; // Primer jugador equipo B marca aciertos
                room.currentPlayerIndex = 0;
                room.currentWordIndex = 0;
                room.timerActive = false;
                room.timeRemaining = 30;
                room.wordsGuessedThisRound = [];

                room.players = {};
                players.forEach((name, index) => {
                    room.players[name] = {
                        team: index < half ? 'A' : 'B',
                        representative: (index === 0 || index === half)
                    };
                });

            } else if (selectedGame === 'espectro') {
                const mode = document.getElementById('espectroMode').value || 'equipos';
                const numRounds = parseInt(document.getElementById('espectroRounds').value) || 8;

                room.gameMode = mode;
                room.numRounds = numRounds;
                room.currentRound = 1;
                room.phase = 'setup';
                room.currentSpectrum = null;
                room.secretValue = null;
                room.guesses = {};
                room.currentGuideIndex = 0;
                room.playerOrder = players;

                room.players = {};

                if (mode === 'equipos') {
                    const half = Math.ceil(players.length / 2);
                    room.teamAScore = 0;
                    room.teamBScore = 0;
                    players.forEach((name, index) => {
                        room.players[name] = {
                            team: index < half ? 'A' : 'B',
                            score: 0
                        };
                    });
                } else if (mode === 'coop') {
                    room.coopScore = 0;
                    players.forEach((name) => {
                        room.players[name] = {
                            score: 0
                        };
                    });
                } else {
                    // individual (todos contra todos)
                    players.forEach((name) => {
                        room.players[name] = {
                            score: 0
                        };
                    });
                }

            } else if (selectedGame === 'overunder') {
                room.currentQuestion = null;
                room.phase = 'waiting';
                room.players = {};
                players.forEach(name => { room.players[name] = { score: 0 }; });
                startOverUnderRound(roomCode); // Pre-cargar primera pregunta
            } else if (selectedGame === 'spyfall') {
                const locKeys = Object.keys(SPYFALL_LOCATIONS);
                const location = locKeys[Math.floor(Math.random() * locKeys.length)];
                const roles = [...SPYFALL_LOCATIONS[location]];

                // Asegurar suficientes roles o repetir gen√©ricos
                while (roles.length < players.length - 1) roles.push('Ciudadano');
                shuffleArray(roles);

                const spyIndex = Math.floor(Math.random() * players.length);

                room.location = location;
                room.timerActive = false;
                room.timeRemaining = 480;
                room.players = {};

                let roleIndex = 0;
                players.forEach((name, index) => {
                    room.players[name] = {
                        role: index === spyIndex ? 'Esp√≠a' : roles[roleIndex++]
                    };
                });
            } else if (selectedGame === 'conexion') {
                room.level = 1;
                room.lives = players.length;
                room.shurikens = 1;
                room.lastCard = 0;
                room.status = 'playing';
                room.shurikenActive = false;

                const deck = Array.from({ length: 100 }, (_, i) => i + 1);
                shuffleArray(deck);

                room.players = {};
                players.forEach(name => {
                    room.players[name] = {
                        hand: [deck.pop()]
                    };
                });
            }

            // Guardar en Firebase
            try {
                await database.ref('rooms/' + roomCode).set(room);
                currentRoom = room;
                displayLobby(roomCode);

                // Auto-eliminar sala despu√©s de 24 horas
                setTimeout(async () => {
                    await database.ref('rooms/' + roomCode).remove();
                }, 24 * 60 * 60 * 1000);
            } catch (error) {
                alert('Error al crear sala: ' + error.message);
            }
        }

        function displayLobby(roomCode) {
            document.getElementById('roomCode').textContent = roomCode;
            document.getElementById('creatorName').value = '';
            showScreen('lobbyScreen');

            // Escuchar cambios para mostrar qui√©nes han entrado
            const lobbyConnectedEl = document.getElementById('lobbyPlayersConnected');
            const lobbyMissingEl = document.getElementById('lobbyPlayersMissing');
            const ref = database.ref('rooms/' + roomCode);
            ref.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;
                const players = room.players ? Object.keys(room.players) : [];

                if (players.length === 0) {
                    lobbyConnectedEl.innerHTML = '<em>Este juego no tiene lista previa de jugadores. Los jugadores se ir√°n agregando al entrar.</em>';
                    lobbyMissingEl.innerHTML = '';
                    return;
                }

                const connected = players.filter(p => room.players[p] && room.players[p].joined);
                const missing = players.filter(p => !room.players[p] || !room.players[p].joined);

                lobbyConnectedEl.innerHTML = `‚úÖ Conectados (${connected.length}/${players.length}): ${connected.length ? connected.join(', ') : '<em>ninguno</em>'}`;
                lobbyMissingEl.innerHTML = missing.length ? `‚è≥ Faltan por entrar (${missing.length}): ${missing.join(', ')}` : 'üéâ ¬°Todos han entrado!';
            });
        }

        // Creador se une a su propia sala
        async function creatorJoinGame() {
            const playerName = document.getElementById('creatorName').value.trim()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9 ]/g, '');
            const roomCode = document.getElementById('roomCode').textContent;

            if (!playerName) {
                alert('Por favor introduce tu nombre');
                return;
            }

            // Buscar sala en Firebase
            try {
                const snapshot = await database.ref('rooms/' + roomCode).once('value');
                const room = snapshot.val();

                if (!room) {
                    alert('Error: Sala no encontrada');
                    return;
                }

                currentRoom = room;
                currentRoom.code = roomCode;
                roomRef = database.ref('rooms/' + roomCode);
                currentPlayerName = playerName;

                // Marcar jugador como conectado (si existe en la lista)
                if (room.players && room.players[playerName]) {
                    await database.ref(`rooms/${roomCode}/players/${playerName}/joined`).set(true);
                }

                // Jugar seg√∫n el tipo de juego
                if (room.game === 'quickstop') {
                    playQuickStop(roomCode, playerName);
                } else if (room.game === 'codigo') {
                    playCodigoSecreto(roomCode, playerName, room);
                } else if (room.game === 'loveletter') {
                    playLoveLetter(roomCode, playerName);
                } else if (room.game === 'blanco') {
                    showRole(room, playerName);
                } else if (room.game === 'lobo') {
                    playLobo(roomCode, playerName);
                } else if (room.game === 'timesup') {
                    playTimesUp(roomCode, playerName);
                } else if (room.game === 'overunder') {
                    playOverUnder(roomCode, playerName);
                } else if (room.game === 'spyfall') {
                    playSpyfall(roomCode, playerName);
                } else if (room.game === 'conexion') {
                    playConexionMental(roomCode, playerName);
                } else if (room.game === 'espectro') {
                    playEspectroMental(roomCode, playerName);
                }
            } catch (error) {
                alert('Error al unirse: ' + error.message);
            }
        }

        // Unirse a sala
        async function joinGame() {
            const playerName = document.getElementById('playerName').value.trim()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9 ]/g, '');
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();

            if (!playerName) {
                alert('Por favor introduce tu nombre');
                return;
            }

            if (!roomCode || roomCode.length !== 4) {
                alert('Por favor introduce un c√≥digo de sala v√°lido');
                return;
            }

            // Buscar sala en Firebase
            try {
                const snapshot = await database.ref('rooms/' + roomCode).once('value');
                const room = snapshot.val();

                if (!room) {
                    alert('Sala no encontrada. Verifica el c√≥digo.');
                    return;
                }

                currentRoom = room;
                currentRoom.code = roomCode;
                roomRef = database.ref('rooms/' + roomCode);
                currentPlayerName = playerName;

                // Marcar jugador como conectado (si existe en la lista)
                if (room.players && room.players[playerName]) {
                    await database.ref(`rooms/${roomCode}/players/${playerName}/joined`).set(true);
                }

                // Jugar seg√∫n el tipo de juego
                if (room.game === 'quickstop') {
                    playQuickStop(roomCode, playerName);
                } else if (room.game === 'codigo') {
                    playCodigoSecreto(roomCode, playerName, room);
                } else if (room.game === 'loveletter') {
                    playLoveLetter(roomCode, playerName);
                } else if (room.game === 'blanco') {
                    showRole(room, playerName);
                } else if (room.game === 'lobo') {
                    playLobo(roomCode, playerName);
                } else if (room.game === 'timesup') {
                    playTimesUp(roomCode, playerName);
                } else if (room.game === 'overunder') {
                    playOverUnder(roomCode, playerName);
                } else if (room.game === 'spyfall') {
                    playSpyfall(roomCode, playerName);
                } else if (room.game === 'conexion') {
                    playConexionMental(roomCode, playerName);
                } else if (room.game === 'espectro') {
                    playEspectroMental(roomCode, playerName);
                }
            } catch (error) {
                alert('Error al unirse: ' + error.message);
            }
        }

        function showRole(room, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            if (!room.players[playerName]) {
                alert('Tu nombre no est√° en la lista de jugadores de esta sala');
                return;
            }

            gameHeader.innerHTML = renderGameHeader(room.code, room.game);
            updateGamePlayerStatus(room.code);
            const player = room.players[playerName];

            if (room.game === 'blanco') {
                if (player.role === 'blanco') {
                    gameContent.innerHTML = `
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 40px; border-radius: 15px; text-align: center;">
                            <h2 style="font-size: 32px; margin-bottom: 15px;">¬°Eres el BLANCO!</h2>
                            <div style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 10px; margin: 15px 0;">
                                <div style="font-size: 18px; margin-bottom: 5px;">üè∑Ô∏è Categor√≠a:</div>
                                <div style="font-size: 28px; font-weight: bold;">${room.category}</div>
                            </div>
                            <div style="font-size: 40px; font-weight: bold; margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 10px;">‚ùì BLANCO</div>
                            <p>No tienes palabra. Debes adivinar cu√°l es la palabra secreta sin que te descubran.</p>
                            <p>üí° Disimula y trata de integrarte en la conversaci√≥n</p>
                        </div>
                        <div class="btn" onclick="startNewBlancoRound('${room.code}')">Nueva Ronda</div>
                    `;
                } else {
                    gameContent.innerHTML = `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; text-align: center;">
                            <div style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                <div style="font-size: 18px; margin-bottom: 5px;">üè∑Ô∏è Categor√≠a:</div>
                                <div style="font-size: 28px; font-weight: bold;">${room.category}</div>
                            </div>
                            <h2 style="font-size: 32px; margin-bottom: 15px;">Tu Palabra es:</h2>
                            <div style="font-size: 40px; font-weight: bold; margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 10px;">${player.word}</div>
                            <p>Hay un jugador que es el BLANCO y no tiene esta palabra.</p>
                            <p>üí° Habla sobre la palabra sin decirla directamente</p>
                        </div>
                        <div class="btn" onclick="startNewBlancoRound('${room.code}')">Nueva Ronda</div>
                    `;
                }
            }

            showScreen('gameScreen');
        }

        // Nueva ronda en Blanco
        async function startNewBlancoRound(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            if (!room || room.game !== 'blanco') return;

            const wordData = getRandomBlancoWord();
            const players = Object.keys(room.players);
            const blancoIndex = Math.floor(Math.random() * players.length);

            const updates = {
                secretWord: wordData.word,
                category: wordData.category
            };

            players.forEach((name, index) => {
                updates[`players/${name}/role`] = index === blancoIndex ? 'blanco' : 'normal';
                updates[`players/${name}/word`] = index === blancoIndex ? 'BLANCO' : wordData.word;
            });

            await database.ref(`rooms/${roomCode}`).update(updates);
            
            // Recargar la vista autom√°ticamente
            const updatedSnapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const updatedRoom = updatedSnapshot.val();
            if (updatedRoom && currentPlayerName) {
                showRole(updatedRoom, currentPlayerName);
            }
        }

        // C√≥digo Secreto - Generar tablero
        function generateCodigoSecretoBoard() {
            const words = [
                'Casa', 'Perro', 'Playa', 'Libro', 'Caf√©', 'Luna', 'Piano', 'Reloj', 'Jard√≠n', 'Puente',
                'Monta√±a', 'Estrella', 'Fuego', 'Nube', 'Robot', '√Årbol', 'Mar', 'Luz', 'Sombra', 'Viento',
                'R√≠o', 'Flores', 'Nieve', 'Torre', 'Drag√≥n'
            ];

            shuffleArray(words);
            const board = [];
            const roles = ['rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo',
                'azul', 'azul', 'azul', 'azul', 'azul', 'azul', 'azul', 'azul',
                'inocente', 'inocente', 'inocente', 'inocente', 'inocente', 'inocente', 'inocente',
                'asesino'];
            shuffleArray(roles);

            for (let i = 0; i < 25; i++) {
                board.push({
                    word: words[i],
                    role: roles[i],
                    revealed: false
                });
            }

            return board;
        }

        function playCodigoSecreto(roomCode, playerName, room) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'codigo');
            updateGamePlayerStatus(roomCode);

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const player = room.players[playerName];
                if (!player) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s registrado en esta partida</p>';
                    return;
                }

                // Contar agentes por equipo
                let rojoTotal = 0, rojoRevealed = 0;
                let azulTotal = 0, azulRevealed = 0;
                let asesinRevealed = false;
                let gameOver = false;
                let winner = null;

                room.board.forEach(card => {
                    if (card.role === 'rojo') {
                        rojoTotal++;
                        if (card.revealed) rojoRevealed++;
                    } else if (card.role === 'azul') {
                        azulTotal++;
                        if (card.revealed) azulRevealed++;
                    } else if (card.role === 'asesino' && card.revealed) {
                        asesinRevealed = true;
                        // El equipo que revel√≥ el asesino pierde
                        winner = room.currentTeam === 'rojo' ? 'AZUL' : 'ROJO';
                        gameOver = true;
                    }
                });

                // Detectar victoria por completar agentes
                if (rojoRevealed === rojoTotal && !gameOver) {
                    winner = 'ROJO';
                    gameOver = true;
                }
                if (azulRevealed === azulTotal && !gameOver) {
                    winner = 'AZUL';
                    gameOver = true;
                }

                if (gameOver) {
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: ${winner === 'ROJO' ? '#ff6b6b' : '#4dabf7'}; color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">¬°Equipo ${winner} GANA!</h1>
                            ${asesinRevealed ? '<p style="margin-top: 20px;">El otro equipo revel√≥ al ASESINO üí•</p>' : '<p style="margin-top: 20px;">¬°Encontraron todos sus agentes!</p>'}
                        </div>
                        <div class="btn" onclick="location.reload()">Volver al Inicio</div>
                    `;
                    return;
                }

                let html = `
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">üîê C√≥digo Secreto</h2>
                    <div style="background: ${player.team === 'rojo' ? '#fc8181' : '#63b3ed'}; color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <strong>Equipo: ${player.team.toUpperCase()}</strong><br>
                        Rol: ${player.role === 'spymaster' ? 'SPYMASTER' : 'OPERATIVE'}
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                        <div style="background: #fc8181; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            üî¥ Rojo: ${rojoRevealed}/${rojoTotal}
                        </div>
                        <div style="background: #63b3ed; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            üîµ Azul: ${azulRevealed}/${azulTotal}
                        </div>
                    </div>
                    <div class="codenames-grid">
                `;

                room.board.forEach((card, index) => {
                    const showRole = player.role === 'spymaster';
                    const isClickable = player.role === 'spymaster' && !card.revealed;
                    const cursor = isClickable ? 'pointer' : 'default';
                    const onclick = isClickable ? `onclick="revealCodigoCard('${roomCode}', ${index})"` : '';

                    html += `
                        <div class="codenames-card ${card.revealed ? card.role : ''} ${card.revealed ? 'revealed' : ''}" 
                             style="${!card.revealed && showRole ? (card.role === 'rojo' ? 'color: #fc8181; border-color: #fc8181;' : card.role === 'azul' ? 'color: #63b3ed; border-color: #63b3ed;' : card.role === 'asesino' ? 'color: #2d3748; border-color: #2d3748;' : '') : ''}; cursor: ${cursor};" 
                             ${onclick}>
                            ${card.word}
                            ${!card.revealed && showRole ? `<div style="position: absolute; bottom: 2px; right: 2px; width: 8px; height: 8px; border-radius: 50%; background: ${card.role === 'rojo' ? '#fc8181' : card.role === 'azul' ? '#63b3ed' : card.role === 'asesino' ? '#2d3748' : '#cbd5e0'};"></div>` : ''}
                        </div>
                    `;
                });

                html += `</div>
                    <div class="info">
                        ${player.role === 'spymaster' ?
                        'üí° Da pistas de UNA palabra + n√∫mero. <strong>Clickea las palabras</strong> que elijan tus operatives para revelarlas.' :
                        'üí° Escucha a tu spymaster y adivina las palabras de tu equipo. El spymaster revelar√° las palabras.'}
                    </div>
                `;

                gameContent.innerHTML = html;
            });

            showScreen('gameScreen');
        }

        async function revealCodigoCard(roomCode, cardIndex) {
            await database.ref(`rooms/${roomCode}/board/${cardIndex}/revealed`).set(true);
        }

        function playLobo(roomCode, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'lobo');
            updateGamePlayerStatus(roomCode);

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const player = room.players[playerName];
                if (!player) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s registrado en esta partida</p>';
                    return;
                }

                // Detectar fin de juego
                const victory = checkLoboVictory(room);
                if (victory) {
                    const color = victory.winner === 'aldeanos' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)';
                    const titleColor = victory.winner === 'aldeanos' ? 'white' : '#333';
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: ${color}; color: ${titleColor}; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">¬°${victory.winner.toUpperCase()} GANAN!</h1>
                            <p style="margin-top: 20px;">${victory.message}</p>
                        </div>
                    `;
                    return;
                }

                const isModerator = player.role === 'moderador';
                
                if (isModerator) {
                    gameContent.innerHTML = renderModeratorView(room, roomCode);
                } else {
                    gameContent.innerHTML = renderPlayerView(room, playerName);
                }
            });

            showScreen('gameScreen');
        }

        function renderModeratorView(room, roomCode) {
            const alivePlayers = Object.keys(room.players).filter(p => room.players[p].alive && room.players[p].role !== 'moderador');
            const nightTurns = getNightTurnOrder(room);
            const currentTurnIndex = room.currentNightTurn ? nightTurns.indexOf(room.currentNightTurn) : -1;
            
            let html = `
                <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">üê∫ El Lobo - Moderador</h2>
                <div style="background: #ffc107; color: #333; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                    <strong>üé≠ MODERADOR</strong><br>
                    Fase: ${room.phase === 'night' ? 'üåô NOCHE' + (room.isFirstNight ? ' (Primera)' : '') : '‚òÄÔ∏è D√çA ' + room.dayCount}
                    ${room.phase === 'night' && room.currentNightTurn ? `<br>Turno: ${room.currentNightTurn.toUpperCase()}` : ''}
                </div>
            `;

            // Botones de control de fase
            if (room.phase === 'night') {
                if (!room.currentNightTurn) {
                    html += `<div class="btn" onclick="startNightPhase('${roomCode}')">Iniciar Turnos de Noche</div>`;
                } else if (currentTurnIndex < nightTurns.length - 1) {
                    html += `
                        <div class="info">Turno actual: <strong>${room.currentNightTurn}</strong></div>
                        <div class="btn" onclick="nextNightTurn('${roomCode}')">Siguiente Turno</div>
                    `;
                } else {
                    html += `
                        <div class="info">Todos los turnos completados</div>
                        <div class="btn" onclick="resolveNight('${roomCode}')">Resolver Noche y Pasar al D√≠a</div>
                    `;
                }
            } else if (room.cazadorPending) {
                html += `<div class="info" style="background: #ff6b6b; color: white;">Esperando que el Cazador elija su v√≠ctima...</div>`;
            } else {
                html += `
                    <div class="info">Fase de d√≠a. Los jugadores votan.</div>
                `;
            }

            // Lista de jugadores con roles
            html += '<div style="margin: 20px 0;"><h3>Jugadores:</h3>';
            Object.keys(room.players).forEach(p => {
                const pl = room.players[p];
                if (pl.role === 'moderador') return;

                const icon = getRoleIcon(pl.role);
                const status = pl.alive ? '‚úÖ' : '‚ùå';
                const enamorado = pl.enamorado ? 'üíò' : '';
                const converted = pl.converted ? ' (Convertido)' : '';

                html += `
                    <div style="background: ${pl.alive ? '#e7f3ff' : '#f8f9fa'}; padding: 12px; border-radius: 8px; margin: 5px 0; border-left: 4px solid ${(pl.role === 'lobo' || pl.role === 'loboalfa') ? '#dc3545' : '#667eea'}; opacity: ${pl.alive ? 1 : 0.5};">
                        ${status} ${enamorado} <strong>${p}</strong> - ${icon} ${pl.role.toUpperCase()}${converted}
                    </div>
                `;
            });
            html += '</div>';

            // Informaci√≥n de acciones nocturnas
            if (room.phase === 'night' && room.nightActions && Object.keys(room.nightActions).length > 0) {
                html += '<div style="background: #2c3e50; color: white; padding: 15px; border-radius: 10px; margin: 15px 0;"><h4>Acciones de la noche:</h4>';
                Object.entries(room.nightActions).forEach(([action, value]) => {
                    html += `<div>‚Ä¢ ${action}: ${JSON.stringify(value)}</div>`;
                });
                html += '</div>';
            }

            // Votaci√≥n del d√≠a
            if (room.phase === 'day' && !room.cazadorPending) {
                if (Object.keys(room.dayVotes || {}).length > 0) {
                    html += '<h3>Votos actuales:</h3><div style="margin: 10px 0;">';
                    const voteCounts = {};
                    Object.entries(room.dayVotes).forEach(([voter, target]) => {
                        const voterPlayer = room.players[voter];
                        const voteValue = voterPlayer && voterPlayer.role === 'alcalde' ? 2 : 1;
                        voteCounts[target] = (voteCounts[target] || 0) + voteValue;
                        html += `<div style="padding: 8px; background: #f8f9fa; border-radius: 5px; margin: 5px 0;"><strong>${voter}</strong> ${voterPlayer && voterPlayer.role === 'alcalde' ? '(x2)' : ''} ‚Üí ${target}</div>`;
                    });
                    html += '</div><h4>Conteo:</h4><div>';
                    Object.entries(voteCounts).sort((a, b) => b[1] - a[1]).forEach(([target, count]) => {
                        html += `<div style="padding: 8px; background: #fffbea; border-radius: 5px; margin: 5px 0; font-weight: bold;">${target}: ${count} votos</div>`;
                    });
                    html += '</div>';
                }

                html += `
                    <h3 style="margin-top: 20px;">Eliminar jugador:</h3>
                    <select id="dayVictimSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 2px solid #667eea;">
                        <option value="">Seleccionar eliminado...</option>
                        <option value="nadie">Nadie (empate/decisi√≥n del pueblo)</option>
                        ${alivePlayers.map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                    <div class="btn" onclick="resolveDayVote('${roomCode}')">Confirmar Eliminaci√≥n</div>
                `;
            }

            return html;
        }

        function renderPlayerView(room, playerName) {
            const player = room.players[playerName];
            const alivePlayers = Object.keys(room.players).filter(p => room.players[p].alive && room.players[p].role !== 'moderador');
            const myRole = player.role;
            const roleIcon = getRoleIcon(myRole);
            const roleDesc = getRoleDescription(myRole);
            
            // Informaci√≥n de lobos para lobos
            let lobosInfo = '';
            if (myRole === 'lobo' || myRole === 'loboalfa') {
                const otherLobos = Object.keys(room.players).filter(p => 
                    p !== playerName && 
                    (room.players[p].role === 'lobo' || room.players[p].role === 'loboalfa') && 
                    room.players[p].alive
                );
                lobosInfo = otherLobos.length > 0 ? `<p><strong>Otros lobos:</strong> ${otherLobos.join(', ')}</p>` : '<p>Eres el √∫nico lobo</p>';
            }

            // Informaci√≥n de enamorados
            let enamoradoInfo = '';
            if (player.enamorado && room.enamorados && room.enamorados.length === 2) {
                const otherEnamorado = room.enamorados.find(e => e !== playerName);
                enamoradoInfo = `<div style="background: #ff69b4; color: white; padding: 10px; border-radius: 8px; margin: 10px 0;">üíò Est√°s enamorado de <strong>${otherEnamorado}</strong></div>`;
            }

            let html = `
                <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">üê∫ El Lobo</h2>
                <div style="background: linear-gradient(135deg, ${(myRole === 'lobo' || myRole === 'loboalfa') ? '#fa709a 0%, #fee140' : '#667eea 0%, #764ba2'} 100%); color: ${(myRole === 'lobo' || myRole === 'loboalfa') ? '#333' : 'white'}; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 15px;">
                    <h2 style="font-size: 28px; margin-bottom: 10px;">${roleIcon} Eres: ${myRole.toUpperCase()}</h2>
                    <p>${roleDesc}</p>
                    ${lobosInfo}
                    ${!player.alive ? '<p style="margin-top: 15px; font-weight: bold; font-size: 20px;">‚ùå EST√ÅS ELIMINADO</p>' : ''}
                </div>
                ${enamoradoInfo}
                <div style="background: ${room.phase === 'night' ? '#2c3e50' : '#fffbea'}; color: ${room.phase === 'night' ? 'white' : '#333'}; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                    <strong>Fase:</strong> ${room.phase === 'night' ? 'üåô NOCHE' : '‚òÄÔ∏è D√çA ' + room.dayCount}
                    ${room.phase === 'night' && room.currentNightTurn ? `<br><small>Turno: ${room.currentNightTurn}</small>` : ''}
                </div>
            `;

            // Jugadores vivos
            html += '<h3>Jugadores vivos:</h3><div style="margin-bottom: 15px;">';
            alivePlayers.forEach(p => {
                const isEnamorado = room.enamorados && room.enamorados.includes(p) ? 'üíò' : '';
                html += `<div style="background: #e7f3ff; padding: 10px; border-radius: 8px; margin: 5px 0;">‚úÖ ${p} ${isEnamorado}</div>`;
            });
            html += '</div>';

            // Acci√≥n seg√∫n fase y rol
            if (player.alive) {
                if (room.phase === 'night' && room.currentNightTurn) {
                    html += renderNightAction(room, playerName, myRole);
                } else if (room.phase === 'day') {
                    if (room.cazadorPending === playerName) {
                        // Cazador muri√≥, debe elegir v√≠ctima
                        html += `
                            <div style="background: #ff6b6b; color: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                                <h3>üèπ Poder del Cazador</h3>
                                <p>Has muerto. Elige a qui√©n llevarte contigo:</p>
                            </div>
                            <select id="cazadorVictimSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 2px solid #ff6b6b;">
                                <option value="">Seleccionar...</option>
                                ${alivePlayers.filter(p => p !== playerName).map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div class="btn" onclick="submitCazadorKill('${room.code}')">Confirmar</div>
                        `;
                    } else {
                        // Votaci√≥n normal del d√≠a
                        const hasVoted = room.dayVotes && room.dayVotes[playerName];
                        html += `
                            <h3>Vota para eliminar:</h3>
                            ${hasVoted ? `<div class="info">‚úÖ Ya has votado por: <strong>${room.dayVotes[playerName]}</strong></div>` : ''}
                            <select id="voteSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 2px solid #667eea;">
                                <option value="">Seleccionar...</option>
                                ${alivePlayers.filter(p => p !== playerName).map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div class="btn" onclick="submitDayVote('${room.code}', '${playerName}')">üó≥Ô∏è Enviar Voto${myRole === 'alcalde' ? ' (x2)' : ''}</div>
                        `;
                    }
                } else {
                    html += `<div class="info">üåô El moderador est√° gestionando la noche. ${(myRole === 'lobo' || myRole === 'loboalfa') ? 'Discute con tu manada en privado.' : 'Descansa.'}</div>`;
                }
            }

            return html;
        }

        function renderNightAction(room, playerName, myRole) {
            const alivePlayers = Object.keys(room.players).filter(p => room.players[p].alive && room.players[p].role !== 'moderador');
            let html = '';

            // Solo mostrar si es el turno del rol del jugador
            if (room.currentNightTurn === 'cupido' && myRole === 'cupido') {
                html += `
                    <div style="background: #ff69b4; color: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h3>üíò Tu turno: Cupido</h3>
                        <p>Elige 2 enamorados (morir√°n juntos si uno muere):</p>
                    </div>
                    <label>Enamorado 1:</label>
                    <select id="enamorado1" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px;">
                        <option value="">Seleccionar...</option>
                        ${alivePlayers.map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                    <label>Enamorado 2:</label>
                    <select id="enamorado2" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px;">
                        <option value="">Seleccionar...</option>
                        ${alivePlayers.map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                    <div class="btn" onclick="submitCupidoAction('${room.code}')">Confirmar Enamorados</div>
                `;
            } else if (room.currentNightTurn === 'lobos' && (myRole === 'lobo' || myRole === 'loboalfa')) {
                if (room.isFirstNight) {
                    html += `<div class="info" style="background: #2c3e50; color: white;">Esta es la primera noche. Los lobos se conocen pero NO eligen v√≠ctima a√∫n. Esperando al moderador...</div>`;
                } else {
                    html += `
                        <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                            <h3>üê∫ Tu turno: Lobos</h3>
                            <p>Elige una v√≠ctima para esta noche:</p>
                        </div>
                        <select id="loboVictimSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px;">
                            <option value="">Seleccionar...</option>
                            ${alivePlayers.filter(p => room.players[p].role !== 'lobo' && room.players[p].role !== 'loboalfa').map(p => `<option value="${p}">${p}</option>`).join('')}
                        </select>
                        <div class="btn" onclick="submitLoboKill('${room.code}', '${playerName}')">Confirmar V√≠ctima</div>
                    `;
                }
            } else if (room.currentNightTurn === 'loboalfa' && myRole === 'loboalfa' && !room.loboAlfaUsed) {
                html += `
                    <div style="background: #8b4513; color: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h3>üê∫üëë Tu turno: Lobo Alfa</h3>
                        <p>Puedes convertir a un aldeano en lobo (solo 1 vez en la partida):</p>
                    </div>
                    <select id="loboAlfaConvertSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px;">
                        <option value="">No convertir a nadie</option>
                        ${alivePlayers.filter(p => room.players[p].role !== 'lobo' && room.players[p].role !== 'loboalfa').map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                    <div class="btn" onclick="submitLoboAlfaConvert('${room.code}')">Confirmar</div>
                `;
            } else if (room.currentNightTurn === 'vidente' && myRole === 'vidente') {
                html += `
                    <div style="background: #9c27b0; color: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h3>üîÆ Tu turno: Vidente</h3>
                        <p>Elige a qui√©n quieres ver su rol:</p>
                    </div>
                    <select id="videnteTargetSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px;">
                        <option value="">Seleccionar...</option>
                        ${alivePlayers.filter(p => p !== playerName).map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                    <div class="btn" onclick="submitVidenteAction('${room.code}')">Ver Rol</div>
                `;
                
                // Mostrar resultado si ya vio a alguien
                if (room.nightActions && room.nightActions.videnteResult) {
                    const result = room.nightActions.videnteResult;
                    html += `<div class="info" style="background: #9c27b0; color: white; margin-top: 10px;">‚úÖ <strong>${result.target}</strong> es: ${getRoleIcon(result.role)} <strong>${result.role.toUpperCase()}</strong></div>`;
                }
            } else if (room.currentNightTurn === 'guardian' && myRole === 'guardian') {
                html += `
                    <div style="background: #2196f3; color: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h3>üõ°Ô∏è Tu turno: Guardi√°n</h3>
                        <p>Elige a qui√©n proteger esta noche:</p>
                        ${room.lastProtected ? `<p><small>√öltimo protegido: ${room.lastProtected}</small></p>` : ''}
                    </div>
                    <select id="guardianProtectSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px;">
                        <option value="">Seleccionar...</option>
                        ${alivePlayers.filter(p => p !== room.lastProtected).map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                    <div class="btn" onclick="submitGuardianAction('${room.code}')">Proteger</div>
                `;
            } else if (room.currentNightTurn === 'bruja' && myRole === 'bruja') {
                const victim = room.nightVictim;
                html += `
                    <div style="background: #4caf50; color: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                        <h3>üßô Tu turno: Bruja</h3>
                        ${victim ? `<p>Los lobos han elegido a: <strong>${victim}</strong></p>` : '<p>No hay v√≠ctima esta noche.</p>'}
                    </div>
                `;
                
                if (victim && !room.usedPotions.save) {
                    html += `
                        <div class="btn" onclick="submitBrujaAction('${room.code}', 'save', '${victim}')">üíö Usar Poci√≥n de Vida (salvar a ${victim})</div>
                    `;
                }
                
                if (!room.usedPotions.kill) {
                    html += `
                        <label>Poci√≥n de Muerte:</label>
                        <select id="brujaKillSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px;">
                            <option value="">No usar</option>
                            ${alivePlayers.filter(p => p !== playerName && p !== victim).map(p => `<option value="${p}">${p}</option>`).join('')}
                        </select>
                        <div class="btn" onclick="submitBrujaKillAction('${room.code}')">‚ò†Ô∏è Usar Poci√≥n de Muerte</div>
                    `;
                }
                
                html += `<div class="btn btn-secondary" onclick="submitBrujaAction('${room.code}', 'pass', null)">Pasar (no usar pociones)</div>`;
            } else if (room.currentNightTurn === 'ni√±a' && myRole === 'ni√±a') {
                html += `
                    <div class="info" style="background: #ff9800; color: white;">
                        üëß Turno de la Ni√±a: Puedes espiar a los lobos (solo ves informaci√≥n). El moderador te dir√° qui√©nes son si decides espiar.
                    </div>
                `;
            } else {
                html += `<div class="info">Turno de <strong>${room.currentNightTurn}</strong>. Esperando...</div>`;
            }

            return html;
        }

        async function confirmNightKill(roomCode) {
            const victim = document.getElementById('nightVictimSelect').value;
            if (!victim) {
                alert('Selecciona una v√≠ctima');
                return;
            }

            await database.ref(`rooms/${roomCode}`).update({
                [`players/${victim}/alive`]: false,
                phase: 'day',
                nightVictim: victim,
                dayVotes: {}
            });
        }

        async function confirmDayElimination(roomCode) {
            const victim = document.getElementById('dayVictimSelect').value;
            if (!victim) {
                alert('Selecciona un eliminado');
                return;
            }

            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();

            await database.ref(`rooms/${roomCode}`).update({
                [`players/${victim}/alive`]: false,
                phase: 'night',
                dayCount: room.dayCount + 1,
                dayVotes: {}
            });
        }

        async function submitDayVote(roomCode, playerName) {
            const vote = document.getElementById('voteSelect').value;
            if (!vote) {
                alert('Selecciona un jugador');
                return;
            }

            await database.ref(`rooms/${roomCode}/dayVotes/${playerName}`).set(vote);
            alert('Voto enviado al moderador');
        }

        // ============================================
        // EL LOBO - Funciones auxiliares
        // ============================================

        function distributeLoboRoles(numPlayers) {
            // Calcular n√∫mero de lobos: 3-6 = 1 lobo, 7-12 = 2 lobos, 13-18 = 3 lobos
            const numLobos = Math.floor((numPlayers - 1) / 6) + 1;
            const hasLoboAlfa = numLobos >= 2;
            
            const roles = [];
            
            // A√±adir lobos
            if (hasLoboAlfa) {
                roles.push('loboalfa');
                for (let i = 1; i < numLobos; i++) {
                    roles.push('lobo');
                }
            } else {
                roles.push('lobo');
            }
            
            // Roles especiales aldeanos (prioridad)
            const specialRoles = ['vidente', 'bruja', 'cazador', 'cupido', 'guardian', 'ni√±a', 'alcalde'];
            const availableSlots = numPlayers - roles.length;
            const numSpecialRoles = Math.min(specialRoles.length, availableSlots - 1); // Al menos 1 aldeano simple
            
            for (let i = 0; i < numSpecialRoles; i++) {
                roles.push(specialRoles[i]);
            }
            
            // Rellenar con aldeanos simples
            while (roles.length < numPlayers) {
                roles.push('aldeano');
            }
            
            return roles;
        }

        function getRoleIcon(role) {
            const icons = {
                'moderador': 'üé≠',
                'lobo': 'üê∫',
                'loboalfa': 'üê∫üëë',
                'aldeano': 'üë®',
                'vidente': 'üîÆ',
                'bruja': 'üßô',
                'cazador': 'üèπ',
                'cupido': 'üíò',
                'guardian': 'üõ°Ô∏è',
                'ni√±a': 'üëß',
                'alcalde': 'üëî'
            };
            return icons[role] || '‚ùì';
        }

        function getRoleDescription(role) {
            const descriptions = {
                'lobo': 'Eliminas aldeanos por la noche',
                'loboalfa': 'Puedes convertir a un aldeano (1 uso)',
                'aldeano': 'Descubre a los lobos',
                'vidente': 'Ves el rol de alguien cada noche',
                'bruja': 'Poci√≥n de vida y muerte (1 uso c/u)',
                'cazador': 'Al morir te llevas a alguien',
                'cupido': 'Primera noche: elige 2 enamorados',
                'guardian': 'Protege a alguien cada noche',
                'ni√±a': 'Puedes espiar a los lobos',
                'alcalde': 'Tu voto cuenta doble'
            };
            return descriptions[role] || '';
        }

        function getNightTurnOrder(room) {
            const turns = [];
            const players = Object.keys(room.players).filter(p => room.players[p].alive && room.players[p].role !== 'moderador');
            
            if (room.isFirstNight) {
                // Primera noche: solo Cupido y presentaci√≥n de lobos
                if (players.some(p => room.players[p].role === 'cupido')) {
                    turns.push('cupido');
                }
                turns.push('lobos');
            } else {
                // Noches siguientes
                turns.push('lobos');
                if (players.some(p => room.players[p].role === 'loboalfa') && !room.loboAlfaUsed) {
                    turns.push('loboalfa');
                }
                if (players.some(p => room.players[p].role === 'vidente')) {
                    turns.push('vidente');
                }
                if (players.some(p => room.players[p].role === 'guardian')) {
                    turns.push('guardian');
                }
                if (players.some(p => room.players[p].role === 'bruja')) {
                    turns.push('bruja');
                }
                if (players.some(p => room.players[p].role === 'ni√±a')) {
                    turns.push('ni√±a');
                }
            }
            
            return turns;
        }

        function checkLoboVictory(room) {
            const alivePlayers = Object.keys(room.players).filter(p => room.players[p].alive && room.players[p].role !== 'moderador');
            const lobos = alivePlayers.filter(p => room.players[p].role === 'lobo' || room.players[p].role === 'loboalfa');
            const aldeanos = alivePlayers.filter(p => room.players[p].role !== 'lobo' && room.players[p].role !== 'loboalfa');
            
            if (lobos.length === 0) {
                return { winner: 'aldeanos', message: 'Todos los lobos han sido eliminados' };
            }
            if (lobos.length >= aldeanos.length) {
                return { winner: 'lobos', message: 'Los lobos han igualado o superado a los aldeanos' };
            }
            return null;
        }

        // Funciones de control de fases y turnos nocturnos
        async function startNightPhase(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            const nightTurns = getNightTurnOrder(room);
            
            if (nightTurns.length > 0) {
                await database.ref(`rooms/${roomCode}`).update({
                    currentNightTurn: nightTurns[0],
                    nightActions: {}
                });
            }
        }

        async function nextNightTurn(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            const nightTurns = getNightTurnOrder(room);
            const currentIndex = nightTurns.indexOf(room.currentNightTurn);
            
            if (currentIndex < nightTurns.length - 1) {
                await database.ref(`rooms/${roomCode}/currentNightTurn`).set(nightTurns[currentIndex + 1]);
            }
        }

        async function resolveNight(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            
            let victim = room.nightVictim;
            const nightActions = room.nightActions || {};
            const deaths = [];
            
            // Procesar protecci√≥n del guardi√°n
            if (nightActions.guardianProtect && nightActions.guardianProtect === victim) {
                victim = null; // Salvado por el guardi√°n
            }
            
            // Procesar acci√≥n de la bruja
            if (nightActions.brujaSave && nightActions.brujaSave === victim) {
                victim = null; // Salvado por la bruja
            }
            
            if (victim) {
                deaths.push(victim);
            }
            
            // A√±adir muerte por poci√≥n de la bruja
            if (nightActions.brujaKill) {
                deaths.push(nightActions.brujaKill);
            }
            
            // Aplicar muertes
            const updates = {
                phase: 'day',
                currentNightTurn: null,
                nightVictim: null,
                nightActions: {},
                isFirstNight: false
            };
            
            deaths.forEach(playerName => {
                updates[`players/${playerName}/alive`] = false;
                
                // Si muere un enamorado, el otro tambi√©n muere
                if (room.enamorados && room.enamorados.includes(playerName)) {
                    const otherEnamorado = room.enamorados.find(e => e !== playerName);
                    if (otherEnamorado && room.players[otherEnamorado].alive) {
                        updates[`players/${otherEnamorado}/alive`] = false;
                    }
                }
                
                // Si muere el cazador, activar su poder
                if (room.players[playerName].role === 'cazador') {
                    updates.cazadorPending = playerName;
                }
            });
            
            await database.ref(`rooms/${roomCode}`).update(updates);
        }

        // Funciones de acciones espec√≠ficas por rol
        async function submitCupidoAction(roomCode) {
            const e1 = document.getElementById('enamorado1').value;
            const e2 = document.getElementById('enamorado2').value;
            
            if (!e1 || !e2 || e1 === e2) {
                alert('Debes elegir 2 jugadores diferentes');
                return;
            }
            
            await database.ref(`rooms/${roomCode}`).update({
                enamorados: [e1, e2],
                [`players/${e1}/enamorado`]: true,
                [`players/${e2}/enamorado`]: true
            });
            
            alert('Enamorados elegidos!');
        }

        async function submitLoboKill(roomCode, playerName) {
            const victim = document.getElementById('loboVictimSelect').value;
            
            if (!victim) {
                alert('Debes elegir una v√≠ctima');
                return;
            }
            
            await database.ref(`rooms/${roomCode}`).update({
                nightVictim: victim,
                [`nightActions/loboVictim`]: victim
            });
            
            alert('V√≠ctima elegida! El moderador avanzar√° al siguiente turno.');
        }

        async function submitLoboAlfaConvert(roomCode) {
            const target = document.getElementById('loboAlfaConvertSelect').value;
            
            if (target) {
                await database.ref(`rooms/${roomCode}`).update({
                    [`players/${target}/role`]: 'lobo',
                    [`players/${target}/converted`]: true,
                    loboAlfaUsed: true,
                    [`nightActions/loboAlfaConverted`]: target
                });
                alert(`Has convertido a ${target} en lobo!`);
            } else {
                await database.ref(`rooms/${roomCode}/nightActions/loboAlfaConverted`).set('nadie');
                alert('No has convertido a nadie.');
            }
        }

        async function submitVidenteAction(roomCode) {
            const target = document.getElementById('videnteTargetSelect').value;
            
            if (!target) {
                alert('Debes elegir un jugador');
                return;
            }
            
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            const targetRole = room.players[target].role;
            
            await database.ref(`rooms/${roomCode}/nightActions`).update({
                vidente: target,
                videnteResult: { target, role: targetRole }
            });
        }

        async function submitGuardianAction(roomCode) {
            const target = document.getElementById('guardianProtectSelect').value;
            
            if (!target) {
                alert('Debes elegir un jugador');
                return;
            }
            
            await database.ref(`rooms/${roomCode}`).update({
                lastProtected: target,
                [`nightActions/guardianProtect`]: target
            });
            
            alert(`Has protegido a ${target}!`);
        }

        async function submitBrujaAction(roomCode, action, target) {
            if (action === 'save') {
                await database.ref(`rooms/${roomCode}`).update({
                    [`nightActions/brujaSave`]: target,
                    [`usedPotions/save`]: true
                });
                alert('Has salvado a ' + target + '!');
            } else if (action === 'pass') {
                alert('Has pasado tu turno.');
            }
        }

        async function submitBrujaKillAction(roomCode) {
            const target = document.getElementById('brujaKillSelect').value;
            
            if (target) {
                await database.ref(`rooms/${roomCode}`).update({
                    [`nightActions/brujaKill`]: target,
                    [`usedPotions/kill`]: true
                });
                alert('Has usado la poci√≥n de muerte en ' + target + '!');
            } else {
                alert('No has usado la poci√≥n de muerte.');
            }
        }

        async function submitCazadorKill(roomCode) {
            const target = document.getElementById('cazadorVictimSelect').value;
            
            if (!target) {
                alert('Debes elegir a qui√©n llevarte');
                return;
            }
            
            await database.ref(`rooms/${roomCode}`).update({
                [`players/${target}/alive`]: false,
                cazadorPending: null
            });
            
            alert('Te has llevado a ' + target + ' contigo!');
        }

        async function resolveDayVote(roomCode) {
            const victim = document.getElementById('dayVictimSelect').value;
            
            if (!victim) {
                alert('Debes seleccionar un jugador o "nadie"');
                return;
            }
            
            if (victim === 'nadie') {
                // Empate o decisi√≥n del pueblo: pasar a noche sin eliminar a nadie
                const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
                const room = snapshot.val();
                
                await database.ref(`rooms/${roomCode}`).update({
                    phase: 'night',
                    dayCount: room.dayCount + 1,
                    dayVotes: {},
                    currentNightTurn: null
                });
            } else {
                const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
                const room = snapshot.val();
                
                const updates = {
                    [`players/${victim}/alive`]: false,
                    phase: 'night',
                    dayCount: room.dayCount + 1,
                    dayVotes: {},
                    currentNightTurn: null
                };
                
                // Si muere un enamorado, el otro tambi√©n
                if (room.enamorados && room.enamorados.includes(victim)) {
                    const otherEnamorado = room.enamorados.find(e => e !== victim);
                    if (otherEnamorado && room.players[otherEnamorado].alive) {
                        updates[`players/${otherEnamorado}/alive`] = false;
                    }
                }
                
                // Si es el cazador, activar su poder
                if (room.players[victim].role === 'cazador') {
                    updates.cazadorPending = victim;
                    updates.phase = 'day'; // Mantener en d√≠a hasta que el cazador elija
                }
                
                await database.ref(`rooms/${roomCode}`).update(updates);
            }
        }

        // ============================================
        // TIME'S UP - L√≥gica completa del juego
        // ============================================

        let timesUpInterval = null;

        function playTimesUp(roomCode, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'timesup');
            updateGamePlayerStatus(roomCode);

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const player = room.players[playerName];
                if (!player) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s registrado en esta partida</p>';
                    return;
                }

                const isRepresentative = player.representative;
                const myTeam = player.team;
                // Obtener jugadores del equipo que EST√Å jugando su turno ahora
                const currentTeamPlayers = room.currentTeam === 'A' ? room.teamAPlayers : room.teamBPlayers;
                const currentPlayerName = currentTeamPlayers[room.currentPlayerIndex % currentTeamPlayers.length];
                const isMyTurn = currentPlayerName === playerName;
                const isMyTeamTurn = room.currentTeam === myTeam;

                // Detectar fin de juego
                if (room.currentRound > 3) {
                    const winner = room.teamAScore > room.teamBScore ? 'A' : (room.teamBScore > room.teamAScore ? 'B' : 'EMPATE');
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: ${winner === 'A' ? '#ff6b6b' : winner === 'B' ? '#4dabf7' : '#ffc107'}; color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">${winner === 'EMPATE' ? '¬°EMPATE!' : '¬°Equipo ' + winner + ' GANA!'}</h1>
                            <p style="margin-top: 20px;">Equipo A: ${room.teamAScore} | Equipo B: ${room.teamBScore}</p>
                        </div>
                    `;
                    if (timesUpInterval) {
                        clearInterval(timesUpInterval);
                        timesUpInterval = null;
                    }
                    return;
                }

                const roundNames = ['', 'Descripci√≥n', 'Una Palabra', 'M√≠mica'];
                const isPlaying = room.timerActive;

                let html = `
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">‚è±Ô∏è Time's Up</h2>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                        <strong>Ronda ${room.currentRound}: ${roundNames[room.currentRound]}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                        <div style="background: #ff6b6b; color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;">
                            Equipo A: ${room.teamAScore}
                        </div>
                        <div style="background: #4dabf7; color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;">
                            Equipo B: ${room.teamBScore}
                        </div>
                    </div>
                `;

                if (isPlaying) {
                    const currentWord = room.words[room.currentWordIndex];

                    html += `
                        <div style="background: ${isMyTurn ? '#fffbea' : '#f8f9fa'}; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 15px; border: 3px solid ${isMyTurn ? '#ffc107' : '#e0e0e0'};">
                            <div style="font-size: 48px; font-weight: bold; margin: 20px 0;">‚è±Ô∏è ${room.timeRemaining}s</div>
                            ${isMyTurn ? `
                                <div style="font-size: 32px; font-weight: bold; color: #667eea; margin: 20px 0; padding: 20px; background: white; border-radius: 10px;">
                                    ${currentWord}
                                </div>
                                <div class="info">T√∫ describes/act√∫as. Tu equipo adivina (en persona).</div>
                            ` : (isMyTeamTurn ? `
                                <p style="font-size: 18px;"><strong>Turno de:</strong> ${currentPlayerName}</p>
                                <p style="color: #667eea;">üëÇ Tu equipo est√° adivinando...</p>
                            ` : `
                                <p style="font-size: 18px;"><strong>Turno de equipo ${room.currentTeam}</strong></p>
                                <p style="color: #999;">Esperando su turno...</p>
                            `)}
                        </div>
                    `;

                    // Bot√≥n solo para representante del equipo que est√° jugando su turno
                    if (isRepresentative && isMyTeamTurn) {
                        html += `
                            <div style="display: grid; gap: 10px; grid-template-columns: 1fr 1fr;">
                                <div class="btn" onclick="markTimesUpCorrect('${roomCode}')">‚úÖ ACERT√ì</div>
                                <div class="btn btn-secondary" onclick="skipTimesUpWord('${roomCode}')">‚è≠Ô∏è PASAR</div>
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                            <p style="font-size: 18px;"><strong>Turno de equipo ${room.currentTeam}</strong></p>
                            <p>Jugador activo: ${currentPlayerName}</p>
                            ${currentPlayerName === playerName ? '<div class="btn" onclick="startTimesUpTurn(\'' + roomCode + '\')">‚ñ∂Ô∏è Iniciar Turno (30s)</div>' : '<p style="color: #666;">Esperando...</p>'}
                        </div>
                    `;
                }

                gameContent.innerHTML = html;

                // Gestionar temporizador
                if (isPlaying) {
                    if (!timesUpInterval) {
                        timesUpInterval = setInterval(() => {
                            database.ref(`rooms/${roomCode}`).once('value').then(snap => {
                                const r = snap.val();
                                if (r && r.timerActive && r.timeRemaining > 0) {
                                    database.ref(`rooms/${roomCode}/timeRemaining`).set(r.timeRemaining - 1);
                                } else if (r && r.timeRemaining <= 0) {
                                    endTimesUpTurn(roomCode);
                                }
                            });
                        }, 1000);
                    }
                } else {
                    if (timesUpInterval) {
                        clearInterval(timesUpInterval);
                        timesUpInterval = null;
                    }
                }
            });

            showScreen('gameScreen');
        }

        async function startTimesUpTurn(roomCode) {
            await database.ref(`rooms/${roomCode}`).update({
                timerActive: true,
                timeRemaining: 30
            });
        }

        async function markTimesUpCorrect(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();

            const scoreField = room.currentTeam === 'A' ? 'teamAScore' : 'teamBScore';
            const newWordIndex = room.currentWordIndex + 1;

            if (newWordIndex >= room.words.length) {
                // Siguiente ronda
                await database.ref(`rooms/${roomCode}`).update({
                    currentRound: room.currentRound + 1,
                    currentWordIndex: 0,
                    currentTeam: 'A',
                    currentPlayerIndex: 0,
                    timerActive: false,
                    timeRemaining: 30,
                    [scoreField]: room[scoreField] + 1
                });
            } else {
                await database.ref(`rooms/${roomCode}`).update({
                    currentWordIndex: newWordIndex,
                    [scoreField]: room[scoreField] + 1
                });
            }
        }

        async function skipTimesUpWord(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();

            const newWordIndex = room.currentWordIndex + 1;

            if (newWordIndex >= room.words.length) {
                // Siguiente ronda sin sumar puntos
                await database.ref(`rooms/${roomCode}`).update({
                    currentRound: room.currentRound + 1,
                    currentWordIndex: 0,
                    currentTeam: 'A',
                    currentPlayerIndex: 0,
                    timerActive: false,
                    timeRemaining: 30
                });
            } else {
                // Siguiente palabra sin sumar puntos
                await database.ref(`rooms/${roomCode}/currentWordIndex`).set(newWordIndex);
            }
        }

        async function endTimesUpTurn(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();

            const currentTeamPlayers = room.currentTeam === 'A' ? room.teamAPlayers : room.teamBPlayers;
            const nextPlayerIndex = room.currentPlayerIndex + 1;
            const nextTeam = room.currentTeam === 'A' ? 'B' : 'A';

            if (nextPlayerIndex >= currentTeamPlayers.length) {
                // Cambiar de equipo
                await database.ref(`rooms/${roomCode}`).update({
                    currentTeam: nextTeam,
                    currentPlayerIndex: 0,
                    timerActive: false,
                    timeRemaining: 30
                });
            } else {
                await database.ref(`rooms/${roomCode}`).update({
                    currentPlayerIndex: nextPlayerIndex,
                    timerActive: false,
                    timeRemaining: 30
                });
            }

            if (timesUpInterval) {
                clearInterval(timesUpInterval);
                timesUpInterval = null;
            }
        }

        // ============================================
        // QUICK STOP - Nueva mec√°nica con letras
        // ============================================

        function generateLetterPool() {
            // Letras con puntos (inspirado en Scrabble)
            const letterData = [
                { letter: 'A', points: 1, count: 12 },
                { letter: 'E', points: 1, count: 12 },
                { letter: 'O', points: 1, count: 9 },
                { letter: 'I', points: 1, count: 6 },
                { letter: 'S', points: 1, count: 6 },
                { letter: 'N', points: 1, count: 5 },
                { letter: 'L', points: 1, count: 4 },
                { letter: 'R', points: 1, count: 5 },
                { letter: 'U', points: 1, count: 5 },
                { letter: 'T', points: 1, count: 4 },
                { letter: 'D', points: 2, count: 5 },
                { letter: 'G', points: 2, count: 2 },
                { letter: 'C', points: 3, count: 4 },
                { letter: 'B', points: 3, count: 2 },
                { letter: 'M', points: 3, count: 2 },
                { letter: 'P', points: 3, count: 2 },
                { letter: 'H', points: 4, count: 2 },
                { letter: 'F', points: 4, count: 1 },
                { letter: 'V', points: 4, count: 1 },
                { letter: 'Y', points: 4, count: 1 },
                { letter: 'Q', points: 5, count: 1 },
                { letter: 'J', points: 8, count: 1 },
                { letter: '√ë', points: 8, count: 1 },
                { letter: 'X', points: 8, count: 1 },
                { letter: 'Z', points: 10, count: 1 }
            ];
            
            const pool = [];
            letterData.forEach(({ letter, points, count }) => {
                for (let i = 0; i < count; i++) {
                    pool.push({ letter, points });
                }
            });
            
            shuffleArray(pool);
            return pool;
        }

        const QUICK_STOP_PROMPTS = [
            'Algo que encuentras en la cocina',
            'Un animal',
            'Una ciudad o pa√≠s',
            'Una profesi√≥n',
            'Algo que llevas en la mochila',
            'Un deporte',
            'Una comida o bebida',
            'Algo que ves en el cielo',
            'Un color',
            'Una parte del cuerpo',
            'Un objeto de la casa',
            'Una marca famosa',
            'Un instrumento musical',
            'Una pel√≠cula o serie',
            'Un juego o videojuego',
            'Algo que tiene ruedas',
            'Un lugar p√∫blico',
            'Una prenda de ropa',
            'Un √°rbol o planta',
            'Un sentimiento o emoci√≥n',
            'Algo fr√≠o',
            'Algo que huele bien',
            'Un tipo de transporte',
            'Una herramienta',
            'Un mueble',
            'Algo electr√≥nico',
            'Un nombre de persona',
            'Algo que usas para escribir',
            'Un tipo de m√∫sica',
            'Algo que est√° en el ba√±o'
        ];

        function playQuickStop(roomCode, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'quickstop');
            updateGamePlayerStatus(roomCode);

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                // Si el jugador no existe, crearlo con una mano vac√≠a (puede ser una sala antigua)
                if (!room.players[playerName]) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s registrado en esta partida. Esta sala fue creada con una versi√≥n antigua del juego.</p>';
                    return;
                }
                
                const player = room.players[playerName];
                if (!player.hand) {
                    gameContent.innerHTML = '<p style="color: red;">Error: El jugador no tiene letras asignadas. Crea una nueva sala.</p>';
                    return;
                }

                // Detectar fin de juego
                const playersWithLetters = Object.keys(room.players).filter(p => room.players[p].hand && room.players[p].hand.length > 0);
                if (playersWithLetters.length === 0 || (room.phase === 'finished')) {
                    const playerScores = Object.keys(room.players).map(p => ({
                        name: p,
                        points: room.players[p].hand.reduce((sum, l) => sum + l.points, 0)
                    })).sort((a, b) => a.points - b.points);
                    
                    const winner = playerScores[0];
                    
                    let html = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">¬°${winner.name.toUpperCase()} GANA!</h1>
                            <p style="margin-top: 20px;">Puntos finales: ${winner.points}</p>
                        </div>
                        <h3>Clasificaci√≥n final:</h3>
                    `;
                    
                    playerScores.forEach((p, index) => {
                        html += `
                            <div style="background: ${index === 0 ? '#ffd700' : '#e7f3ff'}; padding: 15px; border-radius: 8px; margin: 5px 0; font-weight: bold;">
                                ${index + 1}. ${p.name} - ${p.points} puntos
                            </div>
                        `;
                    });
                    
                    gameContent.innerHTML = html;
                    return;
                }

                let html = `<h2 style="text-align: center; color: #667eea;">üèÉ Quick Stop</h2>`;
                
                // Mano del jugador
                html += '<h3>Tu mano:</h3><div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">';
                if (player.hand && player.hand.length > 0) {
                    player.hand.forEach((letterObj, index) => {
                    html += `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; min-width: 60px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 32px; font-weight: bold;">${letterObj.letter}</div>
                            <div style="font-size: 12px; opacity: 0.8;">${letterObj.points} pts</div>
                        </div>
                    `;
                    });
                } else {
                    html += '<p style="color: #999;">No tienes letras en tu mano.</p>';
                }
                html += '</div>';

                if (room.phase === 'waiting') {
                    html += `
                        <div style="text-align: center; padding: 40px;">
                            <p style="font-size: 18px;">Esperando que comience la ronda...</p>
                            ${Object.keys(room.players)[0] === playerName ?
                            '<div class="btn" onclick="startQuickStopRound(\'' + roomCode + '\')">üé≤ Iniciar Ronda</div>' :
                            '<p style="color: #666;">El primer jugador iniciar√° la ronda</p>'}
                        </div>
                    `;
                } else if (room.phase === 'playing') {
                    if (!player.hand || player.hand.length === 0) {
                        html += '<div class="info">Ya no tienes letras. Esperando que termine la ronda...</div>';
                        gameContent.innerHTML = html;
                        return;
                    }
                    
                    const currentLetter = player.hand[0]; // Primera letra de la mano
                    const hasAnswered = room.roundAnswers && room.roundAnswers[playerName];
                    
                    html += `
                        <div style="background: #fffbea; padding: 20px; border-radius: 10px; margin: 20px 0; border: 3px solid #ffc107;">
                            <h3 style="text-align: center; margin-bottom: 10px;">Tema:</h3>
                            <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 15px;">
                                ${room.currentPrompt}
                            </div>
                            <div style="text-align: center; margin: 15px 0;">
                                <div style="font-size: 18px; margin-bottom: 10px;">Tu letra:</div>
                                <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; font-size: 48px; font-weight: bold;">
                                    ${currentLetter.letter}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (!hasAnswered) {
                        html += `
                            <label>Tu palabra (debe empezar con ${currentLetter.letter}):</label>
                            <input type="text" id="quickstopAnswer" placeholder="Escribe tu palabra..." style="text-transform: uppercase;">
                            <div class="btn" onclick="submitQuickStopAnswer('${roomCode}', '${playerName}', '${currentLetter.letter}')">‚úÖ Enviar Palabra</div>
                        `;
                    } else {
                        html += `
                            <div class="info">‚úÖ Has enviado: <strong>${room.roundAnswers[playerName]}</strong><br>Esperando a los dem√°s jugadores...</div>
                        `;
                    }
                    
                    // Mostrar qui√©n ha respondido
                    const totalPlayers = Object.keys(room.players).filter(p => room.players[p].hand.length > 0).length;
                    const answeredCount = Object.keys(room.roundAnswers || {}).length;
                    html += `<p style="text-align: center; margin-top: 15px; color: #666;">Respuestas: ${answeredCount}/${totalPlayers}</p>`;
                    
                } else if (room.phase === 'results') {
                    html += `
                        <h3 style="text-align: center; color: #ff6b6b;">‚è±Ô∏è Resultado de la ronda</h3>
                        <div style="background: #ff6b6b; color: white; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0;">
                            <h2>¬°${room.lastLoser} fue el √∫ltimo!</h2>
                            <p style="margin-top: 10px;">Pierde esta ronda</p>
                        </div>
                    `;
                    
                    html += '<h4>Respuestas de todos:</h4>';
                    Object.entries(room.roundAnswers || {}).forEach(([pName, answer]) => {
                        const isLoser = pName === room.lastLoser;
                        html += `
                            <div style="background: ${isLoser ? '#ffebee' : '#e7f3ff'}; padding: 12px; border-radius: 8px; margin: 5px 0; border-left: 4px solid ${isLoser ? '#ff6b6b' : '#667eea'};">
                                <strong>${pName}:</strong> ${answer} ${isLoser ? '‚ùå' : '‚úÖ'}
                            </div>
                        `;
                    });
                    
                    if (Object.keys(room.players)[0] === playerName) {
                        html += '<div class="btn" onclick="continueQuickStop(\'' + roomCode + '\')">Continuar</div>';
                    } else {
                        html += '<p style="text-align: center; color: #666; margin-top: 15px;">Esperando al primer jugador...</p>';
                    }
                }

                gameContent.innerHTML = html;
            });

            showScreen('gameScreen');
        }

        async function startQuickStopRound(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            
            // Verificar que todos tengan letras
            const playersWithLetters = Object.keys(room.players).filter(p => room.players[p].hand && room.players[p].hand.length > 0);
            if (playersWithLetters.length === 0) {
                alert('No hay jugadores con letras. El juego ha terminado.');
                await database.ref(`rooms/${roomCode}/phase`).set('finished');
                return;
            }
            
            const randomPrompt = QUICK_STOP_PROMPTS[Math.floor(Math.random() * QUICK_STOP_PROMPTS.length)];
            
            await database.ref(`rooms/${roomCode}`).update({
                phase: 'playing',
                currentPrompt: randomPrompt,
                roundAnswers: {},
                roundStartTime: Date.now(),
                currentRound: room.currentRound + 1
            });
        }

        async function submitQuickStopAnswer(roomCode, playerName, expectedLetter) {
            const answer = document.getElementById('quickstopAnswer').value.trim().toUpperCase();
            
            if (!answer) {
                alert('Debes escribir una palabra');
                return;
            }
            
            if (!answer.startsWith(expectedLetter)) {
                alert(`La palabra debe empezar con ${expectedLetter}`);
                return;
            }
            
            const timestamp = Date.now();
            
            await database.ref(`rooms/${roomCode}/roundAnswers/${playerName}`).set(answer);
            await database.ref(`rooms/${roomCode}/roundTimestamps/${playerName}`).set(timestamp);
            
            // Verificar si todos han respondido
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            const playersWithLetters = Object.keys(room.players).filter(p => room.players[p].hand && room.players[p].hand.length > 0);
            const answeredCount = Object.keys(room.roundAnswers || {}).length;
            
            if (answeredCount >= playersWithLetters.length) {
                // Todos respondieron, determinar el √∫ltimo
                const timestamps = room.roundTimestamps || {};
                const sortedPlayers = Object.keys(timestamps).sort((a, b) => timestamps[b] - timestamps[a]);
                const lastPlayer = sortedPlayers[0];
                
                // El √∫ltimo pierde su primera letra
                const loserHand = room.players[lastPlayer].hand;
                const removedLetter = loserHand.shift(); // Quitar primera letra
                
                await database.ref(`rooms/${roomCode}`).update({
                    phase: 'results',
                    lastLoser: lastPlayer,
                    [`players/${lastPlayer}/hand`]: loserHand
                });
            }
        }

        async function continueQuickStop(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();
            
            // Verificar si alguien se qued√≥ sin letras
            const playersWithLetters = Object.keys(room.players).filter(p => room.players[p].hand && room.players[p].hand.length > 0);
            
            if (playersWithLetters.length === 0) {
                await database.ref(`rooms/${roomCode}/phase`).set('finished');
            } else {
                await database.ref(`rooms/${roomCode}`).update({
                    phase: 'waiting',
                    roundAnswers: {},
                    roundTimestamps: {},
                    lastLoser: null
                });
            }
        }

        // Utilidades
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderGameHeader(roomCode, gameName) {
            return `
                <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Sala:</div>
                        <div style="font-size: 24px; font-weight: bold; letter-spacing: 3px;">${roomCode}</div>
                    </div>
                    <button onclick="showGameHelp('${gameName}')" style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        ‚ùì Ayuda
                    </button>
                </div>
                <div id="gamePlayerStatus" style="background:#f8f9fa; border:2px dashed #667eea; border-radius:12px; padding:12px; margin-bottom:16px; font-size:13px;"></div>
            `;
        }

        function updateGamePlayerStatus(roomCode) {
            const statusEl = document.getElementById('gamePlayerStatus');
            if (!statusEl) return;

            database.ref('rooms/' + roomCode).once('value', (snapshot) => {
                const room = snapshot.val();
                if (!room || !room.players) {
                    statusEl.innerHTML = '';
                    return;
                }

                const players = Object.keys(room.players);
                const connected = players.filter(p => room.players[p] && room.players[p].joined);
                const missing = players.filter(p => !room.players[p] || !room.players[p].joined);

                if (players.length === 0) {
                    statusEl.innerHTML = '';
                    return;
                }

                let html = '<div style="font-weight:600; color:#667eea; margin-bottom:6px;">üë• Estado de jugadores</div>';
                html += `<div style="margin-bottom:4px;">‚úÖ Conectados: ${connected.length}/${players.length}</div>`;
                
                if (missing.length > 0) {
                    html += `<div style="color:#999;">‚è≥ Faltan: ${missing.join(', ')}</div>`;
                }

                statusEl.innerHTML = html;
            });
        }

        function showGameHelp(gameName) {
            const rules = {
                blanco: `
                    <h3>üé≠ Blanco - Reglas</h3>
                    <p><strong>Objetivo:</strong></p>
                    <ul>
                        <li><strong>Blanco:</strong> Adivinar la palabra secreta sin ser descubierto</li>
                        <li><strong>Otros:</strong> Descubrir qui√©n es el Blanco sin revelar la palabra</li>
                    </ul>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Todos reciben la misma palabra excepto el Blanco</li>
                        <li>Por turnos, cada jugador da una pista sobre su palabra</li>
                        <li>El Blanco debe disimular y dar pistas gen√©ricas</li>
                        <li>Al final, voten qui√©n creen que es el Blanco</li>
                    </ol>
                `,
                lobo: `
                    <h3>üê∫ El Lobo - Reglas</h3>
                    <p><strong>Objetivo:</strong></p>
                    <ul>
                        <li><strong>Lobos:</strong> Eliminar a todos los aldeanos</li>
                        <li><strong>Aldeanos:</strong> Eliminar a todos los lobos</li>
                    </ul>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Los lobos se conocen entre s√≠</li>
                        <li>De d√≠a: todos votan para eliminar a alguien</li>
                        <li><strong>Operatives:</strong> Adivinan palabras basadas en las pistas</li>
                    </ul>
                    <p><strong>Colores:</strong></p>
                    <ul>
                        <li><strong>Rojo/Azul:</strong> Agentes de cada equipo</li>
                        <li><strong>Gris:</strong> Transe√∫ntes inocentes (pierdes el turno)</li>
                        <li><strong>Negro:</strong> Asesino (üí• pierdes instant√°neamente)</li>
                    </ul>
                    <p><strong>Spymaster clickea las palabras</strong> que elijan los operatives para revelarlas.</p>
            `,
                quickstop: `
                    <h3>üèÉ Quick Stop - Reglas</h3>
                    <p><strong>Objetivo:</strong> Ser el primero en quedarte sin letras</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Cada jugador empieza con 5 letras en su mano (cada letra tiene puntos)</li>
                        <li>Se muestra un tema com√∫n para todos</li>
                        <li>Cada jugador ve solo su primera letra</li>
                        <li>Escribe UNA palabra que empiece con tu letra y responda al tema</li>
                        <li>El √∫ltimo en enviar su palabra PIERDE y elimina esa letra de su mano</li>
                        <li>El juego contin√∫a hasta que alguien se quede sin letras</li>
                    </ol>
                    <p><strong>Ganador:</strong> Quien se queda sin letras primero. El resto suma los puntos de sus letras restantes.</p>
                    <p><strong>Ejemplos de temas:</strong> Un animal, Algo que encuentras en la cocina, Una ciudad, Un deporte, etc.</p>
            `,
                loveletter: `
                < h3 >üíå Love Letter - Reglas</h3 >
                    <p><strong>Objetivo:</strong> S√© el √∫ltimo en pie o termina con la carta m√°s alta</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Cada turno: roba 1 carta y juega 1 carta</li>
                        <li>Cada carta tiene un efecto especial</li>
                        <li>Gana la ronda el √∫ltimo jugador o quien tenga la carta m√°s alta</li>
                        <li>Primer jugador en alcanzar los puntos objetivo gana</li>
                    </ol>
                    <p><strong>Cartas:</strong></p>
                    <ul style="font-size: 13px;">
                        <li><strong>1-Guardia:</strong> Adivina la carta de un jugador</li>
                        <li><strong>2-Sacerdote:</strong> Mira la carta de un jugador</li>
                        <li><strong>3-Bar√≥n:</strong> Compara cartas, el menor se elimina</li>
                        <li><strong>4-Doncella:</strong> Protecci√≥n hasta tu pr√≥ximo turno</li>
                        <li><strong>5-Pr√≠ncipe:</strong> Un jugador descarta y roba</li>
                        <li><strong>6-Rey:</strong> Intercambia cartas con otro jugador</li>
                        <li><strong>7-Condesa:</strong> Debes jugarla si tienes Rey o Pr√≠ncipe</li>
                        <li><strong>8-Princesa:</strong> Si la descartas, quedas eliminado</li>
                    </ul>
            `,
                timesup: `
                < h3 >‚è±Ô∏è Time's Up - Reglas</h3>
                    < p > <strong>Objetivo:</strong> Adivinar el m√°ximo de palabras posible en 3 rondas distintas</p >
                    <p><strong>3 Rondas con las MISMAS palabras:</strong></p>
                    <ol>
                        <li><strong>Ronda 1 - Descripci√≥n:</strong> Puedes describir con todas las palabras que quieras</li>
                        <li><strong>Ronda 2 - Una palabra:</strong> Solo UNA palabra de pista</li>
                        <li><strong>Ronda 3 - M√≠mica:</strong> Solo gestos y sonidos, sin hablar</li>
                    </ol>
                    <p><strong>Turnos:</strong></p>
                    <ul>
                        <li>30 segundos por jugador</li>
                        <li>El jugador activo ve la palabra y la describe/act√∫a</li>
                        <li>Su equipo adivina (en persona, no en app)</li>
                        <li><strong>Representantes marcan aciertos</strong> con el bot√≥n</li>
                        <li>Si no marcas antes de que acabe el tiempo, se considera fallo</li>
                    </ul>
                    <p>El equipo con m√°s aciertos despu√©s de las 3 rondas gana.</p>
            `,
                overunder: `
                < h3 >üìä Over / Under - Reglas</h3 >
                    <p><strong>Objetivo:</strong> Acertar si la respuesta es mayor o menor.</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Se presenta una pregunta con respuesta num√©rica.</li>
                        <li>Se da un n√∫mero de referencia.</li>
                        <li>Apuesta si la respuesta real es M√ÅS (+) o MENOS (-) que la referencia.</li>
                        <li>Gana puntos por cada acierto.</li>
                    </ol>
            `,
                spyfall: `
                <h3>üïµÔ∏è Spyfall - Reglas</h3>
                    <p><strong>Objetivo:</strong></p>
                    <ul>
                        <li><strong>Esp√≠a:</strong> Adivinar la ubicaci√≥n secreta.</li>
                        <li><strong>No Esp√≠as:</strong> Descubrir qui√©n es el esp√≠a sin revelar demasiado.</li>
                    </ul>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Todos los jugadores est√°n en la misma ubicaci√≥n, excepto el Esp√≠a.</li>
                        <li>Por turnos, los jugadores se hacen preguntas entre s√≠.</li>
                        <li>No se√°is demasiado espec√≠ficos (el esp√≠a os escucha) ni demasiado vagos (parecer√©is sospechosos).</li>
                        <li>En cualquier momento, pod√©is votar para acusar a alguien de ser el esp√≠a.</li>
                        <li>El esp√≠a gana si adivina la ubicaci√≥n correcta o si no es descubierto.</li>
                    </ol>
                    <p><strong>Ejemplos de preguntas:</strong></p>
                    <ul style="font-size: 13px;">
                        <li>"¬øVienes aqu√≠ a menudo?"</li>
                        <li>"¬øCu√°ndo fue la √∫ltima vez que estuviste aqu√≠?"</li>
                        <li>"¬øQu√© haces normalmente cuando est√°s aqu√≠?"</li>
                        <li>"¬øHay mucha gente normalmente?"</li>
                        <li>"¬øEs este un buen sitio para ni√±os?"</li>
                        <li>"¬øSe puede comer aqu√≠?"</li>
                        <li>"¬øCu√°l es tu parte favorita de este lugar?"</li>
                    </ul>
            `,
                espectro: `
                <h3>üåà Espectro Mental - Reglas</h3>
                    <p><strong>Objetivo:</strong> Interpretar una pista y colocar el marcador lo m√°s cerca posible de la posici√≥n secreta en un espectro de conceptos opuestos.</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>El sistema elige un par de conceptos opuestos (por ejemplo: "fr√≠o ‚Äì caliente").</li>
                        <li>El sistema genera una posici√≥n secreta del 1 al 100 y solo el Gu√≠a la ve.</li>
                        <li>El Gu√≠a da UNA √∫nica pista (palabra o concepto) que represente ese punto del espectro.</li>
                        <li>El resto de jugadores coloca su estimaci√≥n moviendo el deslizador del 1 al 100.</li>
                        <li>Cuando todos han enviado su porcentaje, se revela la posici√≥n real y qui√©n se ha acercado m√°s.</li>
                    </ol>
                    <p><strong>Modos:</strong></p>
                    <ul>
                        <li><strong>Por equipos:</strong> se suman puntos al equipo seg√∫n la distancia media de sus jugadores.</li>
                        <li><strong>Todos contra todos:</strong> cada jugador gana puntos individualmente seg√∫n su distancia.</li>
                        <li><strong>Cooperativo:</strong> el grupo comparte una puntuaci√≥n total basada en la mejor aproximaci√≥n de cada ronda.</li>
                    </ul>
                    <p>El sistema otorga m√°s puntos cuanto m√°s cerca est√© la estimaci√≥n de la posici√≥n secreta.</p>
            `,
                conexion: `
                < h3 >üß† Conexi√≥n Mental - Reglas</h3 >
                    <p><strong>Objetivo:</strong> Completar todos los niveles jugando cartas en orden.</p>
                    <p><strong>Regla de ORO:</strong> ü§´ SILENCIO ABSOLUTO. No hablar, no hacer se√±as.</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Ten√©is cartas del 1 al 100.</li>
                        <li>Deb√©is jugarlas en el centro en orden ascendente (1, 5, 12, 40...).</li>
                        <li>No hay turnos. Juega quien crea que tiene la carta m√°s baja.</li>
                        <li>Si alguien juega una carta y t√∫ ten√≠as una menor, perd√©is una vida.</li>
                        <li><strong>Estrella Ninja:</strong> Si todos vot√°is s√≠, cada uno descarta su carta m√°s baja.</li>
                    </ol>
            `
            };

            const rule = rules[gameName] || '<p>Reglas no disponibles</p>';
            const helpContent = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; margin: 20px auto;">
                    ${rule}
            <button onclick="document.getElementById('helpOverlay').style.display='none'"
                style="width: 100%; padding: 15px; margin-top: 20px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">
                Cerrar
            </button>
                </div>
            `;

            let overlay = document.getElementById('helpOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'helpOverlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
                document.body.appendChild(overlay);
            }
            overlay.innerHTML = helpContent;
            overlay.style.display = 'flex';
        }

        // ============================================
        // TIME'S UP - Generador de palabras
        // ============================================

        function generateTimesUpWords(count) {
            const allWords = [
                // Personas famosas
                'Brad Pitt (actor)', 'Albert Einstein (cient√≠fico)', 'Michael Jackson (cantante)',
                'Marilyn Monroe (actriz)', 'Leonardo DiCaprio (actor)', 'Cleopatra (reina egipcia)',
                'Mozart (compositor)', 'Pablo Picasso (pintor)', 'William Shakespeare (escritor)',
                'Frida Kahlo (pintora)', 'Cristiano Ronaldo (futbolista)', 'Lionel Messi (futbolista)',
                'Michael Jordan (baloncestista)', 'Serena Williams (tenista)', 'Muhammad Ali (boxeador)',
                'Steve Jobs (empresario)', 'Barack Obama (presidente)', 'Nelson Mandela (l√≠der)',

                // Personajes de ficci√≥n
                'Harry Potter (personaje)', 'Batman (superh√©roe)', 'Superman (superh√©roe)',
                'Spider-Man (superh√©roe)', 'James Bond (agente secreto)', 'Sherlock Holmes (detective)',
                'Don Quijote (personaje literario)', 'Romeo y Julieta (obra)', 'Pinocho (personaje)',
                'Cenicienta (cuento)', 'Mickey Mouse (personaje)', 'Buzz Lightyear (personaje)',

                // Monumentos y lugares
                'La Torre Eiffel (monumento)', 'El Big Ben (reloj)', 'La Estatua de la Libertad (monumento)',
                'Las Pir√°mides de Egipto', 'El Coliseo Romano', 'La Gran Muralla China',
                'El Taj Mahal (monumento)', 'La Torre de Pisa (monumento)',

                // Comida
                'Pizza (comida)', 'Sushi (comida)', 'Hamburguesa (comida)', 'Paella (comida)',
                'Tacos (comida)', 'Pasta (comida)', 'Chocolate (comida)', 'Helado (comida)',

                // Marcas y empresas
                'Netflix (plataforma)', 'Facebook (red social)', 'Google (buscador)',
                'Amazon (tienda online)', 'Apple (empresa)', 'Coca-Cola (bebida)',
                'Nike (marca deportiva)', 'McDonald\'s (restaurante)', 'Tesla (coche el√©ctrico)',

                // Pel√≠culas
                'Titanic (pel√≠cula)', 'Star Wars (pel√≠cula)', 'El Padrino (pel√≠cula)',
                'Forrest Gump (pel√≠cula)', 'Matrix (pel√≠cula)', 'El Rey Le√≥n (pel√≠cula)',
                'Jurassic Park (pel√≠cula)', 'E.T. (pel√≠cula)', 'Avatar (pel√≠cula)',

                // Obras de arte
                'La Mona Lisa (cuadro)', 'El Guernica (cuadro)', 'La Noche Estrellada (cuadro)',
                'El Grito (cuadro de Munch)', 'El David (escultura)', 'La √öltima Cena (cuadro)',

                // Ciudades
                'Par√≠s (ciudad)', 'Nueva York (ciudad)', 'Tokio (ciudad)', 'Londres (ciudad)',
                'Roma (ciudad)', 'Barcelona (ciudad)', 'Madrid (ciudad)', 'Berl√≠n (ciudad)',

                // Libros
                'El Quijote (libro)', 'La Biblia (libro)', 'El Principito (libro)',
                'Cien A√±os de Soledad (libro)', '1984 (libro de Orwell)', 'Se√±or de los Anillos (libro)',

                // Animales
                'Perro (animal)', 'Gato (animal)', 'Elefante (animal)', 'Le√≥n (animal)',
                'Delf√≠n (animal)', 'Jirafa (animal)', 'Ping√ºino (animal)', 'Tigre (animal)',

                // Instrumentos musicales
                'Piano (instrumento)', 'Guitarra (instrumento)', 'Viol√≠n (instrumento)',
                'Bater√≠a (instrumento)', 'Trompeta (instrumento)', 'Saxof√≥n (instrumento)',

                // Deportes
                'F√∫tbol (deporte)', 'Baloncesto (deporte)', 'Tenis (deporte)',
                'Golf (deporte)', 'Nataci√≥n (deporte)', 'Boxeo (deporte)'
            ];

            shuffleArray(allWords);
            return allWords.slice(0, count);
        }

        // Inicializaci√≥n
        showHome();
    </script>
</body>

</html>