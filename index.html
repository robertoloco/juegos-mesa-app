<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juegos de Grupo</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Configuraci√≥n de Firebase -->
    <script src="firebase-config.js"></script>

    <!-- L√≥gica de Juegos -->
    <script src="new-games.js"></script>
    <script src="loveletter-implementation.js"></script>
    <script src="conexion-implementation.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .game-select {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .game-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid transparent;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .game-card.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .game-card h3 {
            margin-bottom: 8px;
            font-size: 20px;
        }

        .game-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        label {
            display: block;
            margin-top: 20px;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .code-display {
            background: #f8f9fa;
            border: 3px dashed #667eea;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .code-display .code {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 8px;
            font-family: 'Courier New', monospace;
        }

        .code-display p {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #0c5460;
            font-size: 14px;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #856404;
        }

        .hidden {
            display: none !important;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .board-card {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e0e0e0;
            font-weight: bold;
            font-size: 13px;
            word-break: break-word;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                max-width: 100%;
            }

            h1 {
                font-size: 22px;
            }

            .code-display .code {
                font-size: 36px;
                letter-spacing: 4px;
            }

            .game-board {
                gap: 5px;
            }

            .board-card {
                padding: 8px;
                min-height: 45px;
                font-size: 11px;
            }
        }

        /* Nuevos Estilos Visuales */
        .spyfall-location {
            background: #2d3748;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            display: inline-block;
            font-size: 0.9em;
        }

        .conexion-card {
            width: 60px;
            height: 90px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #667eea;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .conexion-card:hover {
            transform: translateY(-5px);
        }

        .codenames-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .codenames-card {
            aspect-ratio: 4/3;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: white;
            border: 2px solid #e2e8f0;
            color: #2d3748;
        }

        .codenames-card.revealed {
            color: white;
            border: none;
        }

        .codenames-card.rojo {
            background: #fc8181;
        }

        .codenames-card.azul {
            background: #63b3ed;
        }

        .codenames-card.inocente {
            background: #cbd5e0;
            color: #4a5568;
        }

        .codenames-card.asesino {
            background: #1a202c;
            color: white;
        }

        .love-letter-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .love-letter-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .card-number {
            font-size: 2em;
            font-weight: 900;
            color: #e2e8f0;
            position: absolute;
            top: 10px;
            right: 15px;
            line-height: 1;
        }

        .card-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
            position: relative;
        }

        .card-effect {
            font-size: 0.9em;
            color: #718096;
            line-height: 1.4;
            position: relative;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Pantalla Inicial -->
        <div id="homeScreen" class="screen active">
            <h1>üéÆ Juegos de Grupo</h1>
            <p class="subtitle">Selecciona tu modo de juego</p>

            <div class="btn" onclick="showCreateGame()">Crear Nueva Sala</div>
            <div class="btn btn-secondary" onclick="showJoinGame()">Unirse a Sala</div>
        </div>

        <!-- Pantalla: Crear Sala -->
        <div id="createGameScreen" class="screen">
            <h1>Crear Nueva Sala</h1>
            <p class="subtitle">Configura tu juego</p>

            <label>Selecciona el Juego:</label>
            <div class="game-select">
                <div class="game-card" onclick="selectGame('blanco')">
                    <h3>üé≠ Blanco</h3>
                    <p>Todos tienen una palabra excepto el Blanco. ¬°Desc√∫brelo sin revelar tu palabra!</p>
                </div>
                <div class="game-card" onclick="selectGame('lobo')">
                    <h3>üê∫ El Lobo</h3>
                    <p>Aldeanos vs Lobos. Los lobos deben eliminar aldeanos sin ser descubiertos.</p>
                </div>
                <div class="game-card" onclick="selectGame('codigo')">
                    <h3>üîê C√≥digo Secreto</h3>
                    <p>Dos equipos compiten dando pistas para encontrar sus agentes. ¬°Cuidado con el asesino!</p>
                </div>
                <div class="game-card" onclick="selectGame('quickstop')">
                    <h3>üèÉ Quick Stop</h3>
                    <p>Completa categor√≠as con palabras que empiecen con la letra indicada. ¬°El m√°s r√°pido gana!</p>
                </div>
                <div class="game-card" onclick="selectGame('loveletter')">
                    <h3>üíå Love Letter</h3>
                    <p>Juego de deducci√≥n y faroleo. S√© el √∫ltimo en pie o termina con la carta m√°s alta.</p>
                </div>
                <div class="game-card" onclick="selectGame('timesup')">
                    <h3>‚è±Ô∏è Time's Up</h3>
                    <p>3 rondas con las mismas palabras: Describe, Una palabra, M√≠mica. ¬°Contra el tiempo!</p>
                </div>

                <div class="game-card" onclick="selectGame('overunder')">
                    <h3>üìä Over/Under</h3>
                    <p>Adivina si la respuesta es M√ÅS o MENOS. Datos curiosos y apuestas r√°pidas.</p>
                </div>

                <div class="game-card" onclick="selectGame('spyfall')">
                    <h3>üïµÔ∏è Spyfall</h3>
                    <p>Descubre al esp√≠a antes de que √©l descubra la ubicaci√≥n secreta. Roles y enga√±os.</p>
                </div>

                <div class="game-card" onclick="selectGame('conexion')">
                    <h3>üß† Conexi√≥n Mental</h3>
                    <p>Juego cooperativo. Jugad cartas en orden ascendente SIN HABLAR. ¬øPod√©is conectar vuestras mentes?
                    </p>
                </div>
            </div>

            <!-- Configuraci√≥n Blanco -->
            <div id="blancoConfig" class="hidden">
                <label>Palabra Secreta:</label>
                <input type="text" id="secretWord" placeholder="Ej: Pizza">

                <div class="info">
                    üí° Esta palabra la ver√°n todos excepto el jugador "Blanco"
                </div>
            </div>

            <!-- Configuraci√≥n Quick Stop -->
            <div id="quickstopConfig" class="hidden">
                <label>N√∫mero de Rondas:</label>
                <input type="number" id="numRounds" value="5" min="1" max="20">

                <div class="info">
                    üí° Quick Stop no necesita lista de jugadores. Cada uno juega en su dispositivo.
                </div>
            </div>

            <!-- Configuraci√≥n Love Letter -->
            <div id="loveletterConfig" class="hidden">
                <label>Puntos para Ganar:</label>
                <input type="number" id="pointsToWin" value="4" min="2" max="10">

                <div class="info">
                    üí° Cada ronda ganada otorga 1 punto. El primer jugador en alcanzar este n√∫mero gana la partida.
                </div>
            </div>

            <!-- Configuraci√≥n Time's Up -->
            <div id="timesupConfig" class="hidden">
                <label>N√∫mero de Palabras:</label>
                <input type="number" id="numWords" value="40" min="20" max="60">

                <div class="info">
                    üí° Time's Up: Divide jugadores en 2 equipos. Los primeros 2 jugadores de la lista ser√°n los
                    representantes (marcan aciertos).
                </div>
            </div>

            <label>Nombres de Jugadores (separados por coma):</label>
            <textarea id="playerNames" placeholder="Juan, Mar√≠a, Pedro, Ana"></textarea>

            <div class="info">
                ‚ÑπÔ∏è M√≠nimo 3 jugadores para Blanco/Lobo, 4 para C√≥digo Secreto/Time's Up, 2-4 para Love Letter
            </div>

            <div class="btn" onclick="createGame()">Crear Sala</div>
            <div class="btn btn-secondary" onclick="showHome()">Volver</div>
        </div>

        <!-- Pantalla: Sala Creada -->
        <div id="lobbyScreen" class="screen">
            <h1>‚úÖ Sala Creada</h1>

            <div class="code-display">
                <div class="code" id="roomCode">----</div>
                <p>Comparte este c√≥digo con los jugadores</p>
            </div>

            <div class="info">
                üí° Ahora puedes unirte a tu propia sala introduciendo tu nombre y el c√≥digo
            </div>

            <label>Tu Nombre (para unirte):</label>
            <input type="text" id="creatorName" placeholder="Tu nombre">

            <div class="btn" onclick="creatorJoinGame()">Unirme a la Sala</div>
            <div class="btn btn-secondary" onclick="showHome()">Crear Nueva Sala</div>
        </div>

        <!-- Pantalla: Unirse a Sala -->
        <div id="joinGameScreen" class="screen">
            <h1>Unirse a Sala</h1>
            <p class="subtitle">Introduce tus datos</p>

            <label>Tu Nombre:</label>
            <input type="text" id="playerName" placeholder="Tu nombre">

            <label>C√≥digo de Sala:</label>
            <input type="text" id="roomCodeInput" placeholder="Ej: A1B2" maxlength="4"
                style="text-transform: uppercase;">

            <div class="btn" onclick="joinGame()">Entrar al Juego</div>
            <div class="btn btn-secondary" onclick="showHome()">Volver</div>
        </div>

        <!-- Pantalla: Juego Activo -->
        <div id="gameScreen" class="screen">
            <div id="gameHeader"></div>
            <div id="gameContent"></div>
            <div class="btn btn-secondary" onclick="showHome()">Salir</div>
        </div>
    </div>

    <script>
        let selectedGame = null;
        let currentRoom = null;
        let roomRef = null;

        // Navegaci√≥n entre pantallas
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showHome() {
            selectedGame = null;
            currentRoom = null;
            if (roomRef) {
                roomRef.off();
                roomRef = null;
            }
            document.getElementById('playerNames').value = '';
            document.getElementById('secretWord').value = '';
            document.getElementById('playerName').value = '';
            document.getElementById('roomCodeInput').value = '';
            document.getElementById('playerNames').disabled = false;
            showScreen('homeScreen');
        }

        function showCreateGame() {
            showScreen('createGameScreen');
        }

        function showJoinGame() {
            showScreen('joinGameScreen');
        }

        // Selecci√≥n de juego
        function selectGame(game) {
            selectedGame = game;
            document.querySelectorAll('.game-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.game-card').classList.add('selected');

            // Mostrar/ocultar configuraci√≥n espec√≠fica
            document.getElementById('blancoConfig').classList.add('hidden');
            document.getElementById('quickstopConfig').classList.add('hidden');
            document.getElementById('loveletterConfig').classList.add('hidden');
            document.getElementById('timesupConfig').classList.add('hidden');

            if (game === 'blanco') {
                document.getElementById('blancoConfig').classList.remove('hidden');
            } else if (game === 'quickstop') {
                document.getElementById('quickstopConfig').classList.remove('hidden');
            } else if (game === 'loveletter') {
                document.getElementById('loveletterConfig').classList.remove('hidden');
            } else if (game === 'timesup') {
                document.getElementById('timesupConfig').classList.remove('hidden');
            }
            // Nuevos juegos no requieren config extra por ahora

            // Quick Stop no necesita lista de jugadores
            if (game === 'quickstop') {
                document.getElementById('playerNames').value = 'No requerido';
                document.getElementById('playerNames').disabled = true;
            } else {
                document.getElementById('playerNames').disabled = false;
                if (document.getElementById('playerNames').value === 'No requerido') {
                    document.getElementById('playerNames').value = '';
                }
            }
        }

        // Generar c√≥digo de sala √∫nico
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Crear sala
        async function createGame() {
            if (!selectedGame) {
                alert('Por favor selecciona un juego');
                return;
            }

            // Validar jugadores
            let players = [];
            if (selectedGame !== 'quickstop') {
                const playerNamesInput = document.getElementById('playerNames').value.trim();
                if (!playerNamesInput || playerNamesInput === 'No requerido') {
                    alert('Por favor introduce los nombres de los jugadores');
                    return;
                }

                players = playerNamesInput.split(',').map(name => name.trim()).filter(name => name);

                if (players.length < 3 && selectedGame !== 'codigo' && selectedGame !== 'loveletter' && selectedGame !== 'timesup') {
                    alert('Se necesitan m√≠nimo 3 jugadores');
                    return;
                }

                if (players.length < 4 && (selectedGame === 'codigo' || selectedGame === 'timesup')) {
                    alert('C√≥digo Secreto y Time\'s Up necesitan m√≠nimo 4 jugadores (2 por equipo)');
                    return;
                }

                if ((players.length < 2 || players.length > 4) && selectedGame === 'loveletter') {
                    alert('Love Letter necesita entre 2 y 4 jugadores');
                    return;
                }

                if (selectedGame === 'spyfall' && players.length < 3) {
                    alert('Spyfall necesita m√≠nimo 3 jugadores');
                    return;
                }
            }

            if (selectedGame === 'blanco') {
                const secretWord = document.getElementById('secretWord').value.trim();
                if (!secretWord) {
                    alert('Por favor introduce la palabra secreta');
                    return;
                }
            }

            // Generar c√≥digo de sala
            const roomCode = generateRoomCode();

            // Crear sala en Firebase
            const room = {
                code: roomCode,
                game: selectedGame,
                createdAt: Date.now(),
                status: 'waiting'
            };

            // Configurar seg√∫n el juego
            if (selectedGame === 'blanco') {
                room.secretWord = document.getElementById('secretWord').value.trim();
                const blancoIndex = Math.floor(Math.random() * players.length);

                room.players = {};
                players.forEach((name, index) => {
                    room.players[name] = {
                        role: index === blancoIndex ? 'blanco' : 'normal',
                        word: index === blancoIndex ? 'BLANCO' : room.secretWord
                    };
                });
            } else if (selectedGame === 'lobo') {
                const numLobos = Math.max(1, Math.floor(players.length / 4));
                const roles = ['lobo'].concat(Array(players.length - numLobos).fill('aldeano'));
                shuffleArray(roles);

                room.players = {};
                room.moderator = players[0]; // Primer jugador es moderador
                players.forEach((name, index) => {
                    room.players[name] = {
                        role: index === 0 ? 'moderador' : roles[index - 1], // Moderador no juega
                        alive: index === 0 ? true : true
                    };
                });
                room.phase = 'night';
                room.dayCount = 1;
                room.nightVictim = null;
                room.dayVotes = {};
            } else if (selectedGame === 'codigo') {
                room.players = {};
                room.board = generateCodigoSecretoBoard();
                room.currentTeam = 'rojo';

                // Dividir jugadores en equipos
                shuffleArray(players);
                const half = Math.floor(players.length / 2);
                players.forEach((name, index) => {
                    room.players[name] = {
                        team: index < half ? 'rojo' : 'azul',
                        role: index === 0 ? 'spymaster' : (index === half ? 'spymaster' : 'operative')
                    };
                });
            } else if (selectedGame === 'quickstop') {
                room.numRounds = parseInt(document.getElementById('numRounds').value) || 5;
                room.currentRound = 1;
                room.currentLetter = null;
                room.categories = ['Nombre', 'Animal', 'Ciudad', 'Objeto', 'Comida', 'Color'];
                room.players = {};
            } else if (selectedGame === 'loveletter') {
                room.pointsToWin = parseInt(document.getElementById('pointsToWin').value) || 4;
                room.currentRound = 1;
                room.deck = [];
                room.discardPile = [];
                room.currentTurnIndex = 0;
                room.roundInProgress = false;
                room.playerOrder = players;

                room.players = {};
                players.forEach((name) => {
                    room.players[name] = {
                        hand: [],
                        score: 0,
                        eliminated: false,
                        protected: false
                    };
                });
            } else if (selectedGame === 'timesup') {
                const numWords = parseInt(document.getElementById('numWords').value) || 40;
                const words = generateTimesUpWords(numWords);

                // Dividir jugadores en 2 equipos
                const half = Math.ceil(players.length / 2);
                const teamA = players.slice(0, half);
                const teamB = players.slice(half);

                room.words = words;
                room.currentRound = 1; // 1=Describe, 2=Una palabra, 3=M√≠mica
                room.currentTeam = 'A';
                room.teamAScore = 0;
                room.teamBScore = 0;
                room.teamAPlayers = teamA;
                room.teamBPlayers = teamB;
                room.representativeA = teamA[0]; // Primer jugador equipo A marca aciertos
                room.representativeB = teamB[0]; // Primer jugador equipo B marca aciertos
                room.currentPlayerIndex = 0;
                room.currentWordIndex = 0;
                room.timerActive = false;
                room.timeRemaining = 30;
                room.wordsGuessedThisRound = [];

                room.players = {};
                players.forEach((name, index) => {
                    room.players[name] = {
                        team: index < half ? 'A' : 'B',
                        representative: (index === 0 || index === half)
                    };
                });

            } else if (selectedGame === 'overunder') {
                room.currentQuestion = null;
                room.phase = 'waiting';
                room.players = {};
                players.forEach(name => { room.players[name] = { score: 0 }; });
                startOverUnderRound(roomCode); // Pre-cargar primera pregunta
            } else if (selectedGame === 'spyfall') {
                const locKeys = Object.keys(SPYFALL_LOCATIONS);
                const location = locKeys[Math.floor(Math.random() * locKeys.length)];
                const roles = [...SPYFALL_LOCATIONS[location]];

                // Asegurar suficientes roles o repetir gen√©ricos
                while (roles.length < players.length - 1) roles.push('Ciudadano');
                shuffleArray(roles);

                const spyIndex = Math.floor(Math.random() * players.length);

                room.location = location;
                room.timerActive = false;
                room.timeRemaining = 480;
                room.players = {};

                let roleIndex = 0;
                players.forEach((name, index) => {
                    room.players[name] = {
                        role: index === spyIndex ? 'Esp√≠a' : roles[roleIndex++]
                    };
                });
            } else if (selectedGame === 'conexion') {
                room.level = 1;
                room.lives = players.length;
                room.shurikens = 1;
                room.lastCard = 0;
                room.status = 'playing';
                room.shurikenActive = false;

                const deck = Array.from({ length: 100 }, (_, i) => i + 1);
                shuffleArray(deck);

                room.players = {};
                players.forEach(name => {
                    room.players[name] = {
                        hand: [deck.pop()]
                    };
                });
            }

            // Guardar en Firebase
            try {
                await database.ref('rooms/' + roomCode).set(room);
                currentRoom = room;
                displayLobby(roomCode);

                // Auto-eliminar sala despu√©s de 24 horas
                setTimeout(async () => {
                    await database.ref('rooms/' + roomCode).remove();
                }, 24 * 60 * 60 * 1000);
            } catch (error) {
                alert('Error al crear sala: ' + error.message);
            }
        }

        function displayLobby(roomCode) {
            document.getElementById('roomCode').textContent = roomCode;
            document.getElementById('creatorName').value = '';
            showScreen('lobbyScreen');
        }

        // Creador se une a su propia sala
        async function creatorJoinGame() {
            const playerName = document.getElementById('creatorName').value.trim();
            const roomCode = document.getElementById('roomCode').textContent;

            if (!playerName) {
                alert('Por favor introduce tu nombre');
                return;
            }

            // Buscar sala en Firebase
            try {
                const snapshot = await database.ref('rooms/' + roomCode).once('value');
                const room = snapshot.val();

                if (!room) {
                    alert('Error: Sala no encontrada');
                    return;
                }

                currentRoom = room;
                currentRoom.code = roomCode;
                roomRef = database.ref('rooms/' + roomCode);

                // Jugar seg√∫n el tipo de juego
                if (room.game === 'quickstop') {
                    playQuickStop(roomCode, playerName);
                } else if (room.game === 'codigo') {
                    playCodigoSecreto(roomCode, playerName, room);
                } else if (room.game === 'loveletter') {
                    playLoveLetter(roomCode, playerName);
                } else if (room.game === 'blanco') {
                    showRole(room, playerName);
                } else if (room.game === 'lobo') {
                    playLobo(roomCode, playerName);
                } else if (room.game === 'timesup') {
                    playTimesUp(roomCode, playerName);
                } else if (room.game === 'overunder') {
                    playOverUnder(roomCode, playerName);
                } else if (room.game === 'spyfall') {
                    playSpyfall(roomCode, playerName);
                } else if (room.game === 'conexion') {
                    playConexionMental(roomCode, playerName);
                }
            } catch (error) {
                alert('Error al unirse: ' + error.message);
            }
        }

        // Unirse a sala
        async function joinGame() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();

            if (!playerName) {
                alert('Por favor introduce tu nombre');
                return;
            }

            if (!roomCode || roomCode.length !== 4) {
                alert('Por favor introduce un c√≥digo de sala v√°lido');
                return;
            }

            // Buscar sala en Firebase
            try {
                const snapshot = await database.ref('rooms/' + roomCode).once('value');
                const room = snapshot.val();

                if (!room) {
                    alert('Sala no encontrada. Verifica el c√≥digo.');
                    return;
                }

                currentRoom = room;
                currentRoom.code = roomCode;
                roomRef = database.ref('rooms/' + roomCode);

                // Jugar seg√∫n el tipo de juego
                if (room.game === 'quickstop') {
                    playQuickStop(roomCode, playerName);
                } else if (room.game === 'codigo') {
                    playCodigoSecreto(roomCode, playerName, room);
                } else if (room.game === 'loveletter') {
                    playLoveLetter(roomCode, playerName);
                } else if (room.game === 'blanco') {
                    showRole(room, playerName);
                } else if (room.game === 'lobo') {
                    playLobo(roomCode, playerName);
                } else if (room.game === 'timesup') {
                    playTimesUp(roomCode, playerName);
                } else if (room.game === 'overunder') {
                    playOverUnder(roomCode, playerName);
                } else if (room.game === 'spyfall') {
                    playSpyfall(roomCode, playerName);
                } else if (room.game === 'conexion') {
                    playConexionMental(roomCode, playerName);
                }
            } catch (error) {
                alert('Error al unirse: ' + error.message);
            }
        }

        function showRole(room, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            if (!room.players[playerName]) {
                alert('Tu nombre no est√° en la lista de jugadores de esta sala');
                return;
            }

            gameHeader.innerHTML = renderGameHeader(room.code, room.game);
            const player = room.players[playerName];

            if (room.game === 'blanco') {
                if (player.role === 'blanco') {
                    gameContent.innerHTML = `
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 40px; border-radius: 15px; text-align: center;">
                            <h2 style="font-size: 32px; margin-bottom: 15px;">¬°Eres el BLANCO!</h2>
                            <div style="font-size: 40px; font-weight: bold; margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 10px;">‚ùì BLANCO</div>
                            <p>No tienes palabra. Debes adivinar cu√°l es la palabra secreta sin que te descubran.</p>
                            <p>üí° Disimula y trata de integrarte en la conversaci√≥n</p>
                        </div>
                    `;
                } else {
                    gameContent.innerHTML = `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; text-align: center;">
                            <h2 style="font-size: 32px; margin-bottom: 15px;">Tu Palabra es:</h2>
                            <div style="font-size: 40px; font-weight: bold; margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 10px;">${player.word}</div>
                            <p>Hay un jugador que es el BLANCO y no tiene esta palabra.</p>
                            <p>üí° Habla sobre la palabra sin decirla directamente</p>
                        </div>
                    `;
                }
            }

            showScreen('gameScreen');
        }

        // C√≥digo Secreto - Generar tablero
        function generateCodigoSecretoBoard() {
            const words = [
                'Casa', 'Perro', 'Playa', 'Libro', 'Caf√©', 'Luna', 'Piano', 'Reloj', 'Jard√≠n', 'Puente',
                'Monta√±a', 'Estrella', 'Fuego', 'Nube', 'Robot', '√Årbol', 'Mar', 'Luz', 'Sombra', 'Viento',
                'R√≠o', 'Flores', 'Nieve', 'Torre', 'Drag√≥n'
            ];

            shuffleArray(words);
            const board = [];
            const roles = ['rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo', 'rojo',
                'azul', 'azul', 'azul', 'azul', 'azul', 'azul', 'azul', 'azul',
                'inocente', 'inocente', 'inocente', 'inocente', 'inocente', 'inocente', 'inocente',
                'asesino'];
            shuffleArray(roles);

            for (let i = 0; i < 25; i++) {
                board.push({
                    word: words[i],
                    role: roles[i],
                    revealed: false
                });
            }

            return board;
        }

        function playCodigoSecreto(roomCode, playerName, room) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'codigo');

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const player = room.players[playerName];
                if (!player) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s registrado en esta partida</p>';
                    return;
                }

                // Contar agentes por equipo
                let rojoTotal = 0, rojoRevealed = 0;
                let azulTotal = 0, azulRevealed = 0;
                let asesinRevealed = false;
                let gameOver = false;
                let winner = null;

                room.board.forEach(card => {
                    if (card.role === 'rojo') {
                        rojoTotal++;
                        if (card.revealed) rojoRevealed++;
                    } else if (card.role === 'azul') {
                        azulTotal++;
                        if (card.revealed) azulRevealed++;
                    } else if (card.role === 'asesino' && card.revealed) {
                        asesinRevealed = true;
                        // El equipo que revel√≥ el asesino pierde
                        winner = room.currentTeam === 'rojo' ? 'AZUL' : 'ROJO';
                        gameOver = true;
                    }
                });

                // Detectar victoria por completar agentes
                if (rojoRevealed === rojoTotal && !gameOver) {
                    winner = 'ROJO';
                    gameOver = true;
                }
                if (azulRevealed === azulTotal && !gameOver) {
                    winner = 'AZUL';
                    gameOver = true;
                }

                if (gameOver) {
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: ${winner === 'ROJO' ? '#ff6b6b' : '#4dabf7'}; color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">¬°Equipo ${winner} GANA!</h1>
                            ${asesinRevealed ? '<p style="margin-top: 20px;">El otro equipo revel√≥ al ASESINO üí•</p>' : '<p style="margin-top: 20px;">¬°Encontraron todos sus agentes!</p>'}
                        </div>
                        <div class="btn" onclick="location.reload()">Volver al Inicio</div>
                    `;
                    return;
                }

                let html = `
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">üîê C√≥digo Secreto</h2>
                    <div style="background: ${player.team === 'rojo' ? '#fc8181' : '#63b3ed'}; color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <strong>Equipo: ${player.team.toUpperCase()}</strong><br>
                        Rol: ${player.role === 'spymaster' ? 'SPYMASTER' : 'OPERATIVE'}
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                        <div style="background: #fc8181; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            üî¥ Rojo: ${rojoRevealed}/${rojoTotal}
                        </div>
                        <div style="background: #63b3ed; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            üîµ Azul: ${azulRevealed}/${azulTotal}
                        </div>
                    </div>
                    <div class="codenames-grid">
                `;

                room.board.forEach((card, index) => {
                    const showRole = player.role === 'spymaster';
                    const isClickable = player.role === 'spymaster' && !card.revealed;
                    const cursor = isClickable ? 'pointer' : 'default';
                    const onclick = isClickable ? `onclick="revealCodigoCard('${roomCode}', ${index})"` : '';

                    html += `
                        <div class="codenames-card ${card.revealed ? card.role : ''} ${card.revealed ? 'revealed' : ''}" 
                             style="${!card.revealed && showRole ? (card.role === 'rojo' ? 'color: #fc8181; border-color: #fc8181;' : card.role === 'azul' ? 'color: #63b3ed; border-color: #63b3ed;' : card.role === 'asesino' ? 'color: #2d3748; border-color: #2d3748;' : '') : ''}; cursor: ${cursor};" 
                             ${onclick}>
                            ${card.word}
                            ${!card.revealed && showRole ? `<div style="position: absolute; bottom: 2px; right: 2px; width: 8px; height: 8px; border-radius: 50%; background: ${card.role === 'rojo' ? '#fc8181' : card.role === 'azul' ? '#63b3ed' : card.role === 'asesino' ? '#2d3748' : '#cbd5e0'};"></div>` : ''}
                        </div>
                    `;
                });

                html += `</div>
                    <div class="info">
                        ${player.role === 'spymaster' ?
                        'üí° Da pistas de UNA palabra + n√∫mero. <strong>Clickea las palabras</strong> que elijan tus operatives para revelarlas.' :
                        'üí° Escucha a tu spymaster y adivina las palabras de tu equipo. El spymaster revelar√° las palabras.'}
                    </div>
                `;

                gameContent.innerHTML = html;
            });

            showScreen('gameScreen');
        }

        async function revealCodigoCard(roomCode, cardIndex) {
            await database.ref(`rooms/${roomCode}/board/${cardIndex}/revealed`).set(true);
        }

        function playLobo(roomCode, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'lobo');

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const player = room.players[playerName];
                if (!player) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s registrado en esta partida</p>';
                    return;
                }

                const isModerator = player.role === 'moderador';
                const alivePlayers = Object.keys(room.players).filter(p => room.players[p].alive && room.players[p].role !== 'moderador');
                const lobos = Object.keys(room.players).filter(p => room.players[p].role === 'lobo' && room.players[p].alive);
                const aldeanos = Object.keys(room.players).filter(p => room.players[p].role === 'aldeano' && room.players[p].alive);

                // Detectar fin de juego
                if (lobos.length === 0) {
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">¬°ALDEANOS GANAN!</h1>
                            <p style="margin-top: 20px;">Todos los lobos han sido eliminados</p>
                        </div>
                    `;
                    return;
                }
                if (lobos.length >= aldeanos.length) {
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #333; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">¬°LOBOS GANAN!</h1>
                            <p style="margin-top: 20px;">Los lobos han igualado o superado a los aldeanos</p>
                        </div>
                    `;
                    return;
                }

                if (isModerator) {
                    // Vista del moderador
                    let html = `
                        <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">üê∫ El Lobo</h2>
                        <div style="background: #ffc107; color: #333; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                            <strong>üé≠ MODERADOR</strong><br>
                            Fase: ${room.phase === 'night' ? 'üåô NOCHE' : '‚òÄÔ∏è D√çA ' + room.dayCount}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <h3>Jugadores vivos (${alivePlayers.length}):</h3>
                    `;

                    Object.keys(room.players).forEach(p => {
                        const player = room.players[p];
                        if (player.role === 'moderador') return;

                        const roleIcon = player.role === 'lobo' ? 'üê∫' : 'üë•';
                        const status = player.alive ? '‚úÖ' : '‚ùå';

                        html += `
                            <div style="background: ${player.alive ? '#e7f3ff' : '#f8f9fa'}; padding: 12px; border-radius: 8px; margin: 5px 0; border-left: 4px solid ${player.role === 'lobo' ? '#dc3545' : '#667eea'}; opacity: ${player.alive ? 1 : 0.5};">
                                ${status} <strong>${p}</strong> - ${roleIcon} ${player.role.toUpperCase()}
                            </div>
                        `;
                    });

                    html += '</div>';

                    if (room.phase === 'night') {
                        html += `
                            <div class="info">
                                üåô Los lobos eligen a qui√©n eliminar. Confirma la v√≠ctima:
                            </div>
                            <select id="nightVictimSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 2px solid #667eea;">
                                <option value="">Seleccionar v√≠ctima...</option>
                                ${aldeanos.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div class="btn" onclick="confirmNightKill('${roomCode}')">‚úÖ Confirmar Muerte Nocturna</div>
                        `;
                    } else {
                        html += `
                            <div class="info">
                                ‚òÄÔ∏è Los jugadores votan a qui√©n eliminar. Confirma los votos:
                            </div>
                        `;

                        if (Object.keys(room.dayVotes || {}).length > 0) {
                            html += '<h3>Votos actuales:</h3><div style="margin: 10px 0;">';
                            Object.entries(room.dayVotes).forEach(([voter, target]) => {
                                html += `<div style="padding: 8px; background: #f8f9fa; border-radius: 5px; margin: 5px 0;"><strong>${voter}</strong> ‚Üí ${target}</div>`;
                            });
                            html += '</div>';
                        }

                        html += `
                            <select id="dayVictimSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 2px solid #667eea;">
                                <option value="">Seleccionar eliminado...</option>
                                ${alivePlayers.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div class="btn" onclick="confirmDayElimination('${roomCode}')">‚úÖ Confirmar Eliminaci√≥n del D√≠a</div>
                        `;
                    }

                    gameContent.innerHTML = html;
                } else {
                    // Vista de jugador normal
                    const lobosNames = Object.keys(room.players).filter(p => room.players[p].role === 'lobo').join(', ');
                    const isWolf = player.role === 'lobo';

                    let html = `
                        <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">üê∫ El Lobo</h2>
                        <div style="background: ${isWolf ? 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; color: ${isWolf ? '#333' : 'white'}; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 15px;">
                            <h2 style="font-size: 28px; margin-bottom: 10px;">${isWolf ? 'üê∫ Eres un LOBO' : 'üë• Eres un ALDEANO'}</h2>
                            ${isWolf ? `<p><strong>Otros lobos:</strong> ${lobosNames}</p>` : '<p>Debes encontrar y eliminar a los lobos</p>'}
                            ${player.alive ? '' : '<p style="margin-top: 15px; font-weight: bold;">‚ùå EST√ÅS ELIMINADO</p>'}
                        </div>
                        <div style="background: ${room.phase === 'night' ? '#2c3e50' : '#fffbea'}; color: ${room.phase === 'night' ? 'white' : '#333'}; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                            <strong>Fase actual:</strong> ${room.phase === 'night' ? 'üåô NOCHE' : '‚òÄÔ∏è D√çA ' + room.dayCount}
                        </div>
                        <h3>Jugadores vivos:</h3>
                        <div style="margin-bottom: 15px;">
                    `;

                    alivePlayers.forEach(p => {
                        html += `<div style="background: #e7f3ff; padding: 10px; border-radius: 8px; margin: 5px 0;">‚úÖ ${p}</div>`;
                    });

                    html += '</div>';

                    if (player.alive && room.phase === 'day') {
                        html += `
                            <h3>Vota para eliminar:</h3>
                            <select id="voteSelect" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 2px solid #667eea;">
                                <option value="">Seleccionar...</option>
                                ${alivePlayers.filter(p => p !== playerName).map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                            <div class="btn" onclick="submitDayVote('${roomCode}', '${playerName}')">üó≥Ô∏è Enviar Voto</div>
                        `;
                    }

                    if (room.phase === 'night') {
                        html += `<div class="info">üåô El moderador gestiona la fase de noche. Los lobos discuten en privado.</div>`;
                    } else {
                        html += `<div class="info">‚òÄÔ∏è Discutan y voten a qui√©n creen que es un lobo.</div>`;
                    }

                    gameContent.innerHTML = html;
                }
            });

            showScreen('gameScreen');
        }

        async function confirmNightKill(roomCode) {
            const victim = document.getElementById('nightVictimSelect').value;
            if (!victim) {
                alert('Selecciona una v√≠ctima');
                return;
            }

            await database.ref(`rooms/${roomCode}`).update({
                [`players/${victim}/alive`]: false,
                phase: 'day',
                nightVictim: victim,
                dayVotes: {}
            });
        }

        async function confirmDayElimination(roomCode) {
            const victim = document.getElementById('dayVictimSelect').value;
            if (!victim) {
                alert('Selecciona un eliminado');
                return;
            }

            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();

            await database.ref(`rooms/${roomCode}`).update({
                [`players/${victim}/alive`]: false,
                phase: 'night',
                dayCount: room.dayCount + 1,
                dayVotes: {}
            });
        }

        async function submitDayVote(roomCode, playerName) {
            const vote = document.getElementById('voteSelect').value;
            if (!vote) {
                alert('Selecciona un jugador');
                return;
            }

            await database.ref(`rooms/${roomCode}/dayVotes/${playerName}`).set(vote);
            alert('Voto enviado al moderador');
        }

        // ============================================
        // TIME'S UP - L√≥gica completa del juego
        // ============================================

        let timesUpInterval = null;

        function playTimesUp(roomCode, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'timesup');

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const player = room.players[playerName];
                if (!player) {
                    gameContent.innerHTML = '<p style="color: red;">No est√°s registrado en esta partida</p>';
                    return;
                }

                const isRepresentative = player.representative;
                const myTeam = player.team;
                // Obtener jugadores del equipo que EST√Å jugando su turno ahora
                const currentTeamPlayers = room.currentTeam === 'A' ? room.teamAPlayers : room.teamBPlayers;
                const currentPlayerName = currentTeamPlayers[room.currentPlayerIndex % currentTeamPlayers.length];
                const isMyTurn = currentPlayerName === playerName;
                const isMyTeamTurn = room.currentTeam === myTeam;

                // Detectar fin de juego
                if (room.currentRound > 3) {
                    const winner = room.teamAScore > room.teamBScore ? 'A' : (room.teamBScore > room.teamAScore ? 'B' : 'EMPATE');
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÜ FIN DEL JUEGO</h2>
                        <div style="background: ${winner === 'A' ? '#ff6b6b' : winner === 'B' ? '#4dabf7' : '#ffc107'}; color: white; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                            <h1 style="font-size: 48px; margin: 0;">${winner === 'EMPATE' ? '¬°EMPATE!' : '¬°Equipo ' + winner + ' GANA!'}</h1>
                            <p style="margin-top: 20px;">Equipo A: ${room.teamAScore} | Equipo B: ${room.teamBScore}</p>
                        </div>
                    `;
                    if (timesUpInterval) {
                        clearInterval(timesUpInterval);
                        timesUpInterval = null;
                    }
                    return;
                }

                const roundNames = ['', 'Descripci√≥n', 'Una Palabra', 'M√≠mica'];
                const isPlaying = room.timerActive;

                let html = `
                    <h2 style="text-align: center; color: #667eea; margin-bottom: 10px;">‚è±Ô∏è Time's Up</h2>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                        <strong>Ronda ${room.currentRound}: ${roundNames[room.currentRound]}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                        <div style="background: #ff6b6b; color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;">
                            Equipo A: ${room.teamAScore}
                        </div>
                        <div style="background: #4dabf7; color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;">
                            Equipo B: ${room.teamBScore}
                        </div>
                    </div>
                `;

                if (isPlaying) {
                    const currentWord = room.words[room.currentWordIndex];

                    html += `
                        <div style="background: ${isMyTurn ? '#fffbea' : '#f8f9fa'}; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 15px; border: 3px solid ${isMyTurn ? '#ffc107' : '#e0e0e0'};">
                            <div style="font-size: 48px; font-weight: bold; margin: 20px 0;">‚è±Ô∏è ${room.timeRemaining}s</div>
                            ${isMyTurn ? `
                                <div style="font-size: 32px; font-weight: bold; color: #667eea; margin: 20px 0; padding: 20px; background: white; border-radius: 10px;">
                                    ${currentWord}
                                </div>
                                <div class="info">T√∫ describes/act√∫as. Tu equipo adivina (en persona).</div>
                            ` : (isMyTeamTurn ? `
                                <p style="font-size: 18px;"><strong>Turno de:</strong> ${currentPlayerName}</p>
                                <p style="color: #667eea;">üëÇ Tu equipo est√° adivinando...</p>
                            ` : `
                                <p style="font-size: 18px;"><strong>Turno de equipo ${room.currentTeam}</strong></p>
                                <p style="color: #999;">Esperando su turno...</p>
                            `)}
                        </div>
                    `;

                    // Bot√≥n solo para representante del equipo que est√° jugando su turno
                    if (isRepresentative && isMyTeamTurn) {
                        html += `
                            <div style="display: grid; gap: 10px; grid-template-columns: 1fr 1fr;">
                                <div class="btn" onclick="markTimesUpCorrect('${roomCode}')">‚úÖ ACERT√ì</div>
                                <div class="btn btn-secondary" onclick="skipTimesUpWord('${roomCode}')">‚è≠Ô∏è PASAR</div>
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                            <p style="font-size: 18px;"><strong>Turno de equipo ${room.currentTeam}</strong></p>
                            <p>Jugador activo: ${currentPlayerName}</p>
                            ${currentPlayerName === playerName ? '<div class="btn" onclick="startTimesUpTurn(\'' + roomCode + '\')">‚ñ∂Ô∏è Iniciar Turno (30s)</div>' : '<p style="color: #666;">Esperando...</p>'}
                        </div>
                    `;
                }

                gameContent.innerHTML = html;

                // Gestionar temporizador
                if (isPlaying) {
                    if (!timesUpInterval) {
                        timesUpInterval = setInterval(() => {
                            database.ref(`rooms/${roomCode}`).once('value').then(snap => {
                                const r = snap.val();
                                if (r && r.timerActive && r.timeRemaining > 0) {
                                    database.ref(`rooms/${roomCode}/timeRemaining`).set(r.timeRemaining - 1);
                                } else if (r && r.timeRemaining <= 0) {
                                    endTimesUpTurn(roomCode);
                                }
                            });
                        }, 1000);
                    }
                } else {
                    if (timesUpInterval) {
                        clearInterval(timesUpInterval);
                        timesUpInterval = null;
                    }
                }
            });

            showScreen('gameScreen');
        }

        async function startTimesUpTurn(roomCode) {
            await database.ref(`rooms/${roomCode}`).update({
                timerActive: true,
                timeRemaining: 30
            });
        }

        async function markTimesUpCorrect(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();

            const scoreField = room.currentTeam === 'A' ? 'teamAScore' : 'teamBScore';
            const newWordIndex = room.currentWordIndex + 1;

            if (newWordIndex >= room.words.length) {
                // Siguiente ronda
                await database.ref(`rooms/${roomCode}`).update({
                    currentRound: room.currentRound + 1,
                    currentWordIndex: 0,
                    currentTeam: 'A',
                    currentPlayerIndex: 0,
                    timerActive: false,
                    timeRemaining: 30,
                    [scoreField]: room[scoreField] + 1
                });
            } else {
                await database.ref(`rooms/${roomCode}`).update({
                    currentWordIndex: newWordIndex,
                    [scoreField]: room[scoreField] + 1
                });
            }
        }

        async function skipTimesUpWord(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();

            const newWordIndex = room.currentWordIndex + 1;

            if (newWordIndex >= room.words.length) {
                // Siguiente ronda sin sumar puntos
                await database.ref(`rooms/${roomCode}`).update({
                    currentRound: room.currentRound + 1,
                    currentWordIndex: 0,
                    currentTeam: 'A',
                    currentPlayerIndex: 0,
                    timerActive: false,
                    timeRemaining: 30
                });
            } else {
                // Siguiente palabra sin sumar puntos
                await database.ref(`rooms/${roomCode}/currentWordIndex`).set(newWordIndex);
            }
        }

        async function endTimesUpTurn(roomCode) {
            const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
            const room = snapshot.val();

            const currentTeamPlayers = room.currentTeam === 'A' ? room.teamAPlayers : room.teamBPlayers;
            const nextPlayerIndex = room.currentPlayerIndex + 1;
            const nextTeam = room.currentTeam === 'A' ? 'B' : 'A';

            if (nextPlayerIndex >= currentTeamPlayers.length) {
                // Cambiar de equipo
                await database.ref(`rooms/${roomCode}`).update({
                    currentTeam: nextTeam,
                    currentPlayerIndex: 0,
                    timerActive: false,
                    timeRemaining: 30
                });
            } else {
                await database.ref(`rooms/${roomCode}`).update({
                    currentPlayerIndex: nextPlayerIndex,
                    timerActive: false,
                    timeRemaining: 30
                });
            }

            if (timesUpInterval) {
                clearInterval(timesUpInterval);
                timesUpInterval = null;
            }
        }

        // Quick Stop
        function playQuickStop(roomCode, playerName) {
            const gameContent = document.getElementById('gameContent');
            const gameHeader = document.getElementById('gameHeader');

            gameHeader.innerHTML = renderGameHeader(roomCode, 'quickstop');

            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                if (!room.players[playerName]) {
                    database.ref(`rooms/${roomCode}/players/${playerName}`).set({
                        score: 0,
                        answers: {}
                    });
                }

                if (!room.currentLetter) {
                    // Esperando inicio de ronda
                    gameContent.innerHTML = `
                        <h2 style="text-align: center; color: #667eea;">üèÉ Quick Stop</h2>
                        <div style="text-align: center; padding: 40px;">
                            <h3>Ronda ${room.currentRound} de ${room.numRounds}</h3>
                            <p style="margin: 20px 0;">Esperando que comience la ronda...</p>
                            ${Object.keys(room.players)[0] === playerName ?
                            '<div class="btn" onclick="startQuickStopRound()">Iniciar Ronda</div>' :
                            '<p style="color: #666;">El primer jugador iniciar√° la ronda</p>'}
                        </div>
                    `;
                } else {
                    // Jugando
                    let html = `
                        <h2 style="text-align: center; color: #667eea;">üèÉ Quick Stop - Ronda ${room.currentRound}</h2>
                        <div style="background: #667eea; color: white; padding: 30px; border-radius: 15px; text-align: center; margin: 20px 0;">
                            <h1 style="font-size: 72px; margin: 0;">Letra: ${room.currentLetter}</h1>
                        </div>
                        <form onsubmit="submitQuickStopAnswers(event)">
                    `;

                    room.categories.forEach((cat, index) => {
                        html += `
                            <label>${cat}:</label>
                            <input type="text" id="cat_${index}" placeholder="Palabra con ${room.currentLetter}..." required>
                        `;
                    });

                    html += `
                            <div class="btn" onclick="submitQuickStopAnswers(event)">¬°STOP!</div>
                        </form>
                    `;

                    gameContent.innerHTML = html;
                }
            });

            showScreen('gameScreen');
        }

        function startQuickStopRound() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const randomLetter = letters.charAt(Math.floor(Math.random() * letters.length));

            database.ref(`rooms/${currentRoom.code}/currentLetter`).set(randomLetter);
        }

        async function submitQuickStopAnswers(event) {
            event.preventDefault();

            const playerName = document.getElementById('playerName').value.trim();
            const answers = {};

            currentRoom.categories.forEach((cat, index) => {
                answers[cat] = document.getElementById(`cat_${index}`).value.trim();
            });

            await database.ref(`rooms/${currentRoom.code}/players/${playerName}/answers/round${currentRoom.currentRound}`).set(answers);

            alert('¬°Respuestas enviadas! Espera a que todos terminen para ver los resultados.');
        }

        // Utilidades
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderGameHeader(roomCode, gameName) {
            return `
                <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Sala:</div>
                        <div style="font-size: 24px; font-weight: bold; letter-spacing: 3px;">${roomCode}</div>
                    </div>
                    <button onclick="showGameHelp('${gameName}')" style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        ‚ùì Ayuda
                    </button>
                </div>
            `;
        }

        function showGameHelp(gameName) {
            const rules = {
                blanco: `
                    <h3>üé≠ Blanco - Reglas</h3>
                    <p><strong>Objetivo:</strong></p>
                    <ul>
                        <li><strong>Blanco:</strong> Adivinar la palabra secreta sin ser descubierto</li>
                        <li><strong>Otros:</strong> Descubrir qui√©n es el Blanco sin revelar la palabra</li>
                    </ul>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Todos reciben la misma palabra excepto el Blanco</li>
                        <li>Por turnos, cada jugador da una pista sobre su palabra</li>
                        <li>El Blanco debe disimular y dar pistas gen√©ricas</li>
                        <li>Al final, voten qui√©n creen que es el Blanco</li>
                    </ol>
                `,
                lobo: `
                    <h3>üê∫ El Lobo - Reglas</h3>
                    <p><strong>Objetivo:</strong></p>
                    <ul>
                        <li><strong>Lobos:</strong> Eliminar a todos los aldeanos</li>
                        <li><strong>Aldeanos:</strong> Eliminar a todos los lobos</li>
                    </ul>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Los lobos se conocen entre s√≠</li>
                        <li>De d√≠a: todos votan para eliminar a alguien</li>
                        <li><strong>Operatives:</strong> Adivinan palabras basadas en las pistas</li>
                    </ul>
                    <p><strong>Colores:</strong></p>
                    <ul>
                        <li><strong>Rojo/Azul:</strong> Agentes de cada equipo</li>
                        <li><strong>Gris:</strong> Transe√∫ntes inocentes (pierdes el turno)</li>
                        <li><strong>Negro:</strong> Asesino (üí• pierdes instant√°neamente)</li>
                    </ul>
                    <p><strong>Spymaster clickea las palabras</strong> que elijan los operatives para revelarlas.</p>
            `,
                quickstop: `
                < h3 >üèÉ Quick Stop - Reglas</h3 >
                    <p><strong>Objetivo:</strong> Ser el primero en completar todas las categor√≠as</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Se elige una letra aleatoria</li>
                        <li>Completa cada categor√≠a con palabras que empiecen con esa letra</li>
                        <li>El primero en terminar grita "¬°STOP!"</li>
                        <li>Comparan respuestas: √∫nica = 10pts, repetida = 5pts, vac√≠a = 0pts</li>
                    </ol>
                    <p><strong>Categor√≠as:</strong> Nombre, Animal, Ciudad, Objeto, Comida, Color</p>
            `,
                loveletter: `
                < h3 >üíå Love Letter - Reglas</h3 >
                    <p><strong>Objetivo:</strong> S√© el √∫ltimo en pie o termina con la carta m√°s alta</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Cada turno: roba 1 carta y juega 1 carta</li>
                        <li>Cada carta tiene un efecto especial</li>
                        <li>Gana la ronda el √∫ltimo jugador o quien tenga la carta m√°s alta</li>
                        <li>Primer jugador en alcanzar los puntos objetivo gana</li>
                    </ol>
                    <p><strong>Cartas:</strong></p>
                    <ul style="font-size: 13px;">
                        <li><strong>1-Guardia:</strong> Adivina la carta de un jugador</li>
                        <li><strong>2-Sacerdote:</strong> Mira la carta de un jugador</li>
                        <li><strong>3-Bar√≥n:</strong> Compara cartas, el menor se elimina</li>
                        <li><strong>4-Doncella:</strong> Protecci√≥n hasta tu pr√≥ximo turno</li>
                        <li><strong>5-Pr√≠ncipe:</strong> Un jugador descarta y roba</li>
                        <li><strong>6-Rey:</strong> Intercambia cartas con otro jugador</li>
                        <li><strong>7-Condesa:</strong> Debes jugarla si tienes Rey o Pr√≠ncipe</li>
                        <li><strong>8-Princesa:</strong> Si la descartas, quedas eliminado</li>
                    </ul>
            `,
                timesup: `
                < h3 >‚è±Ô∏è Time's Up - Reglas</h3>
                    < p > <strong>Objetivo:</strong> Adivinar el m√°ximo de palabras posible en 3 rondas distintas</p >
                    <p><strong>3 Rondas con las MISMAS palabras:</strong></p>
                    <ol>
                        <li><strong>Ronda 1 - Descripci√≥n:</strong> Puedes describir con todas las palabras que quieras</li>
                        <li><strong>Ronda 2 - Una palabra:</strong> Solo UNA palabra de pista</li>
                        <li><strong>Ronda 3 - M√≠mica:</strong> Solo gestos y sonidos, sin hablar</li>
                    </ol>
                    <p><strong>Turnos:</strong></p>
                    <ul>
                        <li>30 segundos por jugador</li>
                        <li>El jugador activo ve la palabra y la describe/act√∫a</li>
                        <li>Su equipo adivina (en persona, no en app)</li>
                        <li><strong>Representantes marcan aciertos</strong> con el bot√≥n</li>
                        <li>Si no marcas antes de que acabe el tiempo, se considera fallo</li>
                    </ul>
                    <p>El equipo con m√°s aciertos despu√©s de las 3 rondas gana.</p>
            `,
                overunder: `
                < h3 >üìä Over / Under - Reglas</h3 >
                    <p><strong>Objetivo:</strong> Acertar si la respuesta es mayor o menor.</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Se presenta una pregunta con respuesta num√©rica.</li>
                        <li>Se da un n√∫mero de referencia.</li>
                        <li>Apuesta si la respuesta real es M√ÅS (+) o MENOS (-) que la referencia.</li>
                        <li>Gana puntos por cada acierto.</li>
                    </ol>
            `,
                spyfall: `
                < h3 >üïµÔ∏è Spyfall - Reglas</h3 >
                    <p><strong>Objetivo:</strong></p>
                    <ul>
                        <li><strong>Esp√≠a:</strong> Adivinar la ubicaci√≥n actual.</li>
                        <li><strong>No Esp√≠as:</strong> Descubrir al esp√≠a.</li>
                    </ul>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Todos est√°n en la misma ubicaci√≥n excepto el Esp√≠a.</li>
                        <li>Haced preguntas por turnos ("¬øHace fr√≠o aqu√≠?", "¬øVienes mucho?").</li>
                        <li>No se√°is muy espec√≠ficos (el esp√≠a escucha) ni muy vagos (parecer√©is esp√≠as).</li>
                        <li>El esp√≠a gana si adivina el lugar o si no es descubierto.</li>
                    </ol>
            `,
                conexion: `
                < h3 >üß† Conexi√≥n Mental - Reglas</h3 >
                    <p><strong>Objetivo:</strong> Completar todos los niveles jugando cartas en orden.</p>
                    <p><strong>Regla de ORO:</strong> ü§´ SILENCIO ABSOLUTO. No hablar, no hacer se√±as.</p>
                    <p><strong>C√≥mo jugar:</strong></p>
                    <ol>
                        <li>Ten√©is cartas del 1 al 100.</li>
                        <li>Deb√©is jugarlas en el centro en orden ascendente (1, 5, 12, 40...).</li>
                        <li>No hay turnos. Juega quien crea que tiene la carta m√°s baja.</li>
                        <li>Si alguien juega una carta y t√∫ ten√≠as una menor, perd√©is una vida.</li>
                        <li><strong>Estrella Ninja:</strong> Si todos vot√°is s√≠, cada uno descarta su carta m√°s baja.</li>
                    </ol>
            `
            };

            const rule = rules[gameName] || '<p>Reglas no disponibles</p>';
            const helpContent = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; margin: 20px auto;">
                    ${rule}
            <button onclick="document.getElementById('helpOverlay').style.display='none'"
                style="width: 100%; padding: 15px; margin-top: 20px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">
                Cerrar
            </button>
                </div>
            `;

            let overlay = document.getElementById('helpOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'helpOverlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
                overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
                document.body.appendChild(overlay);
            }
            overlay.innerHTML = helpContent;
            overlay.style.display = 'flex';
        }

        // ============================================
        // TIME'S UP - Generador de palabras
        // ============================================

        function generateTimesUpWords(count) {
            const allWords = [
                // Personas famosas
                'Brad Pitt (actor)', 'Albert Einstein (cient√≠fico)', 'Michael Jackson (cantante)',
                'Marilyn Monroe (actriz)', 'Leonardo DiCaprio (actor)', 'Cleopatra (reina egipcia)',
                'Mozart (compositor)', 'Pablo Picasso (pintor)', 'William Shakespeare (escritor)',
                'Frida Kahlo (pintora)', 'Cristiano Ronaldo (futbolista)', 'Lionel Messi (futbolista)',
                'Michael Jordan (baloncestista)', 'Serena Williams (tenista)', 'Muhammad Ali (boxeador)',
                'Steve Jobs (empresario)', 'Barack Obama (presidente)', 'Nelson Mandela (l√≠der)',

                // Personajes de ficci√≥n
                'Harry Potter (personaje)', 'Batman (superh√©roe)', 'Superman (superh√©roe)',
                'Spider-Man (superh√©roe)', 'James Bond (agente secreto)', 'Sherlock Holmes (detective)',
                'Don Quijote (personaje literario)', 'Romeo y Julieta (obra)', 'Pinocho (personaje)',
                'Cenicienta (cuento)', 'Mickey Mouse (personaje)', 'Buzz Lightyear (personaje)',

                // Monumentos y lugares
                'La Torre Eiffel (monumento)', 'El Big Ben (reloj)', 'La Estatua de la Libertad (monumento)',
                'Las Pir√°mides de Egipto', 'El Coliseo Romano', 'La Gran Muralla China',
                'El Taj Mahal (monumento)', 'La Torre de Pisa (monumento)',

                // Comida
                'Pizza (comida)', 'Sushi (comida)', 'Hamburguesa (comida)', 'Paella (comida)',
                'Tacos (comida)', 'Pasta (comida)', 'Chocolate (comida)', 'Helado (comida)',

                // Marcas y empresas
                'Netflix (plataforma)', 'Facebook (red social)', 'Google (buscador)',
                'Amazon (tienda online)', 'Apple (empresa)', 'Coca-Cola (bebida)',
                'Nike (marca deportiva)', 'McDonald\'s (restaurante)', 'Tesla (coche el√©ctrico)',

                // Pel√≠culas
                'Titanic (pel√≠cula)', 'Star Wars (pel√≠cula)', 'El Padrino (pel√≠cula)',
                'Forrest Gump (pel√≠cula)', 'Matrix (pel√≠cula)', 'El Rey Le√≥n (pel√≠cula)',
                'Jurassic Park (pel√≠cula)', 'E.T. (pel√≠cula)', 'Avatar (pel√≠cula)',

                // Obras de arte
                'La Mona Lisa (cuadro)', 'El Guernica (cuadro)', 'La Noche Estrellada (cuadro)',
                'El Grito (cuadro de Munch)', 'El David (escultura)', 'La √öltima Cena (cuadro)',

                // Ciudades
                'Par√≠s (ciudad)', 'Nueva York (ciudad)', 'Tokio (ciudad)', 'Londres (ciudad)',
                'Roma (ciudad)', 'Barcelona (ciudad)', 'Madrid (ciudad)', 'Berl√≠n (ciudad)',

                // Libros
                'El Quijote (libro)', 'La Biblia (libro)', 'El Principito (libro)',
                'Cien A√±os de Soledad (libro)', '1984 (libro de Orwell)', 'Se√±or de los Anillos (libro)',

                // Animales
                'Perro (animal)', 'Gato (animal)', 'Elefante (animal)', 'Le√≥n (animal)',
                'Delf√≠n (animal)', 'Jirafa (animal)', 'Ping√ºino (animal)', 'Tigre (animal)',

                // Instrumentos musicales
                'Piano (instrumento)', 'Guitarra (instrumento)', 'Viol√≠n (instrumento)',
                'Bater√≠a (instrumento)', 'Trompeta (instrumento)', 'Saxof√≥n (instrumento)',

                // Deportes
                'F√∫tbol (deporte)', 'Baloncesto (deporte)', 'Tenis (deporte)',
                'Golf (deporte)', 'Nataci√≥n (deporte)', 'Boxeo (deporte)'
            ];

            shuffleArray(allWords);
            return allWords.slice(0, count);
        }

        // Inicializaci√≥n
        showHome();
    </script>
</body>

</html>